<!--
Modification ID     By      Date        Comment
--------------------------------------------------------------------------------
export01            Aaron   22Jan2019   add exportXLS function to button export
-->
<%@taglib prefix="jstl" uri="http://java.sun.com/jsp/jstl/core" %>
<jsp:useBean id="DDL" scope="page" class="BusinessLogic.Servlet_PopulateData" />
<style type="text/css">
    .ui-jqgrid tr.jqgrow td {
        word-wrap: break-word; /* IE 5.5+ CSS3 see http://www.w3.org/TR/css3-text/#text-wrap */
        white-space: pre-wrap; /* CSS3 */
        white-space: -moz-pre-wrap; /* Mozilla, since 1999 */
        white-space: -pre-wrap; /* Opera 4-6 */
        white-space: -o-pre-wrap; /* Opera 7 */
        overflow: hidden;
        height: auto;
        vertical-align: middle;
        padding-top: 3px;
        padding-bottom: 3px
    }    
</style>

<link rel="stylesheet" type="text/css" href="css/your_style.css" />
<link rel="stylesheet" type="text/css" href="js/plugin/jqgrid/ui.multiselect.css" />

<section id="widget-grid" class="">
    <input type="hidden" id="lblCompCode" value="<%= session.getAttribute("CompCode")%>"  class="tboxreadonlyShort"/>
    <input type="hidden" id="lblLocCode" value="<%= session.getAttribute("LocCode")%>"  class="tboxreadonlyShort"/>
   
    <div class="col-xs-12 col-sm-7 col-md-7 col-lg-4">
        <h1 class="page-title txt-color-blueDark">
            <!-- PAGE HEADER -->
            <i class="fa-fw fa fa-file fa-2x"></i> 
            Stock Movement Report                                   
        </h1>
    </div>
    <div class="row">
        <form id='form_StkMov_Report'>
        <article class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
            <div class="jarviswidget jarviswidget-color-blueDark" id="wid-id-2"  data-widget-editbutton="false" data-widget-colorbutton="false" data-widget-fullscreenbutton="false" data-widget-custombutton="false" data-widget-deletebutton="false">
                <header>
                    <span class="widget-icon"> <i class="fa fa-search"></i></span>
                    <span><h2>&nbsp;Generate Stock Movement Report</h2></span>
                </header>
                <div class="no-padding">
                    <div class="widget-body">
                        <div id="selectCriTab" class="tab-content">
                            <div class="tab-pane fade active in padding-5 no-padding-bottom" id="selectCriTab_s1">
                                <!--<table id="tblSearch" border="0" cellpadding="0" cellspacing="0" width="80%">-->
                                <table id="tblSearch" class="selection-criteria">
                                     <tr>
                                        <td width="15%">Stock/Product:</td>
                                        <td width="20%">                                            
                                           <label id="selectDateTo" class="searchbox">
                                            <input id="txtPeriodFrom" name="txtPeriodFrom" placeholder="Period Date From" class="searchbox-date" readonly=""/>   
                                            </label>
                                        </td>
                                        <td width="5%">To</td>
                                        <td width="60%">                                            
                                            <label id="selectDateTo" class="searchbox">
                                            <input id="txtPeriodTo" name="txtPeriodTo" placeholder="Period Date To" class="searchbox-date" />   
                                            </label>
                                        </td>                                           
                                    </tr> 
                                    
                                    
                                    <tr>
                                        <td width="15%">Stock/Product:</td>
                                        <td width="20%">                                            
                                           <label id="selectStkFrom" class="searchbox">
                                            <select class="form-control" id="ddlStkFrom" name="ddlStkFrom" rel="popover-hover" data-original-title="Stock/Product" data-content="Select Stock/Product." style="width:400px;">
                                                <option value="">- Select Stock/Product -</option>
                                                <jstl:forEach var="ddl_StkFrom" items="${DDL.ddlGet('GET_STOCK', '', '', sessionScope.SiteName)}">
                                                    <option value="${ddl_StkFrom.VALUE}">${ddl_StkFrom.TEXT}</option>
                                                </jstl:forEach>                                             
                                            </select>    
                                            </label>
                                        </td>
                                        <td width="5%">To</td>
                                        <td width="60%">                                            
                                            <label id="selectStkTo" class="searchbox">
                                            <select class="form-control" id="ddlStkTo" name="ddlStkTo" rel="popover-hover" data-original-title="Stock/Product" data-content="Select Stock/Product." style="width:400px;">
                                                <option value="">- Select Stock/Product -</option>
                                                <jstl:forEach var="ddl_StkTo" items="${DDL.ddlGet('GET_STOCK', '', '', sessionScope.SiteName)}">
                                                    <option value="${ddl_StkTo.VALUE}">${ddl_StkTo.TEXT}</option>
                                                </jstl:forEach>     
                                            </select>    
                                        </label>
                                        </td>                                           
                                    </tr> 
                                    <tr>
                                        <td>Company:</td>
                                        <td>                                            
                                            <label id="selectCompany" class="searchbox">
                                            <select class="form-control" id="ddlComp" name="ddlComp" rel="popover-hover" data-original-title="Company" data-content="Select Company." style="width:250px;">
                                                <option value="">- Select Company -</option>
                                                <jstl:forEach var="ddl_Comp" items="${DDL.ddlGet('GET_COMP', '', '', sessionScope.SiteName)}">
                                                            <option value="${ddl_Comp.VALUE}">${ddl_Comp.VALUE}</option>
                                                </jstl:forEach>     
                                            </select>    
                                            </label>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Location:</td>
                                        <td>                                            
                                            <label id="selectLocation" class="searchbox">
                                            <select class="form-control" id="ddlLoc" name="ddlLoc" rel="popover-hover" data-original-title="Location" data-content="Select Location." style="width:250px;cursor:default;">
                                                <option value="">- Select Location -</option>
                                                 <jstl:forEach var="ddl_Loc" items="${DDL.ddlGet('GET_LOCATION', sessionScope.CompCode, sessionScope.LocCode, sessionScope.SiteName)}">
                                                            <option value="${ddl_Loc.VALUE}">${ddl_Loc.VALUE}</option>
                                                </jstl:forEach>  
                                                            
                                            </select>    
                                            </label>
                                        </td>                                                                          
                                    </tr> 
                                    <tr>    
                                        <th>Product Category</th>
                                        <td colspan="4">
                                            <div id="rdPrdCat">       
                                                <input type="radio" id="rdPrdCat1" name="rdPrdCat"  value="" checked="checked" /><label for="rdPrdCat1" class="label-option btn">All</label>
                                                <input type="radio" id="rdPrdCat2" name="rdPrdCat" value="0"/><label for="rdPrdCat2" class="label-option btn">Drug</label>
                                                <input type="radio" id="rdPrdCat3" name="rdPrdCat" value="1"/><label for="rdPrdCat3" class="label-option btn">Product</label>
                                                <input type="radio" id="rdPrdCat4" name="rdPrdCat" value="2"/><label for="rdPrdCat4" class="label-option btn">Consumable</label>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>        
                                        <th>Product Status</th>
                                        <td colspan="4">
                                            <div id="rdPrdIsActive">       
                                                <input type="radio" id="rdPrdIsActive1" name="rdPrdIsActive"  value="" checked="checked" /><label for="rdPrdIsActive1" class="label-option btn">All</label>
                                                <input type="radio" id="rdPrdIsActive2" name="rdPrdIsActive" value="Y"/><label for="rdPrdIsActive2" class="label-option btn" style="width:200px;">Active Stock Only</label>
                                                <input type="radio" id="rdPrdIsActive3" name="rdPrdIsActive" value="N"/><label for="rdPrdIsActive3" class="label-option btn" style="width:200px;">In-active Stock Only</label>
                                            </div>
                                        </td>
                                    </tr>                                                                 
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>                            
        </article>
        </form>                             
    </div>
    <div class="row" style="padding-left:20px;padding-bottom:20px;">
        <div align="center" class="padding-5" >
            <input type="button" class="btn btn-default bg-color-blueDark txt-color-white" id="btnPrintPrev" name="btnPrintPrev" onclick="LoadPrintPreview();" data-toggle='modal' data-target='#printPreview' value="Print Preview" style="margin-right:20px;"/>
            <input type="button" class="btn btn-default bg-color-blueDark txt-color-white" id="btnExport" name="btnExport" onclick="exportXLS();" value="Export" style="margin-right:20px;"/> <!--export01-->
            <input type="button" class="btn btn-default bg-color-blueDark txt-color-white" id="btnCancel" name="btnCancel" onclick="location.href = '#/dashboard'" value="Cancel" style="margin-right:20px"/>
        </div>
    </div>
</section>
  <jsp:include page="../../../includes/loading-no-status.jsp"/>  
  <jsp:include page="../../../includes/PopUpInitPage.jsp"/>
  <script src="js/buttonset.js"></script>
<script type="text/javascript">
   
    pageSetUp();
    $.get('${pageContext.request.contextPath}/Servlet_PopulateData', {SFC: 'GET_DLL', METHOD: 'GET_COMP', P1: '<%= session.getAttribute("CompCode")%>', P2: ''}, function (data) {
            var arrData = data;
            createOption($("#ddlComp"), arrData, '- Select Company -'); 
            if ($("#lblLocCode").val() === "")
                {
            $("#ddlComp").trigger("change");
        }
        });

    
    function createOption(ddl, arrData, stext) {
        ddl.html('');
        if(arrData.length > 1){
            
        ddl.append($("<option>"). 
        attr("value",'').
        data("sel", 0).
        text(stext));
        }
       
        if(arrData.length > 0){
            for(var i=0; i < arrData.length; i++){
                ddl.append($("<option>"). 
                attr("value",arrData[i].VALUE).
                data("sel", 0).
                text(arrData[i].TEXT));
            }
        }
    }
    
    $('#rdPrdCat').buttonset();
    $('#rdPrdIsActive').buttonset();
    
    $().ready(function(){
        
        loadScript("js/buttonset.js", function () {
            loadScript("js/excel-export.js", function () {
            });
        });
    
    var tempDate = new Date();
        $("#txtPeriodFrom").datepicker({
            numberOfMonths: 2,
            changeMonth: true,
            changeYear: true,
            dateFormat: "yy-mm-dd",
            onSelect: function (selected) {
                $("#txtPeriodTo").datepicker("option", "minDate", selected);
            }
        });
        
        var fromDate = $.datepicker.formatDate('yy-mm-dd', new Date(tempDate.getFullYear(), tempDate.getMonth() - 2, tempDate.getDate()));
        $("#txtPeriodFrom").val(fromDate);
        $("#hdnPoFromDate").val($("#txtPeriodFrom").val());
        $("#txtPeriodTo").datepicker({
            numberOfMonths: 2,
            changeMonth: true,
            changeYear: true,
            dateFormat: "yy-mm-dd",
            onSelect: function (selected) {
                $("#txtPeriodFrom").datepicker("option", "maxDate", selected);
            }
        });
        $("#txtPeriodTo").datepicker("option", "minDate", fromDate);
        $("#txtPeriodTo").val($.datepicker.formatDate('yy-mm-dd', tempDate));
        $("#txtPeriodFrom").datepicker("option", "maxDate", tempDate);
        $("#hdnPoToDate").val($("#txtPeriodTo").val());
        
        
        $("#ddlLoc").prop("disabled", false);    
        
        $("#ddlComp").change(function(){  
            
            $('#ddlLoc').empty();            
            var sCompany = this.value;
            if (sCompany !== "") {                
                $.ajax({
                    type: "GET",
                    url: "${pageContext.request.contextPath}/Servlet_Stock?SFC=GET_REL_LOCATION",
                    data: {
                        COMPANY: sCompany
                    },
                    dataType: 'json',
                    success: function(data) {
                        $("select#ddlLoc").append( $("<option>").val("").html("- Select Location -")); 

                        for (var a=0 ; a<data.object1.length ; a++) {                   
                            var arrData = data.object1[a];                
                            $("select#ddlLoc").append( $("<option>")
                                .val(arrData.VALUE)
                                .html(arrData.VALUE)
                            ); 
                        }
                    }
                });                                                           
                $("#ddlLoc").prop("disabled", false); 
            } else 
                $("select#ddlLoc").append( $("<option>").val("").html("- Select Location -")); 
        });
    });

    function LoadPrintPreview() {
        loadScript("js/print-preview.js", function () {
            var jObj = {              
                1: "GET_MOVEMENT_SUMMARY",
                2: $('#txtPeriodFrom').val(), 
                3: $('#txtPeriodTo').val(), 
                4: $('#ddlStkFrom').val(), //
                5: $('#ddlStkTo').val(), //
                6: $('#ddlComp').val(), //
                7: $('#ddlLoc').val(), //
                8: $('input[name=rdPrdIsActive]:checked').val(),
                9: $('input[name=rdPrdCat]:checked').val(),
                10:"",
                11:"",
                12:"",
                13:""
            }; //list of parameter in SP
 
            //for fix parameter
            var param = {     
                // PO_NO: sPoNo               
            };           
            //alert(JSON.stringify(jObj));               
            var object = {};
            object.procParam = jObj;
            object.jasperName = 'Stk_Movement_Report';
            object.procString = 'SP_GET_STOCK_LEDGER(?,?,?,?,?,?,?,?,?,?,?,?,?)';
            object.fixParam = param;
            object.format = 'pdf'; //indicate format to export
            //alert(JSON.stringify(funcIn));
            printToPage(object);                                           
        });      
    };
        
    //export01
    //Aaron
    function exportXLS(){
        loadScript("js/print-preview.js", function () {
            var jObj = {              
                1: "GET_MOVEMENT_SUMMARY",
                2: $('#txtPeriodFrom').val(), 
                3: $('#txtPeriodTo').val(), 
                4: $('#ddlStkFrom').val(), //
                5: $('#ddlStkTo').val(), //
                6: $('#ddlComp').val(), //
                7: $('#ddlLoc').val(), //
                8: $('input[name=rdPrdIsActive]:checked').val(),
                9: $('input[name=rdPrdCat]:checked').val(),
                10:"",
                11:"",
                12:"",
                13:""
            }; //list of parameter in SP
 
            //for fix parameter
            var param = {     
                // PO_NO: sPoNo               
            };           
            //alert(JSON.stringify(jObj));               
            var object = {};
            object.procParam = jObj;
            object.jasperName = 'Stk_Movement_Report';
            object.procString = 'SP_GET_STOCK_LEDGER(?,?,?,?,?,?,?,?,?,?,?,?,?)';
            object.fixParam = param;
            object.format = 'xlsx'; //indicate format to export
            //alert(JSON.stringify(funcIn));
            printToPage(object);                                           
        });  
    };
//        var periodFrom = $('#txtPeriodFrom').val();
//        var periodTo = $('#txtPeriodTo').val();
//        var stkFrom =  $('#txtStkFrom').val();
//        var stkTo = $('#txtStkTo').val();
//        var sddlComp = $('#ddlComp').val();
//        var sddlLoc = $('#ddlLoc').val();
//       
//        var srdPrdIsActive = $('input[name=rdPrdIsActive]:checked').val();
//        var srdPrdCat = $('input[name=rdPrdCat]:checked').val();
//
//        
//        $.ajax({
//            url: '${pageContext.request.contextPath}/Servlet_Stock?SFC=GET_MOVEMENT',
//            data: {
//                PRDFRM :periodFrom,
//                PRDTO : periodTo,
//                STKFRM: stkFrom,
//                STKTO:  stkTo,
//                COMPANY : sddlComp,
//                LOCATION: sddlLoc,
//                PRDCAT: srdPrdCat,
//                PRDISACT: srdPrdIsActive
//            },
//            type: "GET",
//            dataType: 'json',
//            beforeSend: function () {
//                $.showLoadingNoStatus();
//            },
//            success: function (data, textStatus, jqXHR) {
//                var headerLabel = ['Stock Code', 'Stock Description', 'Company Code', 'Location', 'UOM', 'Stock Balance', 'Stock Value '];
//                // Example: var excludeColumnsName = ['MODIFYDATE', 'MODIFYBY']; 
//                var excludeColumnsName = ['comp_name', 'loc_name','selStkFrom','selStkTo','selComp','selComp','selLoc','selStkCat','selStkIsActive']; ;
//                JSONToCSVConvertor(data.ExportList, "Stock Balance", true, headerLabel, excludeColumnsName, "Stock Balance Export");
//            },
//            error: function (xhr, status, error) {
//                $.bigBoxFail({
//                    title: "Stock Balance ERROR",
//                    content: "There is some error occur during export Stock Balance. Please try again later",
//                    timeout: 6000
//                });
//            },
//            complete: function (xhr, status) {
//                 $.hideLoadingNoStatus(function () {
//                    }, 500);
//            }
//            });
//    }
    function JSONToCSVConvertor(JSONData, ReportTitle, ShowLabel, headers, excludeColumns, fileName) {
        //If JSONData is not an object then JSON.parse will parse the JSON string in an Object
        var arrData = typeof JSONData !== 'object' ? JSON.parse(JSONData) : JSONData;
        var CSV = '';
        //Set Report title in first row or line 
        //CSV += ReportTitle + '\r\n\n';

        //This condition will generate the Label/Header
        if (ShowLabel) {
            var row = "";

            if (headers) {
                row = headers.join(',');
            } else {
                //This loop will extract the label from 1st index of on array
                for (var index in arrData[0]) {
                    //Now convert each value to string and comma-seprated
                    row += index + ',';
                }
            }
            row = row.slice(0, -1);
            //append Label row with line break
            CSV += row + '\r\n';
        }


        //1st loop is to extract each row
        //var rowdata = $('#jqgridError').jqGrid('getRowData').length  + 1;
        var rowdata = arrData.length;//$('#jqgridError').jqGrid('getRowData').length  + 1;
        //for (var i = 1; i < arrData.length; i++) {

        for (var i = 0; i < rowdata; i++) {
            var row = "";
            //2nd loop will extract each column and convert it in string comma-seprated
            for (var colName in arrData[i]) {
                if(excludeColumns && excludeColumns.indexOf(colName) >= 0) //TT-04
                    continue;
                row += '"' + arrData[i][colName] + '",';
            }
            row.slice(0, row.length - 1);
            //add a line break after each row
            CSV += row + '\r\n';
        }

        if (CSV === '') {
            alert("Invalid data");
            return;
        }

        if (!fileName) {
            //Generate a file name
            fileName = "StockBalance_";
            //this will remove the blank-spaces from the title and replace it with an underscore
            fileName += ReportTitle.replace(/ /g, "_");
        }

        if (navigator.appName === "Microsoft Internet Explorer") {
            var oWin = window.open();
            oWin.document.write('sep=,\r\n' + CSV);
            oWin.document.close();
            oWin.document.execCommand('SaveAs', true, fileName + ".csv");
            oWin.close();
        } else {
            //Initialize file format you want csv or xls
            var uri = 'data:text/csv;charset=utf-8,' + escape(CSV);

            // Now the little tricky part.
            // you can use either>> window.open(uri);
            // but this will not work in some browsers
            // or you will not get the correct file extension    

            //this trick will generate a temp <a /> tag
            var link = document.createElement("a");
            //link.href = uri;
            link.id = "lnkDwnldLnk";

            //this part will append the anchor tag and remove it after automatic click
            document.body.appendChild(link);

            var csv = CSV;
            blob = new Blob([csv], {type: 'text/csv'});
            var csvUrl = window.webkitURL.createObjectURL(blob);
            var dfilename = fileName + ".csv";
            $("#lnkDwnldLnk")
                    .attr({
                        'download': dfilename,
                        'href': csvUrl
                    });

            $('#lnkDwnldLnk')[0].click();
            document.body.removeChild(link);

        }
    }

</script>
