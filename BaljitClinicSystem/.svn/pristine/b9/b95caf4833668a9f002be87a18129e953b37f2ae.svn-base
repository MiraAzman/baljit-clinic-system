<%@taglib prefix="jstl" uri="http://java.sun.com/jsp/jstl/core" %>
<jsp:useBean id="DDL" scope="page" class="BusinessLogic.Servlet_PopulateData" />
<jsp:useBean id="DDLXfer" scope="page" class="BusinessLogic.Servlet_Transfer" />
<style type="text/css">
    .ui-jqgrid tr.jqgrow td {
        word-wrap: break-word; /* IE 5.5+ CSS3 see http://www.w3.org/TR/css3-text/#text-wrap */
        white-space: pre-wrap; /* CSS3 */
        white-space: -moz-pre-wrap; /* Mozilla, since 1999 */
        white-space: -pre-wrap; /* Opera 4-6 */
        white-space: -o-pre-wrap; /* Opera 7 */
        overflow: hidden;
        height: auto;
        vertical-align: middle;
        padding-top: 3px;
        padding-bottom: 3px
    }   
    div.errorContainer, div.errorContainer2{
        display:none;
        width:100%;
    }
    div.errorContainer, div.errorContainer2 ol li{
        list-style-type:disc;
        margin-left: 20px;
    }
    li{
        list-style:none;
    }
    input[type="text"].error { border: 1px solid #A94444; background-color:#FFF0F0; }
    select.error { border: 1px solid #A94444; background-color:#FFF0F0; }
    textarea.error { border: 1px solid #A94444; background-color:#FFF0F0; }
    .textbox-date{
        background: url("../img/calander.png") right no-repeat;
        background-size: 28px 28px;
        background-color: white;
        border: 1px solid #999; 
        outline:0; 
        padding-right: 20px;
        min-width: 80px;
        cursor: pointer;
    }
</style>

<link rel="stylesheet" type="text/css" href="css/your_style.css" />
<link rel="stylesheet" type="text/css" href="js/plugin/jqgrid/ui.multiselect.css" />

<section id="widget-grid" class="">
    <!--<input type="text" id="lblUserCode" value="<%= session.getAttribute("s_usercode")%>"  class="tboxreadonlyShort"/>-->
    <div class="col-xs-12 col-sm-7 col-md-7 col-lg-4">
        <h1 class="page-title txt-color-blueDark">
            <!-- PAGE HEADER -->
            <i class="fa-fw fa fa-file fa-2x"></i> 
            New Stock Adjustment
            <input type="hidden" id="ControlDateTime" value="DT" />
        </h1>
    </div>
    <div class="row">
        <form id='form_AdjAdd'>
        <article class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
            <div class="row" style="padding-bottom:10px;padding-left:10px;padding-right:10px;">
                <div class="errorContainer alert alert-danger alert-block">
                    <h4 class="alert-heading">There were some field left out or invalid inputs. Please brief through the form and reenter necessarily.</h4>
                    <ol>
                    </ol>
                </div>
            </div>
            <div class="jarviswidget jarviswidget-color-blueDark" id="wid-id-2"  data-widget-editbutton="false" data-widget-colorbutton="false" data-widget-fullscreenbutton="false" data-widget-custombutton="false" data-widget-deletebutton="false">
                <header>
                    <span class="widget-icon"> <i class="fa fa-search"></i></span>
                    <span><h2>&nbsp;Locate Product</h2></span>
                </header>
                <div class="no-padding">
                    <div class="widget-body">
                        <div id="selectCriTab" class="tab-content">
                            <div class="tab-pane fade active in padding-5 no-padding-bottom" id="selectCriTab_s1">
                                <table id="tblSearch" class="selection-criteria">
                                    <tr>
                                        <td width="15%">Company:<font color="red" size="3">*</font></td>
                                        <td width="30%">                                                                                             
                                            <label id="selectCompany" class="searchbox">
                                            <select class="form-control" id="ddlComp" name="ddlComp" rel="popover-hover" data-original-title="Company" data-content="Select Company." style="width:250px;">
                                                <option value="">- Select Company -</option>
                                                <jstl:forEach var="ddl_Comp" items="${DDL.ddlGet('GET_COMP','','', sessionScope.SiteName)}">
                                                    <option value="${ddl_Comp.VALUE}">${ddl_Comp.VALUE} - ${ddl_Comp.TEXT}</option>
                                                </jstl:forEach>     
                                            </select>    
                                            </label>
                                        </td>
                                        <td width="10%">Location:<font color="red" size="3">*</font></td>
                                        <td width="30%">                                            
                                            <label id="selectLocation" class="searchbox">
                                            <select class="form-control" id="ddlLoc" name="ddlLoc" rel="popover-hover" data-original-title="Location" data-content="Select Location." style="width:250px;cursor:default;">
                                                <option value="">- Select Location -</option>
                                            </select>    
                                            </label>
                                        </td>                                                                          
                                    </tr> 
                                    <tr>
                                        <td>Product Code:</td>
                                        <td>   
                                            <div style="float:left;">
                                                <input type="text" id="txtPrdCode" name="txtPrdCode"  placeholder="--Enter Product Code--" class="searchbox-text" style="width:200px;"/>
                                            </div>
                                            <div style="float:left;padding-left:2px">
                                                <button class='btn btn-default bg-color-blueDark txt-color-white' type="button" onclick="ProductLookup();" ><i class="fa fa-search fa-lg"></i></button>
                                            </div>
                                        </td>
                                        <td>Product Group:</td>
                                        <td>                                            
                                            <label id="selectPrdGrp" class="searchbox">
                                            <select class="form-control" id="ddlPrdGrp" name="ddlPrdGrp" rel="popover-hover" data-original-title="Product Group" data-content="Select Product Group." style="width:250px;">
                                                <option value="">- Select Product Group -</option>    
                                                <jstl:forEach var="ddl_PrdGrp" items="${DDL.ddlGet('GET_CODEDESC', 'STKGRP', '', sessionScope.SiteName)}">
                                                    <option value="${ddl_PrdGrp.VALUE}">${ddl_PrdGrp.TEXT}</option>
                                                </jstl:forEach>                                             
                                            </select>    
                                            </label>
                                        </td>
                                    </tr>                                     
                                    <tr>
                                        <td>Product Description:</td>
                                        <td>                                            
                                            <input type="text" id="txtPrdDesc" name="txtPrdDesc"  placeholder="--Enter Product Description--" class="searchbox-text" style="width:250px;"/>
                                        </td>
                                        <td>Product Type:</td>
                                        <td>                                            
                                            <label id="selectPrdType" class="searchbox">
                                            <select class="form-control" id="ddlPrdType" name="ddlPrdType" rel="popover-hover" data-original-title="Product Type" data-content="Select Product Type." style="width:250px;">
                                                <option value="">- Select Product Type -</option>
                                                <jstl:forEach var="ddl_PrdType" items="${DDL.ddlGet('GET_CODEDESC', 'STKTYP', '', sessionScope.SiteName)}">
                                                    <option value="${ddl_PrdType.VALUE}">${ddl_PrdType.TEXT}</option>
                                                </jstl:forEach>                       
                                            </select>    
                                            </label>
                                        </td>                                     
                                    </tr>                                     
                                    <tr>
                                        <td colspan="6">
                                            <div id="rdPrdCat" class="ui-buttonset">       
                                                <input type="radio" id="rdPrdCat1" name="rdPrdCat"  value="" checked="checked" /><label for="rdPrdCat1" class="label-option btn">All</label>
                                                <input type="radio" id="rdPrdCat2" name="rdPrdCat" value="0"/><label for="rdPrdCat2" class="label-option btn">Medication</label>
                                                <input type="radio" id="rdPrdCat3" name="rdPrdCat" value="1"/><label for="rdPrdCat3" class="label-option btn">Product</label>
                                                <input type="radio" id="rdPrdCat4" name="rdPrdCat" value="2"/><label for="rdPrdCat4" class="label-option btn">Consumable</label>
                                            </div>
                                            <script>
                                                loadScript("js/buttonset.js", function () {
                                                    $('#rdPrdCat').buttonset();
                                                });
                                            </script>
                                        </td>
                                        <td colspan="1">
                                            <div style="align:left; float:left;padding-right: 10px" >
                                                <input type="submit" Id="btnSearch"  class="btn btn-default bg-color-blueDark txt-color-white"  value="Retrieve" onclick="Retrieve_Prd_CostQty_List();" />
                                            </div>                                            
                                            <div style="align:left; float:left; padding-right: 10px" >
                                                <input type="submit" Id="btnClear"  class="btn btn-default bg-color-blueDark txt-color-white"  value="Clear" onclick="ResetSearchFields();" />
                                            </div>                                        
                                        </td>                                    
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
                                                           
            <div class="jarviswidget jarviswidget-color-blueDark" id="wid-id-1"  data-widget-editbutton="false" data-widget-custombutton="false" data-widget-deletebutton="false">              
                <header>
                    <span class="widget-icon"> <i class="fa fa-file"></i></span>
                    <span><h2>&nbsp;Product List</h2></span>
                </header>                
                <div>
                    <div style="padding-bottom:10px;">                                                                              
                        <input type="button" Id="btnAddProduct" onclick="AddProduct();" class="btn btn-default bg-color-blueDark txt-color-white" value="Add Product" />                       
                    </div>
                    <!-- widget edit box -->
                    <div class="jarviswidget-editbox">
                        <!-- This area used as dropdown edit box -->                        
                    </div>
                    <!-- end widget edit box -->

                    <!-- widget content -->
                    <div class="widget-body">                                
                        <div class="table-responsive">
                            <div id="cjqgridPrdList"></div>
                            <table id="jqgridPrdList" class="table table-striped table-bordered"  ></table>
                            <div id="pjqgridPrdList"></div>
                        </div>

                        <br>
                        <div class="jarviswidget jarviswidget-color-blueDark" id="wid-id-1" data-widget-editbutton="false" data-widget-deletebutton="false" data-widget-colorbutton="false" data-widget-fullscreenbutton="false" data-widget-togglebutton="false">
                            <header>
                                <h2>Selected Product</h2>
                            </header>
                            <div class="container">
                                <div class="row">
                                    <div id="cjqgridSubmitDetail" class="jqgrid-table-nopadding">
                                        <table id="jqgridSubmitDetail" class="table table-striped" ></table>
                                        <!-- <div id="sourceDetail" style="padding-bottom:10px;padding-left:10px;">                                                                              
                                            <input type="button" Id="btnAddSelected" onclick="AddSelectedItems();" class="btn btn-default bg-color-blueDark txt-color-white" value="Add Selected Items" />                                                                                                                                                                                               
                                        </div> -->
                                        <div class="table-responsive">                                        
                                            <div id="gridItemSummary" class="">                              
                                                <table class="table table-striped" id="tbItem" >
                                                    <thead>                                                                                                          
                                                        <th id="lblRemove"> </th>  
                                                        <th id="lblPrdCode">Product</th>
                                                        <th id="lblPrdCat">Category</th>
                                                        <th id="lblPrdGrp">Group</th>
                                                        <th id="lblPrdType">Type</th>
                                                        <th id="lblBatchNo">Batch#</th>
                                                        <th id="lblExpiryDate">Expiry Date</th>
                                                        <th id="lblUnitCost">Unit Cost</th>
                                                        <th id="lblUOMCode">UOM</th>
                                                        <th id="lblQty">Qty</th>
                                                        <th id="lblActualQty">Actual Qty</th>              
                                                        <th id="lblVariance">Variance</th>  
                                                        <th id="defaultrow"></th> 
                                                        <th id="idx"></th>  
                                                    </thead>
                                                    <tbody id="ItemGrid" >
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div>
                                                <div class="row">
                                                    <div class="col-sm-12">
                                                        <!-- <div align="left" class="padding-5" >                                          
                                                            <input type="button" Id="btnDeleteAll"  class="btn btn-default bg-color-blueDark txt-color-white" value="Delete All" style=" width: 80px;" onclick='DeleteAllRows()' />                                          
                                                        </div> -->                                 
                                                        <div align="Center" class="padding-10">                                           
                                                            <input type="button" Id="btnConfirm"  class="btn btn-default bg-color-blueDark txt-color-white" value="Confirm" style=" width:80px;padding-right:10px" onclick="confirm();" />
                                                            <input type="button" Id="btnCancel"  class="btn btn-default bg-color-blueDark txt-color-white" value="Cancel" style=" width:80px;" onclick="location.href = '#/StockAdjustmentList'" />
                                                        </div>                                      
                                                    </div>
                                                </div> 
                                            </div>    
                                        </div>
                                    </div>
                                </div>                               
                            </div>
                        </div>                                 
                        <div style=" display: none;">
                            <table id="ExportPrdMaster" class="table table-striped table-bordered" ></table>
                        </div>
                    </div>
                    <!-- end widget content -->
                </div>
            </div>                  
        </article>                                                
        <div hidden>            
            <input type="hidden" id="hidAdjItems" name="hidAdjItems"/>
        </div>
        </form>                             
    </div>
</section>                                                   
<jsp:include page="../../../includes/loading-no-status.jsp"/>  
<jsp:include page="../../../includes/PopUpInitPage.jsp"/>
<jsp:include page="../../../includes/yes-no.jsp"/>
<script src="js/buttonset.js"></script>
<script type="text/javascript">
   
   var CurrentStkCode = "";
   var CurrentCompCode = "";
   var CurrentConvUOM = "";
   var CurrLocationLst = {};
   var CurrentAllocation = {};
   var LocationFirstTimeRefreshed = false;
   var CurrLocationGrid = {};
   var TotalAllocation = 0;
   
    pageSetUp();
    $('#rdPrdCat').buttonset();
    
    $().ready(function(){
                 
        $("#ddlLoc").prop("disabled", true);
        $("#wid-id-1").hide();
        
        var container = $('div.errorContainer');
        var validator = $("#form_AdjAdd").validate({
            rules: { 
                ddlComp: "required",
                ddlLoc: "required" 
            },
            messages: { 
                ddlComp: "Company & Location must be selected.",
                ddlLoc: "Location must be selected."
            },
            onclick: false,
            onfocusout: false,
            errorContainer: container,
            errorLabelContainer: $("ol", container),
            wrapper: 'li'
        });
    });
    
    $("#ddlComp").change(function(){
        $('#ddlLoc').empty();         
        var sCompany = this.value;    
        if (sCompany !== "") { 
            $.ajax({
                type: "POST", //GET -->  /Servlet_Stock?SFC=GET_REL_LOCATION",
                url: "${pageContext.request.contextPath}/Servlet_StockAdjustment?SFC=GET_REL_LOCATION_WSM", 
                data: {
                    COMPANY: sCompany
                },
                dataType: 'json',
                success: function(data) { 
                    $("select#ddlLoc").append( $("<option>").val("").html("- Select Location -"));  
                    for (var a=0 ; a<data.object1.length ; a++) {                   
                        var arrData = data.object1[a];                
                        $("select#ddlLoc").append( $("<option>")
                            .val(arrData.VALUE)
                            .html(arrData.VALUE + " - " + arrData.TEXT)
                        ); 
                    }
                }
            });                                                           
            $("#ddlLoc").prop("disabled", false);
        } else {
            $("select#ddlLoc").append( $("<option>").val("").html("- Select Location -"));
            $("#ddlLoc").prop("disabled", true);
        }
    });

    var pagefunction = function () {       
        loadScript("js/plugin/jqgrid/ui.multiselect.js", function () {
            loadScript("js/plugin/jqgrid/grid.locale-en.min.js", function () {
                loadScript("js/plugin/jqgrid/jquery.jqGrid.min.js", function () {
                    loadScript("js/column-chooser.js", function () {
                        run_jqgrid_function();
                        getCurrDateTime();
                    });
                });
            });
        });

    function getCurrDateTime()
    {    
        $.get('${pageContext.request.contextPath}/Servlet_SystemEnvironmentSettings', {SFC: 'GET_CURRENTDATETIME'}, function (data) {
            var arrData = String(data);
//          alert(data);
            $("#ControlDateTime").val(arrData);            
        });
    };

        function run_jqgrid_function() {
            
            var grid = $("#jqgridPrdList"),
                gridPager = "#p" + grid.selector.toString().substring(1),
                conDiv = $("#c" + grid.selector.toString().substring(1)),
                defaultColName =  [' ','Product Code','Product','Category','Group','Type','Batch#','Expiry Date','Unit Cost','UOM','Qty','CostQtyIdx','StkIdx'],
                defaultColMol = [                   
                    {name: '', index: '', formatter: selectCurrentRow, sortable: false, width: 60, align:'center', must:true, hidedlg:true},
                    {name:'StkCode', index:'StkCode', sortable:true, must:true, hidedlg:true, width:100},
                    {name:'StkDesc', index:'StkDesc', sortable:true, width:220},
                    {name:'StkCat', index:'StkCat', sortable:true, width:90},
                    {name:'StkGrp', index:'StkGrp', sortable:true, width:80},
                    {name:'StkType', index:'StkType', sortable:true, width:80},
                    {name:'BatchNo', index:'BatchNo', sortable:true, width:80},
                    {name:'ExpiryDate', index:'ExpiryDate', sortable:true, width:80},
                    {name:'UnitCost', index:'UnitCost', sortable:true, width:60},
                    {name:'UOMCode', index:'UOMCode', sortable:true, width:70},
                    {name:'Qty', index:'Qty', sortable:true, must:true, hidedlg:true, width:60},
                    {name:'Idx', index:'Idx', hidden:true},
                    {name:'StkIdx', index:'StkIdx', hidden:true}
                ],             
                mainGridName = grid.selector.toString().substring(1),
                //temp = readSettings({settingArray:${sessionScope.settings}, defaultColName: defaultColName, defaultColMol: defaultColMol, settingName: mainGridName});//,
                temp = readSettings({settingArray:"admin", defaultColName: defaultColName, defaultColMol: defaultColMol, settingName: mainGridName}),
                currentColName = temp[0],
                currentColMol = temp[1];
                // alert(JSON.stringify(temp));
            grid.jqGrid({
                url: '${pageContext.request.contextPath}/Servlet_StockAdjustment',
                postData: {
                    SFC: 'GET_PRD_COSTQTY_LIST',     
                    COMPANY: $('#ddlComp').val(),
                    LOCATION: $('#ddlLoc').val(),
                    PRDCODE: $('#txtPrdCode').val(),
                    PRDGRP: $('#ddlPrdGrp').val(),
                    PRDTYPE: $('#ddlPrdType').val(),
                    PRDCAT: $('input[name=rdPrdCat]:checked').val()                     
                },
                datatype: "json",
                mtype: 'POST',
                colNames: currentColName,
                colModel: currentColMol,
                gridview: true,
                rownumWidth: 40,
                rowNum: 20,
                rowList: [10, 20, 25, 30, 50, 100],
                pager: gridPager,
                sortname: '',
                viewrecords: true,
                sortorder: '',
                toolbarfilter: true,
                autowidth: true,
                shrinkToFit: true,
                loadonce: false,
                height: 'auto',
                scrollerbar: false,  
                rownumbers: true,
                celledit: true,
                //multiselect:true,
                async: true,
                sortable: {
                    update: function (relativeColumnOrder) {
                        //sortColumn({settingArray:${sessionScope.settings}, order: relativeColumnOrder, grid: grid, defaultColMol: defaultColMol, settingName: mainGridName});
                        sortColumn({settingArray:"admin", order: relativeColumnOrder, grid: grid, defaultColMol: defaultColMol, settingName: mainGridName});
                    }
                },
                loadComplete: function () {
                    var iLastPage = parseInt($(this).getGridParam('lastpage'));
                    $(".ui-jqgrid .ui-pg-input").keydown(function (e) {
                        this.value = this.value.replace(/\D/g, '');
                        var code = e.keyCode || e.which;
                        if (code === 13) {
                            if (this.value > iLastPage) {
                                this.value = iLastPage;
                            } else if (this.value <= 0) {
                                this.value = 1;
                            }
                        }
                    });
                }
            });        
            function selectCurrentRow(cellvalue, options, rowObject) {               
                return "<input type='button' id='btnSelRow' name='btnSelRow' style='cursor:pointer; width:50px; height:20px;' value='Select' title='Select' onclick='SelectRow(\"" + options.rowId + "\")'/>";  
            }
            // remove classes
            $(".ui-jqgrid").removeClass("ui-widget ui-widget-content");
            $(".ui-jqgrid-view").children().removeClass("ui-widget-header ui-state-default");
            $(".ui-jqgrid-labels, .ui-search-toolbar").children().removeClass("ui-state-default ui-th-column ui-th-ltr");
            $(".ui-jqgrid-pager").removeClass("ui-state-default");
            $(".ui-jqgrid").removeClass("ui-widget-content");
            // add classes
            $(".ui-jqgrid-htable").addClass("table table-bordered table-hover");
            $(".ui-jqgrid-btable").addClass("table table-bordered table-striped");
            $(".ui-pg-div").removeClass().addClass("btn btn-sm btn-primary");
            $(".ui-icon.ui-icon-plus").removeClass().addClass("fa fa-plus");
            $(".ui-icon.ui-icon-pencil").removeClass().addClass("fa fa-pencil");
            $(".ui-icon.ui-icon-trash").removeClass().addClass("fa fa-trash-o");
            $(".ui-icon.ui-icon-search").removeClass().addClass("fa fa-search");
            $(".ui-icon.ui-icon-refresh").removeClass().addClass("fa fa-refresh");
            $(".ui-icon.ui-icon-disk").removeClass().addClass("fa fa-save").parent(".btn-primary").removeClass("btn-primary").addClass("btn-success");
            $(".ui-icon.ui-icon-cancel").removeClass().addClass("fa fa-times").parent(".btn-primary").removeClass("btn-primary").addClass("btn-danger");
            $(".ui-icon.ui-icon-seek-prev").wrap("<div class='btn btn-sm btn-default'></div>");
            $(".ui-icon.ui-icon-seek-prev").removeClass().addClass("fa fa-backward");
            $(".ui-icon.ui-icon-seek-first").wrap("<div class='btn btn-sm btn-default'></div>");
            $(".ui-icon.ui-icon-seek-first").removeClass().addClass("fa fa-fast-backward");
            $(".ui-icon.ui-icon-seek-next").wrap("<div class='btn btn-sm btn-default'></div>");
            $(".ui-icon.ui-icon-seek-next").removeClass().addClass("fa fa-forward");
            $(".ui-icon.ui-icon-seek-end").wrap("<div class='btn btn-sm btn-default'></div>");
            $(".ui-icon.ui-icon-seek-end").removeClass().addClass("fa fa-fast-forward");
            $(".ui-pg-input").addClass("pg-input");

            // resize
            $(window).on('resize', function () {
                grid.jqGrid('setGridWidth', conDiv.width());
            });
            grid.on('myRefresh', function () {
                resizeWidth({grid: grid, gridDiv: conDiv});
            });
            // quickSetupChooser({grid: grid, defaultColMol: defaultColMol, settingName: mainGridName,
            // settingArray:${sessionScope.settings},
            quickSetupChooser({grid: grid, defaultColMol: defaultColMol, settingName: mainGridName,
                settingArray:"admin",
                done: function () {
                    resizeWidth({grid: grid, gridDiv: conDiv});
                }
            });
            grid.jqGrid('setGridWidth', conDiv.width());                
        };
        
    }; //end of pagefunction

    function ResetSearchFields() { 
        $('#txtPrdCode').val('');
        $('#txtPrdDesc').val('');
        $('#ddlPrdGrp').val('');
        $('#ddlPrdType').val('');  
    }
    
    function Retrieve_Prd_CostQty_List() {
        var $validItem = $("#form_AdjAdd").valid();
        if ($validItem === true) { 
            $("#wid-id-1").show();
            $("#wid-id-4").show();
            $("#jqgridPrdList").jqGrid('setGridParam', {
                postData: {
                    SFC: 'GET_PRD_COSTQTY_LIST',     
                    COMPANY: $('#ddlComp').val(),
                    LOCATION: $('#ddlLoc').val(),
                    PRDCODE: $('#txtPrdCode').val(),
                    PRDGRP: $('#ddlPrdGrp').val(),
                    PRDTYPE: $('#ddlPrdType').val(),
                    PRDCAT: $('input[name=rdPrdCat]:checked').val()
                }
            }).trigger("reloadGrid", [{page: 1}]);
        }
    }
  
    loadScript("js/plugin/jqgrid/grid.locale-en.min.js", function () {
        loadScript("js/buttonset.js", function () {
            loadScript("js/excel-export.js", function () {            
                pagefunction();
            });
        });
    });
    pageSetUp();
    
    function ProductLookup() {      
        showProduct({width: 800, height: 600}).done(function (rowIn) {
            //alert(JSON.stringify(rowIn));
            $("#txtPrdDesc").val(rowIn.stk_desc);
            $("#txtPrdCode").val(rowIn.stk_stockcode);
        });
    }
   
    function AddProduct() {      
        showProduct({width: 800, height: 600}).done(function (rowIn) {

            //alert(JSON.stringify(rowIn));           
            $("#tbItem tbody").append("<tr id=tr" + curRow + ">" +               
                "<td><a style='cursor:pointer;' onclick='showRemovePopup("+curRow+")'><i class='fa fa-fw fa-lg fa-trash-o'/></a></td>" +
                "<td><input type='text' class='form-control' readonly ID='txtStkCode" + curRow + "' name='txtStkCode" + curRow + "' style='width:120px' /></td>" +               
                "<td><input type='text' class='form-control' readonly ID='txtStkCat" + curRow + "' name='txtStkCat" + curRow + "' style='width:100px' /></td>" +
                "<td><input type='text' class='form-control' readonly ID='txtStkGrp" + curRow + "' name='txtStkGrp" + curRow + "' style='width:80px' /></td>" +
                "<td><input type='text' class='form-control' readonly ID='txtStkType" + curRow + "' name='txtStkType" + curRow + "' style='width:80px' /></td>" +
                "<td><input type='text' class='form-control' ID='txtBatchNo" + curRow + "' name='txtBatchNo" + curRow + "' style='width:80px' /></td>" +
                "<td><input type='text' class='form-control textbox-date' ID='txtExpiryDate" + curRow + "' name='txtExpiryDate" + curRow + "' style='width:105px' /></td>" + 
                "<td><input type='text' class='form-control' ID='txtUnitCost" + curRow + "' name='txtUnitCost" + curRow + "' style='width:80px' value='0.00' /></td>" +               
                "<td><select class='form-control' ID='txtUOMCode" + curRow + "' name='txtUOMCode" + curRow + "' style='width:80px;'><option value=''></option></select></td>" +   
                "<td><input type='text' class='form-control' readonly ID='txtQty" + curRow + "' name='txtQty" + curRow + "' style='width:80px' value='0.00' /></td>" +
                "<td><input type='text' class='form-control' ID='txtActualQty" + curRow + "' name='txtActualQty" + curRow + "' style='width:80px' value='0.00' /></td>" +
                "<td><input type='text' class='form-control' readonly ID='txtVariance" + curRow + "' name='txtVariance" + curRow + "' style='width:70px' value='0' /></td>" +              
                "<td><input type='hidden' class='form-control' ID='hidDefaultRow" + curRow + "' name='hidDefaultRow" + curRow + "' /></td>" +  
                "<td><input type='hidden' class='form-control'ID='hidIdx" + curRow + "' name='hidIdx' value='' /></td>" +    
                "<td><input type='hidden' class='form-control'ID='hidStkIdx" + curRow + "' name='hidStkIdx' /></td>" +
                "</tr>"
            );                
            
            $("#hidDefaultRow"+ curRow).val('N');
            $("#hidStkIdx"+ curRow).val(rowIn.stk_stockidx); 
            $("#txtStkCode"+ curRow).val(rowIn.stk_stockcode);
            $("#txtStkCat"+ curRow).val(rowIn.stk_consumable);
            $("#txtStkGrp"+ curRow).val(rowIn.stk_groupcode);
            $("#txtStkType"+ curRow).val(rowIn.stk_typecode);   
            $("#txtExpiryDate"+ curRow).datepicker({
                numberOfMonths: 2,
                changeMonth: true,
                changeYear: true,
                dateFormat: "yy-mm-dd"
            });
            
            $("#txtActualQty"+curRow).keyup(function(){                             
                var actQty = $(this).val();
                $("#txtQty"+this.id.substring(12)).val(actQty);
            });
            
            curRow = curRow + 1; 

            $.ajax({
                type: "POST", 
                url: "${pageContext.request.contextPath}/Servlet_StockAdjustment?SFC=GET_REL_STOCKUOM",  
                data: { STKCODE: rowIn.stk_stockcode },
                dataType: 'json',
                success: function(data) { 
                    var tempCurRow = curRow - 1;  
                    for (var a=0 ; a<data.object1.length ; a++) {                   
                        var arrData = data.object1[a]; 
                        $("#tbItem #txtUOMCode"+tempCurRow).append( $("<option>")
                            .val(arrData.VALUE)
                            .html(arrData.TEXT)
                        ); 
                    }            
                }
            });
        });
    }
    
    var curRow = 0;
    function SelectRow(ids) { 

        var grid = $('#jqgridPrdList');       
        var Idx = grid.jqGrid('getCell', ids, 'Idx');
        var StkIdx = grid.jqGrid('getCell', ids, 'StkIdx');       
        var StkCode = grid.jqGrid('getCell', ids, 'StkCode');
        var StkCat = grid.jqGrid('getCell', ids, 'StkCat');
        var StkGrp = grid.jqGrid('getCell', ids, 'StkGrp');
        var StkType = grid.jqGrid('getCell', ids, 'StkType');
        var BatchNo = grid.jqGrid('getCell', ids, 'BatchNo');
        var ExpiryDate = grid.jqGrid('getCell', ids, 'ExpiryDate');
        var UnitCost = grid.jqGrid('getCell', ids, 'UnitCost');
        var UOM = grid.jqGrid('getCell', ids, 'UOMCode');
        var Qty = grid.jqGrid('getCell', ids, 'Qty');
       
        if ($("input[name='hidIdx']","#tbItem").val() === Idx) 
        {               
            $.bigBoxWarning({
                title: "Item Selection.",
                content: "Some items have already been selected previously.",
                timeout: 3000
            });
        } 
        else 
        {             
            $("#tbItem tbody").append("<tr id=tr" + curRow + ">" +                                                 
                "<td><a style='cursor:pointer;' onclick='showRemovePopup("+curRow+")'><i class='fa fa-fw fa-lg fa-trash-o'/></a></td>" +
                "<td><input type='text' class='form-control' readonly ID='txtStkCode" + curRow + "' name='txtStkCode" + curRow + "' style='width:120px' /></td>" +             
                "<td><input type='text' class='form-control' readonly ID='txtStkCat" + curRow + "' name='txtStkCat" + curRow + "' style='width:100px' /></td>" +
                "<td><input type='text' class='form-control' readonly ID='txtStkGrp" + curRow + "' name='txtStkGrp" + curRow + "' style='width:80px' /></td>" +
                "<td><input type='text' class='form-control' readonly ID='txtStkType" + curRow + "' name='txtStkType" + curRow + "' style='width:80px' /></td>" +
                "<td><input type='text' class='form-control' readonly ID='txtBatchNo" + curRow + "' name='txtBatchNo" + curRow + "' style='width:80px' /></td>" +
                "<td><input type='text' class='form-control' readonly ID='txtExpiryDate" + curRow + "' name='txtExpiryDate" + curRow + "' style='width:105px' /></td>" +
                "<td><input type='text' class='form-control' readonly ID='txtUnitCost" + curRow + "' name='txtUnitCost" + curRow + "' style='width:80px' /></td>" +               
                "<td><input type='text' class='form-control' readonly ID='txtUOMCode" + curRow + "' name='txtUOMCode" + curRow + "' style='width:80px' value='' /></td>" +
                "<td><input type='text' class='form-control' readonly ID='txtQty" + curRow + "' name='txtQty" + curRow + "' style='width:80px' /></td>" +
                "<td><input type='text' class='form-control' ID='txtActualQty" + curRow + "' name='txtActualQty" + curRow + "' style='width:80px' /></td>" +
                "<td><input type='text' class='form-control' readonly ID='txtVariance" + curRow + "' name='txtVariance" + curRow + "' style='width:70px' /></td>" +
                "<td><input type='hidden' class='form-control'ID='hidDefaultRow" + curRow + "' name='hidDefaultRow' /></td>" + 
                "<td><input type='hidden' class='form-control'ID='hidIdx" + curRow + "' name='hidIdx' /></td>" + 
                "<td><input type='hidden' class='form-control'ID='hidStkIdx" + curRow + "' name='hidStkIdx' /></td>" + 
                "</tr>"
            );        
            $("#hidIdx"+ curRow).val(Idx);
            $("#hidStkIdx"+ curRow).val(StkIdx);
            $("#hidDefaultRow"+ curRow).val('Y');
            $("#txtStkCode"+ curRow).val(StkCode);
            $("#txtStkCat"+ curRow).val(StkCat);
            $("#txtStkGrp"+ curRow).val(StkGrp);
            $("#txtStkType"+ curRow).val(StkType);
            $("#txtBatchNo"+ curRow).val(BatchNo);
            $("#txtExpiryDate"+ curRow).val(ExpiryDate);
            $("#txtUnitCost"+ curRow).val(UnitCost);
            $("#txtUOMCode"+ curRow).val(UOM);
            $("#txtQty"+ curRow).val(Qty);
            $("#txtActualQty"+ curRow).val(Qty);
            RecalcVariance(curRow);
            
            $("#txtActualQty"+curRow).keyup(function(){
                RecalcVariance(this.id.substring(12));
            });

            curRow = curRow + 1; 
        }            
    }

    function showRemovePopup(rowId)
    {
        showYesNo({
            title: "Are you sure to remove the particular item?",
            width: 520,
            _HtmlBody:
                "<table class='selection-criteria' style='width:100%' >" +
                "<tr><td align='center'>" +
                "<button style='width:180px' class='btn btn-default bg-color-blueDark txt-color-white' onclick='DeleteRow("+rowId+")';>Yes</button>" +
                "</td><td align='center'>" +
                "<input type='button' Id='btnCloseDelete' class='btn btn-default bg-color-blueDark txt-color-white' value='No' style=' width: 180px;' data-dismiss='modal' />" +
                "</td>" +
                "</tr>" +
                "</table>",
            Yes: false,
            No: false
        });  
    }
    function confirm()
    {
        var $this = $(this);
        var bValidate = true;
        var rowCount = $('#tbItem tr').length; 
        if (rowCount === 1) {
            $this.find("a").removeAttr("disabled"); 
            $.bigBoxWarning({
                title: "Stock Adjustment.",
                content: "Please select item for Adjustment.<br> Please try again...",
                timeout: 3000
            });
            return;
        }      
        
        $('#tbItem tr').each(function (row, th) {           
            if (row > 0) {                
                var rowid = $(this).closest('tr').attr('id');
                var rowno = rowid.substring(2);
                var ActualQty = $('#txtActualQty' + rowno).val();  
                var Variance = $('#txtVariance' + rowno).val();  
                if (ActualQty === '') {
                    bValidate = false;
                    $.bigBoxWarning({
                        title: "Stock Adjustment.",
                        content: "Quantity must be entered.<br> Please try again...",
                        timeout: 3000
                    });
                    return;
                } else if (Variance === 'NaN') {
                    bValidate = false;
                    $.bigBoxWarning({
                        title: "Stock Adjustment.",
                        content: "Quantity entered is invalid.<br> Please try again...",
                        timeout: 3000
                    });
                    return;
                }
                
                if ($('#txtUOMCode' + rowno).val() === '' || $('#txtUOMCode' + rowno).val() === null
                        || $('#txtUOMCode' + rowno).val() === undefined)
                {
                     bValidate = false;
                    $.bigBoxWarning({
                        title: "Stock Adjustment.",
                        content: "UOM not selected...",
                        timeout: 3000
                    });
                    return;
                }
            }
        });
         document.getElementById("btnConfirm").disabled = true;
         if (bValidate) {
                  showYesNo({
                    title: "Stock Adjustment...",
                    width: 420,
                    noClose: true,
                    isModal: true,
                    body: [
                        "<br><h4>Are you sure to proceed Stock Adjustment?<h4><br>"
                    ],
                    show: function () {
                    },
                    Yes: {
                         text: "Yes",
                        opt: function () {           
                            adjustStock();
                            hideYesNo();
                        }
                    },
                    No: {
                        text: "No",
                        opt: function () {
                            document.getElementById("btnConfirm").disabled = false;
                            hideYesNo();
                        }
                    }
                });
        }else {
            $.bigBox({
                title: "Warning!",
                content: "Please select Quantity or UOM before proceeed to save!!",
                color: "#C46A69",
                //timeout: 6000,
                icon: "fa fa-warning shake animated",
                timeout: 6000
            });
            document.getElementById("btnConfirm").disabled = false;
        }
    }
        
    function adjustStock()
    {
         var $this = $(this);
            var AdjItem = new Array();
            var rowAdjItem = 0;
            $('#tbItem tr').each(function (row, th) {                
                if (row > 0) {                
                    var rowid = $(this).closest('tr').attr('id');
                    var rowno = rowid.substring(2);
if ($('#hidDefaultRow' + rowno).val() === "N")
{
    $('#txtVariance' + rowno).val($('#txtQty' + rowno).val());
}

                    AdjItem[rowAdjItem] = {
                        "STKCODE": $('#txtStkCode' + rowno).val(),
                        "BATCHNO": $('#txtBatchNo' + rowno).val(),                   
                        "EXPIRYDATE": $('#txtExpiryDate' + rowno).val(),
                        "UNITCOST": $('#txtUnitCost' + rowno).val(),
                        "UOMCODE": $('#txtUOMCode' + rowno).val(),                          
                        "QTY": $('#txtQty' + rowno).val(),
                        "ACTUALQTY": $('#txtActualQty' + rowno).val(),
                        "VARIANCE": $('#txtVariance' + rowno).val(),
                        "DEFAULTROW": $('#hidDefaultRow' + rowno).val(),      
                        "STKIDX": $('#hidStkIdx' + rowno).val(),
                        "CONTROL_DATETIME":  $('#ControlDateTime').val()
                    };
                    rowAdjItem = rowAdjItem + 1;
                }
            });           
            var ItemToSend = JSON.stringify(AdjItem);
        
            $('#hidAdjItems').load().val(ItemToSend).valid();

        $this.off('click');
        $.ajax({
                type: "POST",
                url: "${pageContext.request.contextPath}/Servlet_StockAdjustment?SFC=CREATE_STOCK_ADJUSTMENT",
                data: {
                    ITEMS: $('#hidAdjItems').val(),
                    COMPANY: $('#ddlComp').val(),
                    LOCATION: $('#ddlLoc').val(),
                    ADJHDRIDX: '0',
                    CONTROL_DATETIME: $('#ControlDateTime').val()
                },
            dataType: 'json',
            beforeSend: function (xhr) {
                $.showLoadingNoStatus();
            },
            success: function (response, status, xhr) {
                if (response.bool === true) {
                    //generate_remittance_advice($("#hidPayIndex").val());      //TT-01 s
                    $.bigBoxSuccess({
                        title: "Success.",
                        content: "Stock Adjustment Updated Successfully.",
                        timeout: 6000
                    });
                   // $('#btnCancel').trigger('click');
                } else {
                    $.bigBoxFail({
                        title: "Stock Adjustment FAIL.",
                        content: "There is some error during Stock Adjustment creation.<br> Please try again...",
                        timeout: 6000
                    });
                }
            },
            error: function (xhr, status, error) {
                $.bigBoxFail({
                    title: "Transaction ERROR",
                    content: "There is some error occur during data transfer. Please try again later",
                    timeout: 6000
            });
            },
            complete: function (xhr, status) {
                if (xhr.status === 200) {
                    $.hideLoadingNoStatus(function () {
                       window.location.href = "#/StockAdjustmentList";
                    }, 500);
                } else {
                    $.hideLoadingNoStatus(function () {
                    }, 0);
                }
        }
    }); 
    }
    
    function DeleteRow(rowId)
    {
        $('table#tbItem tr#tr' + rowId).remove();
        hideYesNo(true);
    }

    
    function RecalcVariance(rowId) {
        var qty = $("#txtQty"+rowId).val();
        var actualQty = $("#txtActualQty"+rowId).val();
        $("#txtVariance"+ rowId).val(actualQty-qty); 
    }

   

</script>
