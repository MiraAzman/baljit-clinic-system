<%@taglib prefix="jstl" uri="http://java.sun.com/jsp/jstl/core" %>
<jsp:useBean id="DDL" scope="page" class="BusinessLogic.Servlet_PopulateData" />
<style type="text/css">
    .ui-jqgrid tr.jqgrow td {
        word-wrap: break-word; /* IE 5.5+ CSS3 see http://www.w3.org/TR/css3-text/#text-wrap */
        white-space: pre-wrap; /* CSS3 */
        white-space: -moz-pre-wrap; /* Mozilla, since 1999 */
        white-space: -pre-wrap; /* Opera 4-6 */
        white-space: -o-pre-wrap; /* Opera 7 */
        overflow: hidden;
        height: auto;
        vertical-align: middle;
        padding-top: 3px;
        padding-bottom: 3px
    }    
    div.errorContainer, div.errorContainer2{
        display:none;
        width:100%;
    }
    div.errorContainer, div.errorContainer2 ol li{
        list-style-type:disc;
        margin-left: 20px;
    }
    li{
        list-style:none;
    }
    input[type="text"].error { border: 1px solid #A94444; background-color:#FFF0F0; }
    select.error { border: 1px solid #A94444; background-color:#FFF0F0; }
    textarea.error { border: 1px solid #A94444; background-color:#FFF0F0; }
</style>

<link rel="stylesheet" type="text/css" href="css/your_style.css" />
<link rel="stylesheet" type="text/css" href="js/plugin/jqgrid/ui.multiselect.css" />
<section id="widget-grid" class="">
    <!--<input type="text" id="lblUserCode" value="<%= session.getAttribute("s_usercode")%>"  class="tboxreadonlyShort"/>-->
    <div class="col-xs-12 col-sm-7 col-md-7 col-lg-4">
        <h1 class="page-title txt-color-blueDark">
            <!-- PAGE HEADER -->
            <i class="fa-fw fa fa-file fa-2x"></i> 
            Top Active Stock Report                                   
        </h1>
    </div>
    <div class="row">
        <form id='form_TopActiveStk_Rpt'>
        <article class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
            <div class="row" style="padding-bottom:10px;padding-left:10px;padding-right:10px;">
                <div class="errorContainer alert alert-danger alert-block">
                    <h4 class="alert-heading">There were some field left out or invalid inputs. Please brief through the form and reenter necessarily.</h4>
                    <ol>
                    </ol>
                </div>
            </div>
            <div class="jarviswidget jarviswidget-color-blueDark" id="wid-id-2"  data-widget-editbutton="false" data-widget-colorbutton="false" data-widget-fullscreenbutton="false" data-widget-custombutton="false" data-widget-deletebutton="false">
                <header>
                    <span class="widget-icon"> <i class="fa fa-search"></i></span>
                    <span><h2>&nbsp;Generate Top Active Stock Report</h2></span>
                </header>
                <div class="no-padding">
                    <div class="widget-body">
                        <div id="selectCriTab" class="tab-content">
                            <div class="tab-pane fade active in padding-5 no-padding-bottom" id="selectCriTab_s1">
                                <table id="tblSearch" class="selection-criteria">                                  
                                    <tr>
                                        <td width="15%">Date:</td>
                                        <td width="25%"><input id="txtDateFrom" name="txtDateFrom" placeholder="Enter Start Date" class="searchbox-date" style="width:250px"/></td>
                                        <td width="5%" align="center">To</td>
                                        <td width="55%"><input id="txtDateTo" name="txtDateTo" placeholder="Enter End Date" class="searchbox-date" style="width:250px"/></td>
                                    </tr>                                     
                                    <tr>
                                        <td>Company:</td>
                                        <td>                                            
                                            <div class="side-by-side clearfix">
                                                <div>
                                                <select data-placeholder="Select Company" class="select ddl-group" multiple tabindex="3" id="ddlComp" name="ddlComp">
                                                    <option value="SelectAll">- Select All -</option>
                                                    <jstl:forEach var="ddl_Comp" items="${DDL.ddlGet('GET_COMP','','', sessionScope.SiteName)}">
                                                        <option value="${ddl_Comp.VALUE}">${ddl_Comp.VALUE}</option>
                                                    </jstl:forEach>    
                                                </select>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Location:</td>
                                        <td>                                            
                                            <div class="side-by-side clearfix">
                                                <div>
                                                <select data-placeholder="Select Location" class="select ddl-group" multiple tabindex="3" id="ddlLoc" name="ddlLoc">
                                                    <option value="SelectAll">- Select All -</option>
                                                    <jstl:forEach var="ddl_Loc" items="${DDL.ddlGet('GET_LOCATION','','', sessionScope.SiteName)}">
                                                        <option value="${ddl_Loc.VALUE}">${ddl_Loc.TEXT}</option>
                                                    </jstl:forEach>    
                                                </select>
                                                </div>
                                            </div>
                                        </td>                                                                          
                                    </tr> 
                                    <tr>
                                        <td>Product:</td>
                                        <td>                                             
                                            <div style="float:left">
                                                <input type="text" id="txtStkFrom" name="txtStkFrom" placeholder="Enter Product Code" class="searchbox-text" style="width:215px;"/>
                                            </div>
                                            <div style="float:left;padding-left:2px">
                                                <button class='btn btn-default bg-color-blueDark txt-color-white' type="button" onclick="StkLookup('Stock','From');" ><i class="fa fa-search fa-lg"></i></button>
                                            </div>
                                        </td>
                                        <td align="center">To</td>
                                        <td>                                             
                                            <div style="float:left">
                                                <input type="text" id="txtStkTo" name="txtStkTo" placeholder="Enter Product Code" class="searchbox-text" style="width:215px;"/>
                                            </div>
                                            <div style="float:left;padding-left:2px">
                                                <button class='btn btn-default bg-color-blueDark txt-color-white' type="button" onclick="StkLookup('Stock','To');" ><i class="fa fa-search fa-lg"></i></button>
                                            </div>
                                        </td>
                                    </tr>  
                                    <tr>
                                        <td>Display By:</td>
                                        <td>                                            
                                            <label class="searchbox">
                                            <select class="form-control" id="ddlDisplayBy" name="ddlDisplayBy" style="width:250px;">                                               
                                            </select>    
                                            </label>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>                            
        </article>
        </form>                             
    </div>   
    
    <div class="row" style="padding-left:20px;padding-bottom:20px;">
        <div align="center" class="padding-5" >
            <input type="button" class="btn btn-default bg-color-blueDark txt-color-white" id="btnPrintPreview" name="btnPrintPreview" data-toggle='modal' data-target='#printPreview' value="Print Preview" style="margin-right:20px;"/>
            <input type="button" class="btn btn-default bg-color-blueDark txt-color-white" id="btnCancel" name="btnCancel" onclick="location.href = '#/dashboard'" value="Cancel"/>
        </div>
    </div>
</section>
<jsp:include page="../../../includes/loading-no-status.jsp"/>  
<jsp:include page="../../../includes/PopUpInitPage.jsp"/>
<script src="js/buttonset.js"></script>
<script src="js/chosen.jquery.js"></script>
<script type="text/javascript">
   
    pageSetUp();
    $('#rdPrdCat').buttonset();
    $('#ddlComp, #ddlLoc').chosen();
    
    function StkLookup(lookupType, ToFrom) {
        if (lookupType === 'Stock') {
            showProduct({width: 800, height: 600}).done(function (rowIn) {
                //alert(JSON.stringify(rowIn));
                $("#txtStk"+ToFrom).val(rowIn.stk_stockcode);
            });
        }    
    }
    
    $.validator.setDefaults({ ignore: ":hidden:not(select)" });
    $().ready(function(){             
        
        var container = $('div.errorContainer');
        $("#form_TopActiveStk_Rpt").validate({
            rules: {   
                ddlComp: "required"
            },
            messages: { 
                ddlComp: "Company or Location must be selected."
            },
            onclick: false,
            onfocusout: false,
            errorContainer: container,
            errorLabelContainer: $("ol", container),
            wrapper: 'li'
        });
        
        $("#btnPrintPreview").click(function(){              
            var $validItem = $("#form_TopActiveStk_Rpt").valid();
            if ($validItem === true) { 
                LoadPrintPreview();
            }
        });

        loadScript("js/buttonset.js", function () {
            loadScript("js/excel-export.js", function () {
            });
        });
     
        $("#ddlLoc").prop("disabled", true).trigger("chosen:updated");
        
        $("#ddlComp").change(function(){
            
            updateList("ddlComp");            
            $('#ddlLoc').empty().trigger("chosen:updated");    
            
            if ($("#ddlComp").val() !== null) {
                
                $("select#ddlLoc").append( $("<option>").val("SelectAll").html("- Select All -")).trigger("chosen:updated");
                
                var sCompany = $("#ddlComp").val();  
                for (var i=0 ; i<sCompany.length ; i++) {
                    $.ajax({
                        type: "GET",
                        url: "${pageContext.request.contextPath}/Servlet_Stock?SFC=GET_REL_LOCATION",
                        data: {
                            COMPANY: sCompany[i]
                        },
                        dataType: 'json',
                        success: function(data) {                             
                            for (var a=0 ; a<data.object1.length ; a++) {                   
                                var arrData = data.object1[a];                
                                $("select#ddlLoc").append( $("<option>")
                                    .val(arrData.VALUE)
                                    .html(arrData.VALUE)
                                ).trigger("chosen:updated"); 
                            }
                        }                   
                    });          
                }
                $("#ddlLoc").prop("disabled", false).trigger("chosen:updated");          
            } else {
                $("#ddlLoc").prop("disabled", true).trigger("chosen:updated");
            }
        });
        
        $("#ddlLoc").change(function(){           
            updateList("ddlLoc");                      
        });
        
        var tempDate = new Date();
        $("#txtDateFrom").datepicker({
            numberOfMonths: 2,
            changeMonth: true,
            changeYear: true,
            dateFormat: "yy-mm-dd",
            onSelect: function (selected) {
                $("#txtDateTo").datepicker("option", "minDate", selected);
            }
        });
        var fromDate = $.datepicker.formatDate('yy-mm-dd', new Date(tempDate.getFullYear(), tempDate.getMonth() - 4, tempDate.getDate()));
        //$("#txtDateFrom").val(fromDate);
        $("#txtDateTo").datepicker({
            numberOfMonths: 2,
            changeMonth: true,
            changeYear: true,
            dateFormat: "yy-mm-dd",
            onSelect: function (selected) {
                $("#txtDateFrom").datepicker("option", "maxDate", selected);
            }
        });
        $("#txtDateTo").datepicker("option", "minDate", fromDate);
        $("#txtDateFrom").datepicker("option", "maxDate", tempDate);
        
        var selected = "";
        for (var i=1;i<=10;i++){
            if (i === 10) {
                selected = "selected";
            }
           $('#ddlDisplayBy').append("<option value='"+i+"' "+selected+">Top "+i+"</option>");
        }
    });

    function updateList(ddl) {
        if ($('#' + ddl).val() !== null) {
            
            var val = $('#' + ddl).val().toString();
            if (val.includes("SelectAll")) { 
                $('#' + ddl + ' option').prop('selected', true).trigger('chosen:updated');       

                var opt = document.getElementById(ddl).options; 
                for(var i = 0; i < opt.length; i++) {
                    if (opt[i].value === "SelectAll") {
                        opt[i].text = "- Deselect All -";
                        opt[i].value = "DeselectAll";
                        opt[i].selected = false;
                    }
                }
                $('#' + ddl).trigger('chosen:updated');

            } else if (val.includes("DeselectAll")) { 

                var opt = document.getElementById(ddl).options; 
                for(var i = 0; i < opt.length; i++) {
                    if (opt[i].value === "DeselectAll") {
                        opt[i].text = "- Select All -";
                        opt[i].value = "SelectAll";
                    }
                }
                $('#' + ddl).val('').trigger("chosen:updated"); 
            }
        } else {
            var opt = document.getElementById(ddl).options[0]; 
            opt.value = "SelectAll";
            opt.text = "- Select All -";
            $('#' + ddl).val('').trigger("chosen:updated"); 
        }
    }

    function LoadPrintPreview() {
        
        var sCompany = "", sLocation = "", sGrpByLocation = "N", jasperFile = "Chart_TopStk_ByCompany";
        if ($('#ddlLoc').val() !== null) {
            sLocation = $('#ddlLoc').val().toString();
            sGrpByLocation = "Y";
            jasperFile = "Chart_TopStk_ByLocation";
        } else if (($('#ddlComp').val() !== null)) {
            sCompany = $('#ddlComp').val().toString();
        }
        
        loadScript("js/print-preview.js", function () {       
            var jObj = {              
                1: "GET_TOP_X", 
                2: $('#txtDateFrom').val(), 
                3: $('#txtDateTo').val(),
                4: $('#txtStkFrom').val(),
                5: $('#txtStkTo').val(), 
                6: sCompany,
                7: sLocation,
                8: sGrpByLocation, 
                9: "TRANSACTED",
                10: $('#ddlDisplayBy').val()
            }; 

            var param = {};           
            //alert(JSON.stringify(jObj));               
            var object = {};
            object.procParam = jObj;
            object.jasperName = jasperFile; 
            object.procString = 'SP_GET_TOPSTOCK(?,?,?,?,?,?,?,?,?,?)'; //10 param
            object.fixParam = param;
            
            printToPage(object);                                           
        });           
    };
</script>
