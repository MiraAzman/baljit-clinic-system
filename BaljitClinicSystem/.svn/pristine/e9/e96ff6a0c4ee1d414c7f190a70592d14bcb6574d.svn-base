<%@taglib prefix="jstl" uri="http://java.sun.com/jsp/jstl/core" %>
<jsp:useBean id="DDL" scope="page" class="BusinessLogic.Servlet_PopulateData" />
<jsp:useBean id="DDLXfer" scope="page" class="BusinessLogic.Servlet_Transfer" />
<style type="text/css">
    .ui-jqgrid tr.jqgrow td {
        word-wrap: break-word; /* IE 5.5+ CSS3 see http://www.w3.org/TR/css3-text/#text-wrap */
        white-space: pre-wrap; /* CSS3 */
        white-space: -moz-pre-wrap; /* Mozilla, since 1999 */
        white-space: -pre-wrap; /* Opera 4-6 */
        white-space: -o-pre-wrap; /* Opera 7 */
        overflow: hidden;
        height: auto;
        vertical-align: middle;
        padding-top: 3px;
        padding-bottom: 3px
    }    
</style>

<link rel="stylesheet" type="text/css" href="css/your_style.css" />
<link rel="stylesheet" type="text/css" href="js/plugin/jqgrid/ui.multiselect.css" />

<section id="widget-grid" class="">
    <!--<input type="text" id="lblUserCode" value="<%= session.getAttribute("s_usercode")%>"  class="tboxreadonlyShort"/>-->
    <div class="col-xs-12 col-sm-7 col-md-7 col-lg-4">
        <h1 class="page-title txt-color-blueDark">
            <!-- PAGE HEADER -->
            <i class="fa-fw fa fa-file fa-2x"></i> 
            New Stock Dispatch
            <input type="hidden" id="ControlDateTime" value="DT" />
        </h1>
    </div>
    <div class="row">
        <form id='from_DespAdd'>
        <article class="col-xs-12 col-sm-12 col-md-12 col-lg-12">

            <div class="jarviswidget jarviswidget-color-blueDark" id="wid-id-2"  data-widget-editbutton="false" data-widget-colorbutton="false" data-widget-fullscreenbutton="false" data-widget-custombutton="false" data-widget-deletebutton="false">
                <header>
                    <span class="widget-icon"> <i class="fa fa-search"></i></span>
                    <span><h2>&nbsp;Locate Product</h2></span>
                </header>
                <div class="no-padding">
                    <div class="widget-body">
                        <div id="selectCriTab" class="tab-content">
                            <div class="tab-pane fade active in padding-5 no-padding-bottom" id="selectCriTab_s1">
                                <!--<table id="tblSearch" border="0" cellpadding="0" cellspacing="0" width="80%">-->
                                <table id="tblSearch" class="selection-criteria">
                                    <tr>
                                        <td width="15%">Product Code:</td>
                                        <td width="20%">   
                                           </div>
                                            <div style="float:left;padding-left:10px">
                                            <input type="text" id="txtPrdCode" name="txtPrdCode"  placeholder="--Enter Product Code--" class="searchbox-text" />
                                            </div>
                                            <div style="float:left;padding-left:10px">
                                            <button class='btn btn-default bg-color-blueDark txt-color-white' type="button" onclick="ProductLookup();" ><i class="fa fa-search fa-lg"></i></button>
                                            </div>
                                        </td>
                                        <td width="15%">Product Group:</td>
                                        <td width="20%">                                            
                                            <label id="selectPrdGrpFrom" class="searchbox">
                                            <select class="form-control" id="ddlPrdGrpFrom" name="ddlPrdGrpFrom" rel="popover-hover" data-original-title="Product Group" data-content="Select Product Group." style="width:250px;">
                                                <option value="">- Select Product Group -</option>
                                               
                                                
                                                            
                                                      <jstl:forEach var="ddl_PrdGrpFrom" items="${DDL.ddlGet('GET_CODEDESC', 'STKGRP', '', sessionScope.SiteName)}">
                                                            <option value="${ddl_PrdGrpFrom.VALUE}">${ddl_PrdGrpFrom.TEXT}</option>
                                                       </jstl:forEach>                                             
                                            </select>    
                                        </label>
                                        </td>
<!--                                         <td width="5%">To</td>
                                        <td width="20%">                                            
                                            <label id="selectPrdGrpTo" class="searchbox">
                                            <select class="form-control" id="ddlPrdGrpTo" name="ddlPrdGrpTo" rel="popover-hover" data-original-title="Product Group" data-content="Select Product Group." style="width:250px;">
                                                <option value="">- Select Product Group -</option>
                                                <jstl:forEach var="ddl_PrdGrpTo" items="${DDL.ddlGet('GET_CODEDESC', 'STKGRP', '', sessionScope.SiteName)}">
                                                            <option value="${ddl_PrdGrpTo.VALUE}">${ddl_PrdGrpTo.TEXT}</option>
                                                </jstl:forEach>     
                                            </select>    
                                        </label>
                                        </td>-->
                                        
                                    </tr> 
                                    
                                    <tr>
                                        <td width="15%">Product Description</td>
                                        <td width="20%">                                            
                                            <input type="text" id="txtPrdDesc" name="txtPrdDesc"  placeholder="--Enter Product Description--" class="searchbox-text" />
                                        </td>
                                        <td width="15%">Product Type:</td>
                                        <td width="20%">                                            
                                            <label id="selectPrdTypeFrom" class="searchbox">
                                            <select class="form-control" id="ddlPrdTypeFrom" name="ddlPrdTypeFrom" rel="popover-hover" data-original-title="Product Type" data-content="Select Product Type." style="width:250px;">
                                                <option value="">- Select Product Type -</option>
                                                 <jstl:forEach var="ddl_PrdTypeFrom" items="${DDL.ddlGet('GET_CODEDESC', 'STKTYP', '', sessionScope.SiteName)}">
                                                            <option value="${ddl_PrdTypeFrom.VALUE}">${ddl_PrdTypeFrom.TEXT}</option>
                                                </jstl:forEach>               
                                            </select>    
                                        </label>
                                        </td>
<!--                                         <td width="5%">To</td>
                                        <td width="20%">                                            
                                            <label id="selectPrdTypeTo" class="searchbox">
                                            <select class="form-control" id="ddlPrdTypeTo" name="ddlPrdTypeTo" rel="popover-hover" data-original-title="Product Type" data-content="Select Type Group." style="width:250px;">
                                                <option value="">- Select Product Type -</option>
                                                <jstl:forEach var="ddl_PrdTypeTo" items="${DDL.ddlGet('GET_CODEDESC', 'STKTYP', '', sessionScope.SiteName)}">
                                                            <option value="${ddl_PrdTypeTo.VALUE}">${ddl_PrdTypeTo.TEXT}</option>
                                                </jstl:forEach>  
                                            </select>    
                                        </label>
                                        </td>-->
                                        
                                    </tr> 
                                    
                                    <tr>
                                        <td width="15%">Date:</td>
                                        <td width="20%"><input id="txtDocDateFrom" name="txtDocDateFrom" placeholder="Document Date" class="searchbox-date"/></td>
                                        <td width="15%">To:</td>
                                        <td width="20%"><input id="txtDocDateTo" name="txtDocDateTo" placeholder="Document Date" class="searchbox-date"/></td>
                                    </tr>  
                                    <tr>
                                        <td width="15%">Receive Location:</td>
                                        <td width="20%">                                            
                                            <label id="selectReceiveLocation" class="searchbox">
                                            <select class="form-control" id="ddlReceiveLocation" name="ddlReceiveLocation" rel="popover-hover" data-original-title="Receive Location" data-content="Select Receive Location.">
                                                <option value="">- Select Receive Location -</option>
                                                 <jstl:forEach var="ddl_ReceiveLocation" items="${DDL.ddlGet('GET_LOCATION', '', '', sessionScope.SiteName)}">
                                                            <option value="${ddl_ReceiveLocation.VALUE}">${ddl_ReceiveLocation.TEXT}</option>
                                                </jstl:forEach>               
                                            </select>    
                                        </label>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td colspan="6">
                                            <div id="rdPrdCat" class="ui-buttonset">       
                                                <input type="radio" id="rdPrdCat1" name="rdPrdCat"  value="" checked="checked" /><label for="rdPrdCat1" class="label-option btn">All</label>
                                                <input type="radio" id="rdPrdCat2" name="rdPrdCat" value="0"/><label for="rdPrdCat2" class="label-option btn">Medication</label>
                                                <input type="radio" id="rdPrdCat3" name="rdPrdCat" value="1"/><label for="rdPrdCat3" class="label-option btn">Product</label>
                                                <input type="radio" id="rdPrdCat4" name="rdPrdCat" value="2"/><label for="rdPrdCat4" class="label-option btn">Consumable</label>
                                            </div>
                                            <script>
                                                loadScript("js/buttonset.js", function () {
                                                    $('#rdPrdCat').buttonset();
                                                });
                                            </script>
                                        </td>
 
                                         <td colspan="1">
                                              <div style="align:left; float:left;padding-right: 10px" >
                                                <input type="submit" Id="btnSearch"  class="btn btn-default bg-color-blueDark txt-color-white"  value="Retrieve Pending Dispatch Items" onclick="Search();" />
                                            </div>
                                             
                                             <div style="align:left; float:left; padding-right: 10px" >
                                                <input type="submit" Id="btnClear"  class="btn btn-default bg-color-blueDark txt-color-white"  value="Clear" onclick="ResetSearchFields();" />
                                            </div>
                                             
<!--                                             <div style="align:left; float:left;" >
                                                 <input type="submit" Id="btnGetPendingDespatch"  class="btn btn-default bg-color-blueDark txt-color-white"  value="Retrieve Pending Despatch Only..." onclick="RetrievePendingDespatch();" />
                                            </div>-->
                                         </td>                                    
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
                                                           
            <div class="jarviswidget jarviswidget-color-blueDark" id="wid-id-1"  data-widget-editbutton="false" data-widget-custombutton="false" data-widget-deletebutton="false">
               
                <header>
                    <span class="widget-icon"> <i class="fa fa-file"></i></span>
                    <h2>Dispatch Item(s)</h2>
                </header>  
                <div>

                    <!-- widget edit box -->
                    <div class="jarviswidget-editbox">
                        <!-- This area used as dropdown edit box -->
                         
                    </div>
                    <!-- end widget edit box -->

                    <!-- widget content -->
                    <div class="widget-body">
<!--                        <input type="button" href="#myModal" data-toggle="modal" value="Print Reports" class="btn btn-default bg-color-blueDark txt-color-white" />&nbsp;
                        <input type="button" id="btnMemExport" name="btnCorpExport" onclick='ExportData()' value="Export"  class="btn btn-default bg-color-blueDark txt-color-white"  style="margin-right:20px;"/>-->
                                 
                        <div class="table-responsive">
                            <div id="cjqgridPrdList"></div>
                            <table id="jqgridPrdList" class="table table-striped table-bordered"  ></table>
                            <div id="pjqgridPrdList"></div>
                        </div>

<!-- DESPATCH DETAILS -->
<br>
                    <div class="jarviswidget jarviswidget-color-blueDark" id="wid-id-1" data-widget-editbutton="false" data-widget-deletebutton="false" data-widget-colorbutton="false" data-widget-fullscreenbutton="false" data-widget-togglebutton="false">
                        <header>
                            <h2>Dispatch Details</h2>
                        </header>
                        <div class="container">

                            <div class="row">
                                <div id="cjqgridSubmitDetail" class="jqgrid-table-nopadding">
                                    <table id="jqgridSubmitDetail" class="table table-striped" ></table>
                                    <div id="sourceDetail">
                                        
                                        
                                        <input type="button" Id="btnAddSelected" onclick="OnItemsSelected();"  class="btn btn-default bg-color-blueDark txt-color-white" value="Add Selected Items" />
                                        
                                        <table id="tblSource" class="selection-criteria">
                                             
                                    <tr>
                                        <td >Dispatch Person ID:</td>
                                        <td >   
                                           
                                        <input type='text' class='form-control' ID='txtDespatchPersonID' name='txtDespatchPersonID' style='width:200px'   />                                         
                                              
                                        </td>
                                        <td>Dispatch Person Name:</td>
                                        <td >                                            
                                             <div style="float:left;padding-left:10px">
                                              <input type='text' class='form-control' ID='txtDespatchPersonName' name='txtDespatchPersonName' style='width:200px'   />        
                                             
                                            </div>
                                        </td>
                                       
                                         <td>Remarks:</td>
                                        <td >                                            
                                             <div style="float:left;padding-left:10px">
                                              <input type='text' class='form-control' ID='txtRemarks' name='txtRemarks' style='width:200px'   />        
                                             
                                            </div>
                                        </td>
                                    </tr> 
                                     
                                </table>
                                        
                                       
                                        
                                        
                                    </div>
                                     <div class="table-responsive">
                                         
                                         <div id="gridPoItemSummary" class="">
                                

                                <table  class="table table-striped" id="tbPoItem" >
                                    <thead>
                                    <th id="idx"> </th> 
                                    <th id="lblDelete">Remove</th>                                            
                                    <th id="lblDocDate">Date</th>                                        
                                    <th id="lblCompany">Company</th>
                                    <th id="lblIssLocation">Issue Location</th>
                                    <th id="lblRecLocation">Recieve Location</th>
                                    <th id="lblProduct">Product</th>
                                    <th id="lblQty">Qty</th>
                                    <th id="lblUOM">UOM</th>
                                    <th id="lblDespatchQTY">Dispatch Qty</th>
                                    
                                    </thead>
                                    <tbody id="PoItemGrid" >

                                    </tbody>
                                </table>

                            </div>
                            <div>
                                <div class="row">
                                    <div class="col-sm-12">
                                        <div align="left" class="padding-5" >
                                            
                                            <input type="button" Id="btnDeleteAll"  class="btn btn-default bg-color-blueDark txt-color-white" value="Delete All" style=" width: 80px;" onclick='DeleteAllRows()'/>
                                            

                                        </div>
                                        
                                        <div align="Right" class="padding-5" >
                                            
                                            <input type="button" Id="btnSave"  class="btn btn-default bg-color-blueDark txt-color-white" value="Confirm" style=" width: 80px;" onclick="confirm();" />
                                            <input type="button" Id="btnClose"  class="btn btn-default bg-color-blueDark txt-color-white" value="Close" style=" width: 80px;" onclick="location.href = '#/StockDespatchList'"  />

                                        </div>
                                        
                                    </div>
                                </div>
                            </div>    

                        </div>
                                </div>
                            </div>
                        </div>
                    </div>
           

<!-- DESPATCH DETAILS -->
                        <div style=" display: none;">
                                <table id="ExportPrdMaster" class="table table-striped table-bordered"   ></table>
                            </div>
                    </div>
                    <!-- end widget content -->
                </div>
            </div>
                                                
                                                
                                                

        </article>
                                                
        <div hidden>
            
            <input type="hidden" id="hidDespItems" name="hidDespItems"/>
        </div>
          </form>                             
    </div>
</section>
                                                      
  <jsp:include page="../../../includes/loading-no-status.jsp"/>  
  <jsp:include page="../../../includes/PopUpInitPage.jsp"/>
  <jsp:include page="../../../includes/yes-no.jsp"/>
  <script src="js/buttonset.js"></script>
<script type="text/javascript">
   
   var CurrentStkCode = "";
   var CurrentCompCode = "";
   var CurrentConvUOM = "";
   var CurrLocationLst = {};
   var CurrentAllocation = {};
   var LocationFirstTimeRefreshed = false;
   var CurrLocationGrid = {};
   var TotalAllocation = 0;
    pageSetUp();
    
    $().ready(function(){
        
        
        
        var tempDate = new Date();
        $("#txtDocDateFrom").datepicker({
            numberOfMonths: 2,
            changeMonth: true,
            changeYear: true,
            dateFormat: "yy-mm-dd",
            onSelect: function (selected) {
                $("#txtDocDateTo").datepicker("option", "minDate", selected);
            }
        });
        var fromDate = $.datepicker.formatDate('yy-mm-dd', new Date(tempDate.getFullYear(), tempDate.getMonth() - 4, tempDate.getDate()));
        //$("#txtDocDateFrom").val(fromDate);
        $("#txtDocDateTo").datepicker({
            numberOfMonths: 2,
            changeMonth: true,
            changeYear: true,
            dateFormat: "yy-mm-dd",
            onSelect: function (selected) {
                $("#txtDocDateFrom").datepicker("option", "maxDate", selected);
            }
        });
        $("#txtDocDateTo").datepicker("option", "minDate", fromDate);
        //$("#txtDocDateTo").val($.datepicker.formatDate('yy-mm-dd', tempDate));
        $("#txtDocDateFrom").datepicker("option", "maxDate", tempDate);
    });
    
$('#rdPrdCat').buttonset();



    var pagefunction = function () {
        
       
        //alert("0000111");
        
       loadScript("js/plugin/jqgrid/ui.multiselect.js", function () {
            loadScript("js/plugin/jqgrid/grid.locale-en.min.js", function () {
                loadScript("js/plugin/jqgrid/jquery.jqGrid.min.js", function () {
                    loadScript("js/column-chooser.js", function () {
                        run_jqgrid_function();
                        getCurrDateTime();
                    });
                });
            });
        });
        
        function getCurrDateTime()
        {    
            $.get('${pageContext.request.contextPath}/Servlet_SystemEnvironmentSettings', {SFC: 'GET_CURRENTDATETIME'}, function (data) {
                var arrData = String(data);
    //          alert(data);
                $("#ControlDateTime").val(arrData);            
            });
        };
   //$.showLoadingNoStatus();      
        function run_jqgrid_function() {
            
            var grid = $("#jqgridPrdList"),
                gridPager = "#p" + grid.selector.toString().substring(1),
                conDiv = $("#c" + grid.selector.toString().substring(1)),
                defaultColName =  [   'Date', 'Product Code','Product','Category','Group', 'Type','Company', 'Issue', 'Recieve','Qty','UOM','Transfer Detail Ref#' ],
                defaultColMol = [
                    //  {name:'MEM_NRIC',index:'MEM_NRIC', sortable:true, searchoptions: { sopt: ['cn']}, formatter:'showlink',formatoptions:{baseLinkUrl:'../ProviderPortal/Prov_Patient_Detail.jsp',addParam: '',showAction:'',idName:'PMemNRIC'}},                     
                    //{name: 'details', index: 'details',  search: false, sortable: false, width: 120, align:'center',must: true, hidedlg: true},
//                    { name: 'MyCol', index: 'MyCol',editable:true, edittype:'checkbox', editoptions: { value:"True:False"}, 
//                        formatter: "checkbox", formatoptions: {disabled : false}},
                    {name: 'DocDate', index: 'DocDate', sortable: true, must: true, hidedlg: true, width: 80},
                    {name: 'StockCode', index: 'StockCode', sortable: true, must: true, hidedlg: true, width: 80},
                    {name: 'StockDesc', index: 'StockDesc', sortable: true, must: true, hidedlg: true, width: 220},
                    {name: 'StockConsumable', index: 'StockConsumable', sortable: true, width: 80},
                    {name: 'StockGroup', index: 'StockGroup', sortable: true, width: 80},
                    {name: 'StockType', index: 'StockType', sortable: true, width: 80},
                    {name: 'Company', index: 'Company', sortable: true, width: 80},
                    {name: 'IssueLocation', index: 'IssueLocation', sortable: true, width: 80},
                    {name: 'RecieveLocation', index: 'RecieveLocation', sortable: true, width: 80},
                    {name: 'UndispatchedQty', index: 'UndispatchedQty', sortable: true, width: 120},
                    {name: 'UOM', index: 'UOM', sortable: true, width: 80},
                    {name: 'xfrd_stockxfrdtlidx', index: 'xfrd_stockxfrdtlidx', sortable: true, visible:false}
			 
                ],
              
                mainGridName = grid.selector.toString().substring(1),
                //temp = readSettings({settingArray:${sessionScope.settings}, defaultColName: defaultColName, defaultColMol: defaultColMol, settingName: mainGridName});//,
                temp = readSettings({settingArray:"admin", defaultColName: defaultColName, defaultColMol: defaultColMol, settingName: mainGridName}),
              currentColName = temp[0],
              currentColMol = temp[1];
       // alert(JSON.stringify(temp));
        grid.jqGrid({
            url: '${pageContext.request.contextPath}/Servlet_Transfer',
                postData: {
                        SFC: 'GET_UNDISPATCHED_STOCK_LIST',               
//                        PRDCODE: $('#txtPrdCode').val(),
//                        PRDNAME: $('#txtPrdDesc').val(),
//                        PrdGrpFrom: $('#ddlPrdGrpFrom').val(),
//                        PrdGrpTo: $('#ddlPrdGrpTo').val(),
//                        PRDTYPFROM: $('#ddlPrdTypeFrom').val(),
//                        PRDTYPTO: $('#ddlPrdTypeTo').val(),
//                        PRDCAT: $('input[name=rdPrdCat]:checked').val()
                        STOCKCODE: '@@'
                        
                },
            datatype: "json",
            mtype: 'POST',
            colNames: currentColName,
            colModel: currentColMol,
           // rownumbers: true,
            gridview: true,
            rownumWidth: 40,
            rowNum: 20,
            rowList: [10, 20, 25, 30, 50, 100],
            pager: gridPager,
            sortname: 'StockCode',
            viewrecords: true,
            sortorder: 'desc',
            toolbarfilter: true,
            autowidth: true,
            shrinkToFit: true,
            loadonce: false,
            height: 'auto',
           scrollerbar: false,  
           //subGrid: true,
           rownumbers: true,
           celledit: true,
            multiselect:true,
            async: true,
           sortable: {
                update: function (relativeColumnOrder) {
                    //sortColumn({settingArray:${sessionScope.settings}, order: relativeColumnOrder, grid: grid, defaultColMol: defaultColMol, settingName: mainGridName});
                    sortColumn({settingArray:"admin", order: relativeColumnOrder, grid: grid, defaultColMol: defaultColMol, settingName: mainGridName});
                }
            },
                loadComplete: function () {
                var iLastPage = parseInt($(this).getGridParam('lastpage'));
                $(".ui-jqgrid .ui-pg-input").keydown(function (e) {
                    this.value = this.value.replace(/\D/g, '');
                    var code = e.keyCode || e.which;
                    if (code === 13) {
                        if (this.value > iLastPage) {
                            this.value = iLastPage;
                        } else if (this.value <= 0) {
                            this.value = 1;
                        }
                    }
                });
            }
        });
        
//          function viewDetail(cellvalue, options, rowObject) {
//              //return "<a  target='_self' class='btn btn-default bg-color-blueDark txt-color-white' title='Member Detail' href='#/MemberDetail/" + rowObject.MEM_ID + "/" + rowObject.MEM_CorpCode + "'>View Details</a>";
//              return"<a style='cursor: pointer;' title='View Details' href='#/ProductDetail/" + rowObject.stk_stockcode +  "'><i class='fa fa-fw fa-lg fa-list-alt' /></a>";
//               
//            }
        // remove classes
        $(".ui-jqgrid").removeClass("ui-widget ui-widget-content");
        $(".ui-jqgrid-view").children().removeClass("ui-widget-header ui-state-default");
        $(".ui-jqgrid-labels, .ui-search-toolbar").children().removeClass("ui-state-default ui-th-column ui-th-ltr");
        $(".ui-jqgrid-pager").removeClass("ui-state-default");
        $(".ui-jqgrid").removeClass("ui-widget-content");
        // add classes
        $(".ui-jqgrid-htable").addClass("table table-bordered table-hover");
        $(".ui-jqgrid-btable").addClass("table table-bordered table-striped");
        $(".ui-pg-div").removeClass().addClass("btn btn-sm btn-primary");
        $(".ui-icon.ui-icon-plus").removeClass().addClass("fa fa-plus");
        $(".ui-icon.ui-icon-pencil").removeClass().addClass("fa fa-pencil");
        $(".ui-icon.ui-icon-trash").removeClass().addClass("fa fa-trash-o");
        $(".ui-icon.ui-icon-search").removeClass().addClass("fa fa-search");
        $(".ui-icon.ui-icon-refresh").removeClass().addClass("fa fa-refresh");
        $(".ui-icon.ui-icon-disk").removeClass().addClass("fa fa-save").parent(".btn-primary").removeClass("btn-primary").addClass("btn-success");
        $(".ui-icon.ui-icon-cancel").removeClass().addClass("fa fa-times").parent(".btn-primary").removeClass("btn-primary").addClass("btn-danger");
        $(".ui-icon.ui-icon-seek-prev").wrap("<div class='btn btn-sm btn-default'></div>");
        $(".ui-icon.ui-icon-seek-prev").removeClass().addClass("fa fa-backward");
        $(".ui-icon.ui-icon-seek-first").wrap("<div class='btn btn-sm btn-default'></div>");
        $(".ui-icon.ui-icon-seek-first").removeClass().addClass("fa fa-fast-backward");
        $(".ui-icon.ui-icon-seek-next").wrap("<div class='btn btn-sm btn-default'></div>");
        $(".ui-icon.ui-icon-seek-next").removeClass().addClass("fa fa-forward");
        $(".ui-icon.ui-icon-seek-end").wrap("<div class='btn btn-sm btn-default'></div>");
        $(".ui-icon.ui-icon-seek-end").removeClass().addClass("fa fa-fast-forward");
        $(".ui-pg-input").addClass("pg-input");
        
        // resize
        $(window).on('resize', function () {
            grid.jqGrid('setGridWidth', conDiv.width());
        });
        grid.on('myRefresh', function () {
            resizeWidth({grid: grid, gridDiv: conDiv});
        });
//         quickSetupChooser({grid: grid, defaultColMol: defaultColMol, settingName: mainGridName,
//            settingArray:${sessionScope.settings},
        quickSetupChooser({grid: grid, defaultColMol: defaultColMol, settingName: mainGridName,
            settingArray:"admin",
            done: function () {
                resizeWidth({grid: grid, gridDiv: conDiv});
            }
        });
        grid.jqGrid('setGridWidth', conDiv.width());
        
         
};
};

 function ResetSearchFields() {
 
               
                $('#txtPrdCode').val("");
                $('#txtPrdDesc').val("");
                $('#ddlPrdGrpFrom').val("");
//                $('#ddlPrdGrpTo').val("");
                $('#ddlPrdTypeFrom').val("");
                $('#ddlReceiveLocation').val("");
//                $('#ddlPrdTypeTo').val("");
               
 }

function getGridRowHeight(targetGrid) {
        var height = null; // Default
        try {
            height = $(targetGrid).find('tbody').find('tr:eq(2)').outerHeight();
        }
        catch (e) {
            height = 23;
        }
        return height;
    }

function scrollToRow(targetGrid, id) {
        var rowHeight = getGridRowHeight(targetGrid); // Default height
        var index = $(targetGrid).getInd(id - 1);
        $(targetGrid).closest(".ui-jqgrid-bdiv").animate({scrollTop: rowHeight * index}, '250', 'swing', function () {

        });
    }
    
function Search() {

       // alert('here');
        //alert($('input[name=rdPrdCat]:checked').val());
        $("#jqgridPrdList").jqGrid('setGridParam', {
            postData: {
                SFC: 'GET_UNDISPATCHED_STOCK_LIST',              
                STKCODE: $('#txtPrdCode').val(),     
                STKDESC: $('#txtPrdDesc').val(),     
                STKGROUP: $('#ddlPrdGrpFrom').val(),
                STKTYPE: $('#ddlPrdTypeFrom').val(),
//            STKCODE:  '',              
//                STKGROUP: '',
//                STKTYPE: '',
                LOCATION: $('#ddlReceiveLocation').val(),
                COMPCODE: '',
                CONVUOM: '',
                //STKCONSUMABLE: '',
                STKCONSUMABLE: $('input[name=rdPrdCat]:checked').val(),
                DATEFROM: $('#txtDocDateFrom').val(),
                DATETO:$('#txtDocDateTo').val() + ' 23:59:59'
            }
        }).trigger("reloadGrid", [{page: 1}]);
    }

    
     loadScript("js/plugin/jqgrid/grid.locale-en.min.js", function () {
        loadScript("js/buttonset.js", function () {
            loadScript("js/excel-export.js", function () {
             
               // $('#rdCCStatus').buttonset();
                //$('#chkpayStatus').buttonset();
               // $('#rdEmpDep').buttonset();
                pagefunction();
            });
        });
    });
    pageSetUp();
    
    function ProductLookup() {
        
        showProduct({width: 800, height: 600}).done(function (rowIn) {
            //alert(JSON.stringify(rowIn));
            $("#txtPrdDesc").val(rowIn.stk_desc);
            $("#txtPrdCode").val(rowIn.stk_stockcode);
        });
    }
    
    
    var lastlineno = 0;
    function OnItemsSelected(e)
    {
        var grid = $('#jqgridPrdList');
        var ids = grid.jqGrid('getGridParam','selarrrow');
        var existedcount = 0;
        for (var i=0, il = ids.length; i < il; i++)
        {
            var dtlidx = grid.jqGrid('getCell', ids[i], 'xfrd_stockxfrdtlidx');
               var docdate = grid.jqGrid('getCell', ids[i], 'DocDate');
               var comp= grid.jqGrid('getCell', ids[i], 'Company');
               var stkcode = grid.jqGrid('getCell', ids[i], 'StockCode');
               var isslocation = grid.jqGrid('getCell', ids[i], 'IssueLocation');
               var rcvlocation = grid.jqGrid('getCell', ids[i], 'RecieveLocation');
               var undispqty = grid.jqGrid('getCell', ids[i], 'UndispatchedQty');
               var uom = grid.jqGrid('getCell', ids[i], 'UOM');
            
//        alert ($( "input[value='" + dtlidx + "']","#tbPoItem").val());
//        alert(dtlidx);
//        alert(existedcount);
        
            if ($( "input[value='" + dtlidx + "']" ,"#tbPoItem").val() === dtlidx) //LLT Modified - add ,"#tbPoItem"
            {
                existedcount = existedcount + 1;
            }
            
            
        else
        {

            lastlineno=lastlineno+1;
            $("#tbPoItem tbody").append("<tr id=tr" + lastlineno + ">" +
                "<td><input type='hidden' class='form-control'ID='hidDetailIdx" + lastlineno + "' name='hidDetailIdx" + lastlineno + "' /></td>" +    
                "<td><input type='submit' class='btn btn-default bg-color-blueDark txt-color-white' ID='btnDelete" + lastlineno + "' name='btnDelete" + lastlineno + "' value='Delete' style='width:100px' onclick='DeleteRow(event)' /></td>" +    
                "<td><input type='text' class='form-control' readonly ID='txtDocDate" + lastlineno + "' name='txtDocDate" + lastlineno + "' style='width:100px'   /></td>" +
                "<td><input type='text' class='form-control' readonly ID='txtCompany" + lastlineno + "' name='txtCompany" + lastlineno + "' style='width:100px'   /></td>" +
                "<td><input type='text' class='form-control' readonly ID='txtIssue" + lastlineno + "' name='txtIssue" + lastlineno + "' style='width:100px'   /></td>" +
                "<td><input type='text' class='form-control' readonly ID='txtLocation" + lastlineno + "' name='txtLocation" + lastlineno + "' style='width:100px'   /></td>" +
                "<td><input type='text' class='form-control' readonly ID='txtStkCode" + lastlineno + "' name='txtStkCode" + lastlineno + "' style='width:100px' value=''  /></td>" +
                "<td><input type='text' class='form-control' readonly ID='txtQty" + lastlineno + "' name='txtQty" + lastlineno + "' style='width:100px' value='0'  /></td>" +
                "<td><input type='text' class='form-control' readonly ID='txtUOM" + lastlineno + "' name='txtUOM" + lastlineno + "' style='width:100px'   /></td>" +
                "<td><input type='text' class='form-control' ID='txtDespQty" + lastlineno + "' name='txtDespQty" + lastlineno + "' style='width:100px' value='0'  /></td>" +
                "</tr>"
      
                );
               
                
                $("#hidDetailIdx"+ lastlineno).val(dtlidx);
                $("#txtDocDate"+ lastlineno).val(docdate);
                $("#txtCompany"+ lastlineno).val(comp);
                $("#txtLocation"+ lastlineno).val(rcvlocation);
                $("#txtIssue"+ lastlineno).val(isslocation);
                $("#txtStkCode"+ lastlineno).val(stkcode);
                $("#txtQty"+ lastlineno).val(undispqty);
                $("#txtUOM"+ lastlineno).val(uom);
                $("#txtDespQty"+ lastlineno).val(undispqty);
 
                 
            }
             
        }
        //alert(existedcount);
        if (existedcount > 0)
        {
            if (existedcount > 1)
            {
               // alert("Some items have already been selected previously.");
                existedcount = 0;
                $.bigBoxWarning({
                        title: "Item Selection.",
                        content: "Some items have already been selected previously.",
                        timeout: 3000
                    });
            }
            else
            {
                existedcount = 0;
//                alert("One of the items has already been selected previously.");
                $.bigBoxWarning({
                        title: "Item Selection.",
                        content: "Some items have already been selected previously.",
                        timeout: 3000
                    });
                }
        }
        $("#jqgridPrdList").jqGrid('resetSelection');
    }
    
   function DeleteRow(e)
   {
      $('table#tbPoItem tr#tr' + e.target.id.substring(9) ).remove();
   }
   function DeleteAllRows()
   {
      $('table#tbPoItem tbody tr').remove();
   }
    
    function confirm()
    {   
        var rowCount = $('#tbPoItem tr').length;       
        if (rowCount === 1)
        {
            $.bigBoxWarning({
                        title: "Stock Dispatch.",
                        content: "Please select item for Dispatch.<br> Please try again...",
                        timeout: 3000
                    });
                    return;
        }
        if ($('#txtDespatchPersonID').val() === '' || $('#txtDespatchPersonName').val() === '' || $('txtRemarks').val() === '')
            {
                $.bigBoxWarning({
                        title: "Stock Dispatch.",
                        content: "Dispatch Person's Name and ID and Remarks fields cannot be blank.<br> Please try again...",
                        timeout: 3000
                    });
                    return;
            }
                    
         document.getElementById("btnSave").disabled = true;
         showYesNo({
            title: "Stock Dispatch...",
            width: 420,
            noClose: true,
            isModal: true,
            body: [
                "<br><h4>Are you sure to proceed to dispatch items?<h4><br>"
            ],
            show: function () {
            },
            Yes: {
                 text: "Yes",
                opt: function () {           
                    addDispatch();
                    hideYesNo();
                }
            },
            No: {
                text: "No",
                opt: function () {
                    document.getElementById("btnSave").disabled = false;
                    hideYesNo();
                }
            }
        });
    }
                    
    function addDispatch()
    {
        var selection = new Object();
        selection.COMPCODE = "";
        selection.LOCATION = "";
        selection.ISSUE = "";
         var DespHdrData = new Array();
         $('#tbPoItem tr').each(function (row, th) {
                         
             if (row > 0)
             {
                var rowid = $(this).closest('tr').attr('id');
                var rowno = rowid.substring(2);
                var found = false;
                var comp = $('#txtCompany' + rowno).val();
                var loc = $('#txtLocation' + rowno).val(); 
                var iss = $('#txtIssue' + rowno).val();
                for (i=0;i<DespHdrData.length;i++){
                     selection = DespHdrData[i];

                     if (selection.COMPCODE === comp && selection.LOCATION === loc
                             && selection.ISSUE === iss)
                     {
                         found = true;
                         break;
                     }
                }
                if (!found)
                {
                    DespHdrData.push({"COMPCODE":comp, "ISSUE":iss, "LOCATION":loc});
                }            
            }
        });
        
        
        for (i=0;i<DespHdrData.length;i++){
                     selection = DespHdrData[i];
               
             var DespItemData = new Array();
             var rowDesp = 0;
            $('#tbPoItem tr').each(function (row, th) {
                if (row > 0)
                {           
                    var rowid = $(this).closest('tr').attr('id');
                    var rowno = rowid.substring(2);
                
                    var comp = $('#txtCompany' + rowno).val();
                    var loc = $('#txtLocation' + rowno).val(); 
                    var iss = $('#txtIssue' + rowno).val();
                     if (selection.COMPCODE === comp && selection.LOCATION === loc
                                 && selection.ISSUE === iss)
                    {
                       
                        DespItemData[rowDesp] = {
                            FUNCTION: 'INSERT',
                            "COMPCODE": comp
                            ,"PRODCODE": $('#txtStkCode' + rowno).val()  
                            ,"LOCATION_FROM": $('#txtIssue' + rowno).val() 
                            ,"LOCATION_TO": $('#txtLocation' + rowno).val()                   
                            , "UOM": $('#txtUOM' + rowno).val()
                            , "XFERIDX": $('#hidDetailIdx' + rowno).val()
                            , "QTY":  parseFloat($('#txtDespQty' + rowno).val())
                            , "ACCPQTY": '0'
                            , "STATUS": 'O'
                            , "DESPDTLIDX" : '0'
                            ,"REMARKS": ''
                            ,"PREVACCPQTY": '0'
                            ,"ACCPQTY": '0'
                            ,"CONTROL_DATETIME":  $('#ControlDateTime').val()
                        };
                        rowDesp = rowDesp + 1;
                    }

                }
            });

            var ItemToSend = JSON.stringify(DespItemData);
            $('#hidDespItems').load().val(ItemToSend).valid();
            
            $.ajax({
                type: "POST",
                url: "${pageContext.request.contextPath}/Servlet_StockDespatch?SFC=CREATE_STOCK_DESPATCH",
                data: {                   
                    ITEMS: $('#hidDespItems').val(),
                    COMPCODE: selection.COMPCODE,
                    ISSUE: selection.ISSUE,
                    RECIEVE: selection.LOCATION,
                    PERSON_ID: $('#txtDespatchPersonID').val(),
                    PERSON_NAME: $('#txtDespatchPersonName').val(),
                    REMARKS: $('#txtRemarks').val(),
                    FUNCTION: 'INSERT',
                    STATUS: 'O',
                    CONTROL_DATETIME: $('#ControlDateTime').val()
                },
                dataType: 'json',
                beforeSend: function () {
                   $.showLoadingNoStatus();
                },
                success: function (response, status, xhr) {
                if (response.bool === true) {
                    LoadPrintPreview(response.msg);
                    $.bigBoxSuccess({
                        title: "Stock Dispatch Successful.",
                        content: "Stock Dispatch Updated Successfully.",
                        timeout: 6000
                    });
                } else {
                    $.bigBoxFail({
                        title: "Stock Dispatch FAIL.",
                        content: "There is some error during Stock Dispatch creation.<br> Please try again...",
                        timeout: 6000
                    });
                }
                },
                error: function (xhr, status, error) {
                    $.bigBoxFail({
                        title: "Dispatch ERROR",
                        content: "There is some error occur during dispatch process. Please try again later",
                        timeout: 6000
                    });
                },
                complete: function (xhr, status) {
                    if (xhr.status === 200) {
                        $.hideLoadingNoStatus(function () {
                           window.location.href = "#/StockDespatchList";
                        }, 500);
                    } else {
                        $.hideLoadingNoStatus(function () {
                        }, 0);
                    }
                }
            });
        }
    }

    function LoadPrintPreview(sDespHdrIdx) {

        loadScript("js/print-preview.js", function () {
            var jObj = {
                1: "GET_STOCK_DESPATCH_DTL_REPORT",
                2: sDespHdrIdx,
                3: "",
                4: "",
                5: "",
                6: "",
                7: "",
                8: "",
                9: "",
                10: "",
                11: ""
            };           
            var param = {};

            // alert(JSON.stringify(jObj));               
            var object = {};
            object.procParam = jObj;
            object.jasperName = 'Stk_Despatch_Dtl_Report';
            object.procString = 'SP_GET_STOCK_DESPATCH(?,?,?,?,?,?,?,?,?,?,?)';
            object.fixParam = param;
            printToPage(object);                                               
    });
    };
    
    
</script>
