<%@taglib prefix="jstl" uri="http://java.sun.com/jsp/jstl/core" %>
<jsp:useBean id="DDL" scope="page" class="BusinessLogic.Servlet_PopulateData" />
<style type="text/css">
    .ui-jqgrid tr.jqgrow td {
        word-wrap: break-word; /* IE 5.5+ CSS3 see http://www.w3.org/TR/css3-text/#text-wrap */
        white-space: pre-wrap; /* CSS3 */
        white-space: -moz-pre-wrap; /* Mozilla, since 1999 */
        white-space: -pre-wrap; /* Opera 4-6 */
        white-space: -o-pre-wrap; /* Opera 7 */
        overflow: hidden;
        height: auto;
        vertical-align: middle;
        padding-top: 3px;
        padding-bottom: 3px
    }    
    div.errorContainer, div.errorContainer2{
        display:none;
        width:100%;
    }
    div.errorContainer, div.errorContainer2 ol li{
        list-style-type:disc;
        margin-left: 20px;
    }
    li{
        list-style:none;
    }
    select.error { border: 1px solid #A94444; background-color:#FFF0F0; }
    textarea.error { border: 1px solid #A94444; background-color:#FFF0F0; }
</style>

<link rel="stylesheet" type="text/css" href="css/your_style.css" />
<link rel="stylesheet" type="text/css" href="js/plugin/jqgrid/ui.multiselect.css" />

<section id="widget-grid" class="">
    <!--<input type="text" id="lblUserCode" value="<%= session.getAttribute("s_usercode")%>"  class="tboxreadonlyShort"/>-->
    <div class="col-xs-12 col-sm-7 col-md-7 col-lg-4">
        <h1 class="page-title txt-color-blueDark">
            <!-- PAGE HEADER -->
            <i class="fa-fw fa fa-file fa-2x"></i> 
            Item Sales Report                                   
        </h1>
    </div>
    <div class="row">
        <form id='form_ItemSales_Report'>
        <article class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
            <div class="row" style="padding-bottom:10px;padding-left:10px;padding-right:10px;">
                <div class="errorContainer alert alert-danger alert-block">
                    <h4 class="alert-heading">There were some field left out or invalid inputs. Please brief through the form and reenter necessarily.</h4>
                    <ol>
                    </ol>
                </div>
            </div>
            <div class="jarviswidget jarviswidget-color-blueDark" id="wid-id-2"  data-widget-editbutton="false" data-widget-colorbutton="false" data-widget-fullscreenbutton="false" data-widget-custombutton="false" data-widget-deletebutton="false">
                <header>
                    <span class="widget-icon"> <i class="fa fa-search"></i></span>
                    <span><h2>&nbsp;Generate Item Sales Report</h2></span>
                </header>
                <div class="no-padding">
                    <div class="widget-body">
                        <div id="selectCriTab" class="tab-content">
                            <div class="tab-pane fade active in padding-5 no-padding-bottom" id="selectCriTab_s1">
                                <table id="tblSearch" class="selection-criteria">                                  
                                    <tr>
                                        <td width="15%">Date:</td>
                                        <td width="12%"><input id="txtDocDateFrom" name="txtDocDateFrom" placeholder="Document Date" class="searchbox-date" style="width:300px;"/></td>
                                        <td width="5%">To</td>
                                        <td width="12%"><input id="txtDocDateTo" name="txtDocDateTo" placeholder="Document Date" class="searchbox-date" style="width:300px;"/></td>  
                                        <td width="5%"></td>
                                        <th>Subtotal By</th>
                                        <td width="51%"> 
                                            <div id="chkSubtotalBy">  
                                                <input type="checkbox" id="chkSubtotalBy1" name="chkSubtotalBy" value="'Category'"/><label for="chkSubtotalBy1" class="label-option btn">Category</label>  
                                                <input type="checkbox" id="chkSubtotalBy2" name="chkSubtotalBy" value="'CHGGroup'"/><label for="chkSubtotalBy2" class="label-option btn">Charge Group</label>                                                                                         
                                            </div>
                                        </td>
                                    </tr>                                   
                                    <tr>
                                        <td>Company:</td>
                                        <td>                                            
                                            <label id="selectCompany" class="searchbox">
                                            <select class="form-control" id="ddlComp" name="ddlComp" rel="popover-hover" data-original-title="Company" data-content="Select Company." style="width:300px;">
                                                <option value="">- Select Company -</option>
                                                <jstl:forEach var="ddl_Comp" items="${DDL.ddlGet('GET_COMP', '', '', sessionScope.SiteName)}">
                                                    <option value="${ddl_Comp.VALUE}">${ddl_Comp.VALUE}</option>
                                                </jstl:forEach>     
                                            </select>    
                                            </label>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Location:</td>     
                                        <td>
                                            <label id="selectLocation" class="searchbox">
                                            <select class="form-control" id="ddlLoc" name="ddlLoc" rel="popover-hover" data-original-title="Location" data-content="Select Location." style="width:300px;cursor:default;">
                                                <option value="">- Select Location -</option>
                                                <jstl:forEach var="ddl_Loc" items="${DDL.ddlGet('GET_LOCATION', '', '', sessionScope.SiteName)}">
                                                    <option value="${ddl_Loc.VALUE}">${ddl_Loc.TEXT}</option>
                                                </jstl:forEach>  
                                            </select>    
                                            </label>
                                        </td>        
                                    </tr>
                                    <tr>    
                                        <th>Category</th>
                                        <td colspan="5">
                                            <div id="chkCategory">       
                                                <input type="checkbox" id="chkCategory1" name="chkCategory" value="'DRUG'" checked="checked"/><label for="chkCategory1" class="label-option btn" id="lblCategory1">DRUG</label>
                                                <input type="checkbox" id="chkCategory2" name="chkCategory" value="'EXM'" checked="checked"/><label for="chkCategory2" class="label-option btn" id="lblCategory2">EXM</label>
                                                <input type="checkbox" id="chkCategory3" name="chkCategory" value="'INV'" checked="checked"/><label for="chkCategory3" class="label-option btn" id="lblCategory3">INV</label>
                                                <input type="checkbox" id="chkCategory4" name="chkCategory" value="'OTH'" checked="checked"/><label for="chkCategory4" class="label-option btn" id="lblCategory4">OTH</label>
                                                <input type="checkbox" id="chkCategory5" name="chkCategory" value="'TRM'" checked="checked"/><label for="chkCategory5" class="label-option btn" id="lblCategory5">TRM</label>
                                            </div>
                                        </td>
                                    </tr> 
                                    <tr>
                                        <td>Item:</td>
                                        <td>                                            
<!--                                           <label id="selectItemFrom" class="searchbox">
                                            <select class="form-control" id="ddlItemFrom" name="ddlItemFrom" rel="popover-hover" data-original-title="Item" data-content="Select Item." style="width:300px;">
                                                <option value="">- Select Item -</option>
                                                <jstl:forEach var="ddl_ItemFrom" items="${DDL.ddlGet('GET_ITEM_HIS', '', '', sessionScope.SiteName)}">
                                                    <option value="${ddl_ItemFrom.VALUE}">${ddl_ItemFrom.TEXT}</option>
                                                </jstl:forEach>                                             
                                            </select>    
                                            </label>-->
                                            <div style="float:left">
                                                <input type="text" id="txtItemFrom" name="txtItemFrom" placeholder="--Enter Item Code--" class="searchbox-text" style="width:255px;"/>
                                            </div>
                                            <div style="float:left;padding-left:2px">
                                                <button class='btn btn-default bg-color-blueDark txt-color-white' type="button" onclick="CHGItemLookup('CHGItem','From');" ><i class="fa fa-search fa-lg"></i></button>
                                            </div>
                                        </td>
                                        <td>To</td>
                                        <td colspan="3">                                            
                                            <div style="float:left">
                                                <input type="text" id="txtItemTo" name="txtItemTo" placeholder="--Enter Item Code--" class="searchbox-text" style="width:255px;"/>
                                            </div>
                                            <div style="float:left;padding-left:2px">
                                                <button class='btn btn-default bg-color-blueDark txt-color-white' type="button" onclick="CHGItemLookup('CHGItem','To');" ><i class="fa fa-search fa-lg"></i></button>
                                            </div>
                                        </td>       
                                    </tr> 
                                    <tr>
                                        <td>Charge Group:</td>
                                        <td>                                            
<!--                                            <label id="selectCHGGrpFrom" class="searchbox">
                                            <select class="form-control" id="ddlCHGGrpFrom" name="ddlCHGGrpFrom" rel="popover-hover" data-original-title="Charge Group" data-content="Select Charge Group." style="width:300px;">
                                                <option value="">- Select Charge Group -</option>
                                                <jstl:forEach var="ddl_CHGGrpFrom" items="${DDL.ddlGet('GET_CHGGROUP_HIS','','', sessionScope.SiteName)}">
                                                    <option value="${ddl_CHGGrpFrom.VALUE}">${ddl_CHGGrpFrom.VALUE}</option>
                                                </jstl:forEach>                                             
                                            </select>    
                                            </label>-->                                         
                                            <div style="float:left">
                                                <input type="text" id="txtCHGGrpFrom" name="txtCHGGrpFrom" placeholder="--Enter Charge Group Code--" class="searchbox-text" style="width:255px;"/>
                                            </div>
                                            <div style="float:left;padding-left:2px">
                                                <button class='btn btn-default bg-color-blueDark txt-color-white' type="button" onclick="CHGItemLookup('CHGGrp','From');" ><i class="fa fa-search fa-lg"></i></button>
                                            </div>
                                        </td>
                                        <td>To</td>
                                        <td colspan="3">                                            
                                            <div style="float:left">
                                                <input type="text" id="txtCHGGrpTo" name="txtCHGGrpTo" placeholder="--Enter Charge Group Code--" class="searchbox-text" style="width:255px;"/>
                                            </div>
                                            <div style="float:left;padding-left:2px">
                                                <button class='btn btn-default bg-color-blueDark txt-color-white' type="button" onclick="CHGItemLookup('CHGGrp','To');" ><i class="fa fa-search fa-lg"></i></button>
                                            </div>
                                        </td>
                                    </tr> 
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>                            
        </article>
        </form>                             
    </div>
    <div class="row" style="padding-left:20px;padding-bottom:20px;">
        <div align="center" class="padding-5" >
            <input type="button" class="btn btn-default bg-color-blueDark txt-color-white" id="btnPrintPrev" name="btnPrintPrev" onclick="LoadPrintPreview();" data-toggle='modal' data-target='#printPreview' value="Print Preview" style="margin-right:20px;"/>
            <input type="button" class="btn btn-default bg-color-blueDark txt-color-white" id="btnExport" name="btnExport" onclick="location.href = '#/dashboard'" value="Export" style="margin-right:20px;"/>
            <input type="button" class="btn btn-default bg-color-blueDark txt-color-white" id="btnCancel" name="btnCancel" onclick="location.href = '#/dashboard'" value="Cancel" style="margin-right:20px"/>
        </div>
    </div>
</section>
  <jsp:include page="../../../includes/loading-no-status.jsp"/>  
  <jsp:include page="../../../includes/PopUpInitPage.jsp"/>
  <script src="js/buttonset.js"></script>
<script type="text/javascript">
   
    pageSetUp();
    $('#chkCategory').buttonset();
    $('#chkSubtotalBy').buttonset();

    function CHGItemLookup(lookupType, ToFrom) {
        if (lookupType === 'CHGItem') {
            showCHGItemHIS({width: 800, height: 600}).done(function (rowIn) {
                //alert(JSON.stringify(rowIn));
                $("#txtItem"+ToFrom).val(rowIn.bld_chgcode);
            });
        } 
        else if (lookupType === 'CHGGrp') {
            showCHGGroupHIS({width: 800, height: 600}).done(function (rowIn) {
                $("#txtCHGGrp"+ToFrom).val(rowIn.bld_chggrp);
            });
        }
    } 

    $().ready(function(){
        
        loadScript("js/buttonset.js", function () {
            loadScript("js/excel-export.js", function () {
            });
        });
       
        $("#ddlLoc").prop("disabled", true);    
        
        $("#ddlComp").change(function(){  
            
            $('#ddlLoc').empty();            
            var sCompany = this.value;
            if (sCompany !== "") {                
                $.ajax({
                    type: "GET",
                    url: "${pageContext.request.contextPath}/Servlet_Stock?SFC=GET_REL_LOCATION",
                    data: {
                        COMPANY: sCompany
                    },
                    dataType: 'json',
                    success: function(data) {
                        $("select#ddlLoc").append( $("<option>").val("").html("- Select Location -")); 

                        for (var a=0 ; a<data.object1.length ; a++) {                   
                            var arrData = data.object1[a];                
                            $("select#ddlLoc").append( $("<option>")
                                .val(arrData.VALUE)
                                .html(arrData.VALUE)
                            ); 
                        }
                    }
                });                                                           
                $("#ddlLoc").prop("disabled", false); 
            } else 
                $("select#ddlLoc").append( $("<option>").val("").html("- Select Location -")); 
        });
        
        var tempDate = new Date();
        $("#txtDocDateFrom").datepicker({
            numberOfMonths: 2,
            changeMonth: true,
            changeYear: true,
            dateFormat: "yy-mm-dd",
            onSelect: function (selected) {
                $("#txtDocDateTo").datepicker("option", "minDate", selected);
            }
        });
        var fromDate = $.datepicker.formatDate('yy-mm-dd', new Date(tempDate.getFullYear(), tempDate.getMonth() - 4, tempDate.getDate()));
        //$("#txtDocDateFrom").val(fromDate);
        $("#txtDocDateTo").datepicker({
            numberOfMonths: 2,
            changeMonth: true,
            changeYear: true,
            dateFormat: "yy-mm-dd",
            onSelect: function (selected) {
                $("#txtDocDateFrom").datepicker("option", "maxDate", selected);
            }
        });
        $("#txtDocDateTo").datepicker("option", "minDate", fromDate);
        $("#txtDocDateFrom").datepicker("option", "maxDate", tempDate);
        
        var container = $('div.errorContainer');
        var validator = $("#form_ItemSales_Report").validate({
            rules: {                
                chkCategory: "required"
            },
            messages: { 
                chkCategory: "Category must be selected."
            },
            onclick: false,
            onfocusout: false,
            errorContainer: container,
            errorLabelContainer: $("ol", container),
            wrapper: 'li'
        });
        
        $("input[name='chkCategory']").change(function(){ 
        
            var sCategory = "";
            var categoryLen = $('input[name="chkCategory"]').length;
            for (var a=1 ; a<=categoryLen ; a++) {
                if ( $('#chkCategory'+a).is(":checked") ) {
                    sCategory += $('#chkCategory'+a).val() + ",";
                }
            }          
            sCategory = sCategory.substring(0, sCategory.length - 1);
            
            $('#ddlItemFrom').empty();
            $('#ddlItemTo').empty();
            $("#ddlItemFrom").append( $("<option>").val("").html("- Select Item -")); 
            $("#ddlItemTo").append( $("<option>").val("").html("- Select Item -")); 
            $('#ddlCHGGrpFrom').empty();
            $('#ddlCHGGrpTo').empty();
            $('#ddlCHGGrpFrom').append($("<option>").val("").html("- Select Charge Group -"));     
            $('#ddlCHGGrpTo').append($("<option>").val("").html("- Select Charge Group -")); 
            if (sCategory !== "") {      
                $.ajax({
                    type: "GET",
                    url: "${pageContext.request.contextPath}/Servlet_PopulateData?SFC=GET_DLL",
                    data: {
                        METHOD: "GET_ITEM_HIS",
                        P1: sCategory,
                        P2: ""
                    },
                    dataType: 'json',
                    success: function(data) {                                                                          
                        for(var i=0; i < data.length; i++){                                                          
                            $("#ddlItemFrom").append($("<option>")
                                .val(data[i].VALUE)
                                .html(data[i].TEXT));
                        }                                          
                        for(var i=0; i < data.length; i++){                                                          
                            $("#ddlItemTo").append($("<option>")
                                .val(data[i].VALUE)
                                .html(data[i].TEXT));
                        }                                                                
                    }
                });                           
                $.ajax({
                    type: "GET",
                    url: "${pageContext.request.contextPath}/Servlet_PopulateData?SFC=GET_DLL",
                    data: {
                        METHOD: "GET_CHGGROUP_HIS",
                        P1: sCategory,
                        P2: ""
                    },
                    dataType: 'json',
                    success: function(data) {                                                                        
                        for(var i=0; i < data.length; i++){                                                          
                            $("#ddlCHGGrpFrom").append($("<option>")
                                .val(data[i].VALUE)
                                .html(data[i].VALUE));
                        }                                           
                        for(var i=0; i < data.length; i++){                                                          
                            $("#ddlCHGGrpTo").append($("<option>")
                                .val(data[i].VALUE)
                                .html(data[i].VALUE));
                        }                                                                
                    }
                });     
            }
        });
        
        var categoryLen = $('input[name="chkCategory"]').length;
        var sCategory = "";
        for (var i=1 ; i<=categoryLen ; i++){
            sCategory += $('#chkCategory'+i).val() + ",";
        }
        sCategory = sCategory.substring(0, sCategory.length - 1);        
        $.ajax({
            type: "GET",
            url: "${pageContext.request.contextPath}/Servlet_PopulateData?SFC=GET_DLL",
            data: {
                METHOD: "GET_CODETYPE_HIS",
                P1: sCategory,
                P2: ""
            },
            dataType: 'json',
            success: function(data) { 
                for(var i=0; i < data.length; i++) { 
                    for(var a=1 ; a<=categoryLen ; a++) {
                        var currVal = $("#chkCategory"+a).val();
                        currVal = currVal.replace(/'/g,"");
                        if (currVal === data[i].VALUE) {
                            $("#lblCategory"+a).html(data[i].TEXT);
                            break;
                        }
                    }
                }
            }
        });
    });

    function LoadPrintPreview() {
    
        var $validItem = $("#form_ItemSales_Report").valid();
        if ($validItem !== true) { 
            return;
        }
        
        var sCategory = "";
        var categoryLen = $('input[name="chkCategory"]').length;
        for (var a=1 ; a<=categoryLen ; a++) {
            if ( $('#chkCategory'+a).is(":checked") ) {
                sCategory += $('#chkCategory'+a).val() + ",";
            }
        }          
        sCategory = sCategory.substring(0, sCategory.length - 1);
        
        var subtotalBy = "";
        var jasperRptName = "Item_Sales_Report_HIS_None";
        if ( $('#chkSubtotalBy1').is(":checked") && $('#chkSubtotalBy2').is(":checked")) { 
            jasperRptName = "Item_Sales_Report_HIS_All";
            subtotalBy = "ALL";
        }
        else if ( $('#chkSubtotalBy1').is(":checked") ) {
            jasperRptName = "Item_Sales_Report_HIS_Category";
            subtotalBy = "CATEGORY";
        } 
        else if ( $('#chkSubtotalBy2').is(":checked") ) { 
            jasperRptName = "Item_Sales_Report_HIS_CHGGroup";
            subtotalBy = "CHGGROUP";
        } 
        
        loadScript("js/print-preview.js", function () {
            var jObj = {              
                1: "GET_SALES_REPORT_HIS",
                2: $('#txtDocDateFrom').val(),
                3: $('#txtDocDateTo').val(),
                4: $('#txtItemFrom').val(),
                5: $('#txtItemTo').val(),
                6: $('#ddlComp').val(),
                7: $('#ddlLoc').val(),
                8: "",//ddlStkTypeFrom
                9: "",//ddlStkTypeTo
                10: $('#txtCHGGrpFrom').val(),
                11: $('#txtCHGGrpTo').val(),
                12: sCategory,
                13: subtotalBy
            }; 
            
            var param = {};           
            //alert(JSON.stringify(jObj));               
            var object = {};
            object.procParam = jObj;
            object.jasperName = jasperRptName;
            object.procString = 'SP_GET_REPORT_HIS(?,?,?,?,?,?,?,?,?,?,?,?,?)';
            object.fixParam = param;
            
            printToPage(object);                                           
        });      
    };
</script>
