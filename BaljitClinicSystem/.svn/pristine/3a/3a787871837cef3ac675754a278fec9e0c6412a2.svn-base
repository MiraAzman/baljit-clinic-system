<!--
Modification ID     By          Date        Comment
----------------------------------------------------------------------
yesno01             Aaron       18Dec2018   include yes-no.jsp in the code
c01                 Aaron       18Dec2018   add confirmation box and loading screen when user try to update existing record
path01              Aaron       04Jan2019   change the path for chargeItem_Detail to display category beside the page title
font01              Aaron       04Jan2019   change font style and color for mandatory fields
len01               Aaron       04Jan2019   set maxlength for textbox
style01             Aaron       04Jan2019   change display style for Description from textbox to textarea
valid01             Aaron       04Jan2019   add validation for number
gg01                Aaron       08Jan2019   add condition to remove box shadow
valid02             Aaaron      08Jan2019   add validation for Cost up to 3 decimal places only
-->
<%@taglib prefix="jstl" uri="http://java.sun.com/jsp/jstl/core" %>
<jsp:useBean id="DDL" scope="page" class="BusinessLogic.Servlet_PopulateData" />
<style type="text/css">
    .ui-jqgrid tr.jqgrow td {
        word-wrap: break-word; /* IE 5.5+ CSS3 see http://www.w3.org/TR/css3-text/#text-wrap */
        white-space: pre-wrap; /* CSS3 */
        white-space: -moz-pre-wrap; /* Mozilla, since 1999 */
        white-space: -pre-wrap; /* Opera 4-6 */
        white-space: -o-pre-wrap; /* Opera 7 */
        overflow: hidden;
        height: auto;
        vertical-align: middle;
        padding-top: 3px;
        padding-bottom: 3px 
    }
    .centered {
        position: fixed;
        top: 50%;
        left: 50%;
        margin-top: -50px;
        margin-left: -200px;
    }
    div.errorContainer, div.errorContainer2{
        display:none;
        width:100%;
    }
    div.errorContainer, div.errorContainer2 ol li{
        list-style-type:disc;
        margin-left: 20px;
    }
    li{
        list-style:none;
    }
    .disabledTab{
        pointer-events: none;
    }
    input[type="text"].error { border: 1px solid #A94444; background-color:#FFF0F0; }
    textarea.error { border: 1px solid #A94444; background-color:#FFF0F0; }
    /*gg01*/
    input[type="text"]:read-only {box-shadow: none;}
    textarea:read-only {box-shadow: none;}
</style>
<link rel="stylesheet" type="text/css" href="css/your_style.css" />
<link rel="stylesheet" type="text/css" href="js/plugin/jqgrid/ui.multiselect.css" />
<section id="widget-grid" class="">
    <input type="hidden" value={{params}} id="hidHospCode">
    <div class="col-xs-12 col-sm-7 col-md-7 col-lg-12">
        <h1 class="page-title txt-color-blueDark">
            <!-- PAGE HEADER -->
            <i class="fa-fw fa fa-file fa-2x"></i> 
            <!--Charge Item Detail-->    
            <Label ID="txtPageTitle" Text="Vessel:" style="font-weight:lighter;"   >
        </h1>
    </div>
    <div class="widget-body row">
        <article class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
            <div class="row" style="padding-bottom:10px;padding-left:10px;padding-right:10px;">
                <div class="errorContainer alert alert-danger alert-block">
                    <h4 class="alert-heading">There were some field left out or invalid inputs. Please brief through the form and reenter necessarily.</h4>
                    <ol id="error_list">
                    </ol>
                </div>
            </div>           
            <div class="row">
                <form id="form_CHGItemDetail" name="form_CHGItemDetail" method="post">
                    <article class="col-sm-12 col-md-12 col-lg-12">
                        <div class="jarviswidget jarviswidget-color-blueDark" id="wid-id-1"  data-widget-editbutton="false" data-widget-custombutton="false"
                             data-widget-deletebutton="false" data-widget-colorbutton="false" data-widget-fullscreenbutton="false" data-widget-togglebutton="false">
                            <header>
                                <span class="widget-icon"> <i class="fa fa-file"></i></span>
                                <span><h2>&nbsp;General Info</h2></span>
                            </header>
                            <div class="row">
                                <div class="widget-body">
                                    <table id="table2" class="table table-bordered table-striped" style="clear:both;">
                                        <tbody>                                           
                                            <tr>
                                                <td width="10%"><font color="red">*</font> <b>Code</b></td> <!--font01-->
                                                <td width="1%">:</td>
                                                <td width="30%"> 
                                                    <input type="text" id="txtCode" name="txtCode" readonly class="tboxreadonly"/>    
                                                </td>
                                                <td width="14%">GST Tax Code (Supply)</td>
                                                <td width="1%">:</td>
                                                <td width="44%">       
                                                    <input type="text" id="lblGSTCode" name="lblGSTCode" readonly class="tboxreadonly"/>
                                                    <label id="selectGSTCode" class="searchbox" style="display:none;">
                                                        <select class="form-control" id="ddlGSTCode" name="ddlGSTCode" style="width:250px;">
                                                            <option value="">- Select GST Tax Code (Supply) -</option> 
                                                        </select>    
                                                    </label>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><font color="red">*</font> <b>Description</b></td> <!--font01-->
                                                <td>:</td>
                                                <td> 
                                                    <!--style01-->
                                                    <textarea rows="3" maxlength="100" cols="50" id="lblDesc" name="lblDesc" readonly class="tboxreadonly" style="width:360px; resize:none;"/>
                                                    <textarea rows="3" maxlength="100" cols="50" id="txtDesc" name="txtDesc"  class="form-control" style=" display:none;width:360px; resize:none;"/>  <!--len01-->  
                                                </td>
                                                <td><font color="red">*</font> <b>Cost</b></td> <!--font01-->
                                                <td>:</td>
                                                <td>
                                                    <input type="text" id="lblCost" name="lblCost" readonly class="tboxreadonly"/>
                                                    <input type="text" id="txtCost" name="txtCost"  class="form-control" style="width:250px;display:none;" min="0.001"/>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>Charge Group</td>
                                                <td>:</td>
                                                <td> 
                                                    <input type="text" id="lblCHGGroup" name="lblCHGGroup" readonly class="tboxreadonly"/>
                                                    <label id="selectCHGGroup" class="searchbox" style="display:none;">
                                                        <select class="form-control" id="ddlCHGGroup" name="ddlCHGGroup" rel="popover-hover" data-original-title="Charge Group" data-content="Select Charge Group." style="width:250px;">
                                                            <option value="">- Select Charge Group -</option> 
                                                        </select>    
                                                    </label>  
                                                </td>
                                                <td>Is Active</td>
                                                <td>:</td>
                                                <td>
                                                    <input type="checkbox" id="chkIsActive" name="chkIsActive" disabled="disabled"/> 
                                                </td>
                                            </tr>
                                            
                                            
                                            <tr>
                                                <td>Account Group</td>
                                                <td>:</td>
                                                <td> 
                                                    <input type="text" id="lblAccGroup" name="lblAccGroup" readonly class="tboxreadonly"/>
                                                    <label id="selectACCGroup" class="searchbox" style="display:none;">
                                                        <select class="form-control" id="ddlACCGroup" name="ddlACCGroup" rel="popover-hover" data-original-title="Account Group" data-content="Select Account Group." style="width:250px;">
                                                            <option value="">- Select Account Group -</option> 
                                                        </select>    
                                                    </label>  
                                                </td>
                                                <td> </td>
                                                <td></td>
                                                <td>
                                                    
                                                </td>
                                            </tr>
                                            
                                            
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="jarviswidget jarviswidget-color-blueDark" id="wid-id-1"  data-widget-editbutton="false" data-widget-custombutton="false"
                             data-widget-deletebutton="false" data-widget-colorbutton="false" data-widget-fullscreenbutton="false" data-widget-togglebutton="false">
                            <header>
                                <span class="widget-icon"> <i class="fa fa-file"></i></span>
                                <span><h2>&nbsp;Billing Prices Info</h2></span>
                            </header>
                            <div class="row">
                                <div class="widget-body">
                                    <table id="table1" class="table table-bordered table-striped" style="clear:both;">
                                        <tbody>                                           
                                            <tr>
                                                <td width="10%">Price 1 (Low)</td>
                                                <td width="1%">:</td>
                                                <td width="37%"> 
                                                    <input type="text" id="lblPrice1" name="lblPrice1" readonly class="tboxreadonly"/>
                                                    <input type="text" id="txtPrice1" name="txtPrice1" placeholder="Billing Price 1" style="width:250px;display:none;" class="form-control"/>    
                                                </td>
                                                <td width="14%">Price 2 (Moderate)</td>
                                                <td width="1%">:</td>
                                                <td width="37%">       
                                                    <input type="text" id="lblPrice2" name="lblPrice2" readonly class="tboxreadonly"/>
                                                    <input type="text" id="txtPrice2" name="txtPrice2" placeholder="Billing Price 2" style="width:250px;display:none;" class="form-control"/>    
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>Price 3 (High)</td>
                                                <td>:</td>
                                                <td> 
                                                    <input type="text" id="lblPrice3" name="lblPrice3" readonly class="tboxreadonly"/>
                                                    <input type="text" id="txtPrice3" name="txtPrice3" placeholder="Billing Price 3" style="width:250px;display:none;" class="form-control"/>    
                                                </td>
                                                <td>Price 4 (Premium)</td>
                                                <td>:</td>
                                                <td>       
                                                    <input type="text" id="lblPrice4" name="lblPrice4" readonly class="tboxreadonly"/>
                                                    <input type="text" id="txtPrice4" name="txtPrice4" placeholder="Billing Price 4" style="width:250px;display:none;" class="form-control"/>    
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>                       
                    </article>  
                </form>
            </div>
        </article>                                                
        <div>
            <div class="row">
                <div class="col-sm-12">
                    <div align="center" class="padding-5" >
                        <input type="button" Id="btnSave"  class="btn btn-default bg-color-blueDark txt-color-white" value="Edit Detail" style="margin-right:20px;"/>
                        <input type="button" Id="btnCancel"  class="btn btn-default bg-color-blueDark txt-color-white"  value="Cancel" onclick="location.href = '#/ChargeItemList'" />
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<jsp:include page="../../includes/loading-no-status.jsp"/>
<!--yesno01-->
<jsp:include page="../../../includes/yes-no.jsp"/>
<script type="text/javascript">
    
    pageSetUp();
    
    getDLL("ddlGSTCode", "GET_ACTIVEGSTCODE", "SUPPLY", "");
    getDLL("ddlCHGGroup", "GET_CHGGROUP_CHGITEM", "", "");
    getDLL("ddlACCGroup", "GET_CHGGROUP_CHGITEM", "ACCGRP", "");

    function getDLL (ddl, method, param1, param2) {
        $.get('${pageContext.request.contextPath}/Servlet_PopulateData', {SFC: 'GET_DLL', METHOD: method, P1: param1, P2: param2}, function (data) {
            for(var i=0; i < data.length; i++){                                                          
                $("#"+ddl).append($("<option>").val(data[i].VALUE).html(data[i].TEXT));
            }     
        });     
    }        
    
    var ci_cigroup = "";
    function bindData(sParam) {  
        var pagefunction = function() {

            $().ready(function () {
                $("#txtPageTitle").html('Charge Item Detail - ' + sParam.DESC); //path01
                var sIdx = sParam.IDX;                    
                $.ajax({
                    type:'POST',
                    url:"${pageContext.request.contextPath}/Servlet_ChargeItem",
                    data:  {
                        SFC: 'GET_CHGITEM_DETAIL', 
                        IDX: sIdx
                    },
                    dataType: 'json',
                    success: function(data) {                                     
                        var arrData = data.object1[0]; 
                        $('#txtCode').val(arrData.ci_cicode);                       
                        $('#lblDesc').val(arrData.ci_cidesc); $('#txtDesc').val(arrData.ci_cidesc);
                        $('#lblCHGGroup').val(arrData.ci_cigroup); $('#ddlCHGGroup').val(arrData.ci_cigroup);
$('#lblAccGroup').val(arrData.ci_cireportgroup); $('#ddlACCGroup').val(arrData.ci_cireportgroup);  
                        $('#lblGSTCode').val(arrData.ci_cigstsupptaxcode); $('#ddlGSTCode').val(arrData.ci_cigstsupptaxcode); 
                        $('#lblCost').val(arrData.ci_cicost); $('#txtCost').val(arrData.ci_cicost);                        
                        $('#lblPrice1').val(arrData.ci_ciprice); $('#txtPrice1').val(arrData.ci_ciprice); 
                        $('#lblPrice2').val(arrData.ci_ciprice2); $('#txtPrice2').val(arrData.ci_ciprice2); 
                        $('#lblPrice3').val(arrData.ci_ciprice3); $('#txtPrice3').val(arrData.ci_ciprice3); 
                        $('#lblPrice4').val(arrData.ci_ciprice4); $('#txtPrice4').val(arrData.ci_ciprice4);                        
                        if (arrData.ci_ciisactive === 'Y') 
                            $('#chkIsActive').prop('checked', true);                            
                        else
                            $('#chkIsActive').prop('checked', false);   
                        $('#chkIsActive').val(arrData.ci_ciisactive);
                        ci_cigroup = arrData.ci_cigroup;
                    }
                }); 

                $("#chkIsActive").click(function(){
                    if ( $('#chkIsActive').is(":checked") ) {
                        $('#chkIsActive').val('Y');
                    } else if ( $('#chkIsActive').is(":unchecked") )
                        $('#chkIsActive').val('N'); {
                    }
                });

                var container = $('div.errorContainer');
                var validator = $("#form_CHGItemDetail").validate({
                    rules: { txtCode: "required",
                             txtCost: "required",  //txt01
                             txtDesc: "required"   //txt01 
                        },
                    messages: { txtCode: "Code cannot be blank.",
                                txtCost: "Cost cannot be blank.",
                                txtDesc: "Description cannot be blank."
                        },
                    errorContainer: container,
                    errorLabelContainer: $("ol", container),
                    wrapper: 'li'
                });

                $("#btnSave").click(function(){
                    if ( $(this).val() === 'Edit Detail') { 
                        appendCHGGroup();
                        enableEdit();
                    }
                    else if ( $(this).val() === 'Save') {  
                        //c01
                        //Aaron
                        //valid01
                        var $validItem = $("#form_CHGItemDetail").valid();
                        var $validPrice1 = doubleNum($("#txtPrice1").val());
                        var $validPrice2 = doubleNum($("#txtPrice2").val());
                        var $validPrice3 = doubleNum($("#txtPrice3").val());
                        var $validPrice4 = doubleNum($("#txtPrice4").val());
                        //valid02
                        var $validCost = doubleNum($("#txtCost").val());
                        //valid01
                        if ($validItem === true && $validPrice1 === true && $validPrice2 === true && $validPrice3 === true && $validPrice4 === true && $validCost === true ) {
                            document.getElementById("btnSave").disabled = true;
                            showYesNo({
                                title: "Confirmation needed",
                                width: 420,
                                noClose: true,
                                isModal: true,
                                body: [
                                                   "<br><h4>Please confirm all the details entered.<h4><br>"
                                ],
                                show: function(){},
                                Yes: {
                                    text: "Yes",
                                    opt: function(){
                                        $.ajax({
                                            type: "POST",
                                            url: "${pageContext.request.contextPath}/Servlet_ChargeItem?SFC=UPDATE_CHARGE_ITEM",
                                            data: { 
                                                IDX: sParam.IDX,
                                                CODE: $('#txtCode').val(),
                                                DESC: $('#txtDesc').val(),
                                                CHGGROUP: $('#ddlCHGGroup').val(),
                                                GSTCODE: $('#ddlGSTCode').val(),
                                                COST: $('#txtCost').val(),
                                                ISACTIVE: $('#chkIsActive').val(),
                                                PRICE1: $('#txtPrice1').val(),
                                                PRICE2: $('#txtPrice2').val(),
                                                PRICE3: $('#txtPrice3').val(),
                                                PRICE4: $('#txtPrice4').val(),
                                                ACCGROUP: $('#ddlACCGroup').val(),
                                                FUNCTION: 'EDIT'
                                            },
                                            dataType: 'json',
                                            //c01
                                            beforeSend: function(xhr){
                                                $.showLoadingNoStatus();
                                           },
                                            //c01
                                            success: function(response,xhr,status){
                                                if (response.bool === true) {
                                                    $.bigBoxSuccess({
                                                        title: "Updated Successfully.",
                                                        content: "",
                                                        timeout: 6000
                                                    });
                                                }
                                                else{
                                                    $.bigBoxFail({
                                                        title: "Updating Item FAIL.",
                                                        content: "There is some error during item update.<br> Please try again...",
                                                        timeout: 6000
                                                    });
                                                }
                                            },
                                            //c01
                                            error: function (xhr, status, error) {
                                                 $.bigBoxFail({
                                                    title: "Transaction ERROR",
                                                    content: "There is some error occur during data transfer. Please try again later",
                                                    timeout: 6000
                                                });
                                            },
                                            //c01
                                            complete: function (xhr, status) {
                                                if (xhr.status === 200) {
                                                    $.hideLoadingNoStatus(function () {
                                                       location.reload();
                                                    }, 500);
                                                } else {
                                                    $.hideLoadingNoStatus(function () {
                                                    }, 0);
                                                }
                                            }
                                        });
                                        hideYesNo();
                                    }
                                },
                                No: {
                                    text: "No",
                                    opt: function(){
                                        document.getElementById("btnSave").disabled = false;
                                        hideYesNo();
                                    }
                                }  
                            });
                        }
                        //valid01
                        else if ($validPrice1 === false || $validPrice2 === false || $validPrice3 === false || $validPrice4 === false){
                            $.bigBoxFail({
                                title: "Input Error",
                                content: "Please check the following inputs: <br> 1. Price 1<br>2. Price 2<br>3. Price 3<br>4. Price 4",
                                timeout: 6000
                            });
                        }
                        //valid02
                        else if ($validCost === false){
                            $.bigBoxFail({
                                title: "Input Error",
                                content: "Cost is valid up to 3 decimal places only...",
                                timeout: 6000
                            });
                        }
                    }
                });                               
            //c01
            }); 
        };      
        pagefunction();
        
        //valid01
    //accept number up to 3 decimal places only
    function doubleNum(num){
        var reg = /^[0-9]+(\.[0-9][0-9]?[0-9]?)?$/;
        if (num === ""){
            return true;
        }
        else{
            return reg.test(num);
        }
    }
    
        function appendCHGGroup() {
            $.ajax({
                type: "GET",
                url: "${pageContext.request.contextPath}/Servlet_PopulateData?SFC=GET_DLL",
                data: {
                    METHOD: "GET_CHGGROUP_CHGITEM",
                    P1: "CG"+sParam.CATEGORY,
                    P2: ""
                },
                dataType: 'json',
                success: function(data) {    
                    $("#ddlCHGGroup").empty();
                    $("#ddlCHGGroup").append($("<option>").val("").html("- Select Charge Group -"));
                    for(var i=0; i < data.length; i++){                                                          
                        $("#ddlCHGGroup").append($("<option>")
                            .val(data[i].VALUE)
                            .html(data[i].TEXT));
                    }  
                    $("#ddlCHGGroup").val(ci_cigroup);
                }
            });
            
//            $.ajax({
//                type: "GET",
//                url: "${pageContext.request.contextPath}/Servlet_PopulateData?SFC=GET_DLL",
//                data: {
//                    METHOD: "GET_CHGGROUP_CHGITEM",
//                    P1: "ACCGRP",
//                    P2: ""
//                },
//                dataType: 'json',
//                success: function(data) {    
//                    $("#ddlACCGroup").empty();
//                    $("#ddlACCGroup").append($("<option>").val("").html("- Select Account Group -"));
//                    for(var i=0; i < data.length; i++){                                                          
//                        $("#ddlACCGroup").append($("<option>")
//                            .val(data[i].VALUE)
//                            .html(data[i].TEXT));
//                    }  
//                    $("#ddlACCGroup").val(CI_CIREPORTGROUP);
//                }
//            });
        }
        
        function enableEdit() {
            $.showLoadingNoStatus();
                        
            document.getElementById('lblDesc').style.display = 'none';
            document.getElementById('txtDesc').style.display = '';

            document.getElementById('lblCHGGroup').style.display = 'none';
            document.getElementById('selectCHGGroup').style.display = '';

            
             document.getElementById('lblAccGroup').style.display = 'none';
            document.getElementById('selectACCGroup').style.display = '';

            document.getElementById('lblGSTCode').style.display = 'none';
            document.getElementById('selectGSTCode').style.display = '';

            document.getElementById('lblCost').style.display = 'none';
            document.getElementById('txtCost').style.display = '';

            document.getElementById('lblPrice1').style.display = 'none';
            document.getElementById('txtPrice1').style.display = '';
            
            document.getElementById('lblPrice2').style.display = 'none';
            document.getElementById('txtPrice2').style.display = '';

            document.getElementById('lblPrice3').style.display = 'none';
            document.getElementById('txtPrice3').style.display = '';

            document.getElementById('lblPrice4').style.display = 'none';
            document.getElementById('txtPrice4').style.display = '';        

            $('#chkIsActive').prop('disabled', false);
            $('#btnSave').val('Save');
            $.hideLoadingNoStatus();
        }
        
    }
        
</script>
