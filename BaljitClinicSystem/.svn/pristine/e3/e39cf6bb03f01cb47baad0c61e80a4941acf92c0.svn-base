<%@taglib prefix="jstl" uri="http://java.sun.com/jsp/jstl/core" %>
<jsp:useBean id="DDL" scope="page" class="BusinessLogic.Servlet_PopulateData" />
<jsp:useBean id="DDLXfer" scope="page" class="BusinessLogic.Servlet_Transfer" />
<style type="text/css">
    .ui-jqgrid tr.jqgrow td {
        word-wrap: break-word; /* IE 5.5+ CSS3 see http://www.w3.org/TR/css3-text/#text-wrap */
        white-space: pre-wrap; /* CSS3 */
        white-space: -moz-pre-wrap; /* Mozilla, since 1999 */
        white-space: -pre-wrap; /* Opera 4-6 */
        white-space: -o-pre-wrap; /* Opera 7 */
        overflow: hidden;
        height: auto;
        vertical-align: middle;
        padding-top: 3px;
        padding-bottom: 3px
    }   
    div.errorContainer, div.errorContainer2{
        display:none;
        width:100%;
    }
    div.errorContainer, div.errorContainer2 ol li{
        list-style-type:disc;
        margin-left: 20px;
    }
    li{
        list-style:none;
    }
    input[type="text"].error { border: 1px solid #A94444; background-color:#FFF0F0; }
    select.error { border: 1px solid #A94444; background-color:#FFF0F0; }
    textarea.error { border: 1px solid #A94444; background-color:#FFF0F0; }
</style>

<link rel="stylesheet" type="text/css" href="css/your_style.css" />
<link rel="stylesheet" type="text/css" href="js/plugin/jqgrid/ui.multiselect.css" />

<section id="widget-grid" class="">
    <!--<input type="text" id="lblUserCode" value="<%= session.getAttribute("s_usercode")%>"  class="tboxreadonlyShort"/>-->
    <div class="col-xs-12 col-sm-7 col-md-7 col-lg-4">
        <h1 class="page-title txt-color-blueDark">
            <!-- PAGE HEADER -->
            <i class="fa-fw fa fa-file fa-2x"></i> 
            New Stock Return
        </h1>
    </div>
    <div class="row">
        <form id='form_RetAdd'>
        <article class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
            <div class="row" style="padding-bottom:10px;padding-left:10px;padding-right:10px;">
                <div class="errorContainer alert alert-danger alert-block">
                    <h4 class="alert-heading">There were some field left out or invalid inputs. Please brief through the form and reenter necessarily.</h4>
                    <ol>
                    </ol>
                </div>
            </div>
            
            <table id="tblSearch" >
                    <tr>
                        
                                        
                        <!-- -->
                        <td width="25px"></td>
                        <td width="100px">Company:<font color="red" size="3">*</font></td>
                        <td>          
                            
                            <label id="selectCompany" class="searchbox">
                            <select class="form-control" id="ddlComp" name="ddlComp" rel="popover-hover" data-original-title="Company" data-content="Select Company." style="width:200px;">
                                <option value="">- Select Company -</option>
                                <jstl:forEach var="ddl_Comp" items="${DDL.ddlGet('GET_COMP','','',sessionScope.SiteName)}">
                                    <option value="${ddl_Comp.VALUE}">${ddl_Comp.VALUE} - ${ddl_Comp.TEXT}</option>
                                </jstl:forEach>     
                            </select>    
                            </label>
                            
                            <input type="text" id="lblcompany" name="lblcompany" class="form-control" style="width:200px;display:none;" readonly />
                            
                        </td>
                        <td width="50px"></td>                
                        <td width="100px">Location:<font color="red" size="3">*</font></td>
                        <td>              
                            
                            <label id="selectLocation" class="searchbox">
                            <select class="form-control" id="ddlLoc" name="ddlLoc" rel="popover-hover" data-original-title="Location" data-content="Select Location." style="width:250px;cursor:default;">
                                <option value="">- Select Location -</option>
                            </select>    
                            </label>
                            
                            <input type="text" id="lbllocation" name="lbllocation" class="form-control" style="width:200px;display:none" readonly />
                        </td> 
                        <td width="400px">
                            <input type='text' class='form-control' ID='txtdisclaim' name='txtdisclaim' value="Cannot change issuing location when there's item selected." disabled="true" style="border: none; visibility: hidden;"/>
                            
                        </td>
                    </tr>
                   
                                    
            </table>
            
            <br>
            <div class="jarviswidget jarviswidget-color-blueDark" id="wid-id-2"  data-widget-editbutton="false" data-widget-colorbutton="false" data-widget-fullscreenbutton="false" data-widget-custombutton="false" data-widget-deletebutton="false">
                <header>
                    <span class="widget-icon"> <i class="fa fa-search"></i></span>
                    <span><h2>&nbsp;Locate Product</h2></span>
                </header>
                <div class="no-padding">
                    <div class="widget-body">
                        <div id="selectCriTab" class="tab-content">
                            <div class="tab-pane fade active in padding-5 no-padding-bottom" id="selectCriTab_s1">
                                <table id="tblSearch" class="selection-criteria">

                                    <tr>
                                        <td>Product Code:</td>
                                        <td>   
                                            <div style="float:left;">
                                                <input type="text" id="txtPrdCode" name="txtPrdCode"  placeholder="--Enter Product Code--" class="searchbox-text" style="width:200px;"/>
                                            </div>
                                            <div style="float:left;padding-left:2px">
                                                <button class='btn btn-default bg-color-blueDark txt-color-white' type="button" onclick="ProductLookup();" ><i class="fa fa-search fa-lg"></i></button>
                                            </div>
                                        </td>
                                        <td>Product Group:</td>
                                        <td>                                            
                                            <label id="selectPrdGrp" class="searchbox">
                                            <select class="form-control" id="ddlPrdGrp" name="ddlPrdGrp" rel="popover-hover" data-original-title="Product Group" data-content="Select Product Group." style="width:250px;">
                                                <option value="">- Select Product Group -</option>    
                                                <jstl:forEach var="ddl_PrdGrp" items="${DDL.ddlGet('GET_CODEDESC', 'STKGRP', '', sessionScope.SiteName)}">
                                                    <option value="${ddl_PrdGrp.VALUE}">${ddl_PrdGrp.TEXT}</option>
                                                </jstl:forEach>                                             
                                            </select>    
                                            </label>
                                        </td>
                                    </tr>                                     
                                    <tr>
                                        <td>Product Description:</td>
                                        <td>                                            
                                            <input type="text" id="txtPrdDesc" name="txtPrdDesc"  placeholder="--Enter Product Description--" class="searchbox-text" style="width:250px;"/>
                                        </td>
                                        <td>Product Type:</td>
                                        <td>                                            
                                            <label id="selectPrdType" class="searchbox">
                                            <select class="form-control" id="ddlPrdType" name="ddlPrdType" rel="popover-hover" data-original-title="Product Type" data-content="Select Product Type." style="width:250px;">
                                                <option value="">- Select Product Type -</option>
                                                <jstl:forEach var="ddl_PrdType" items="${DDL.ddlGet('GET_CODEDESC', 'STKTYP', '', sessionScope.SiteName)}">
                                                    <option value="${ddl_PrdType.VALUE}">${ddl_PrdType.TEXT}</option>
                                                </jstl:forEach>                       
                                            </select>    
                                            </label>
                                        </td>                                     
                                    </tr>                                     
                                    <tr>
                                        <td colspan="6">
                                            <div id="rdPrdCat">       
                                                <input type="radio" id="rdPrdCat1" name="rdPrdCat"  value="" checked="checked" /><label for="rdPrdCat1" class="label-option btn">All</label>
                                                <input type="radio" id="rdPrdCat2" name="rdPrdCat" value="0"/><label for="rdPrdCat2" class="label-option btn">Medication</label>
                                                <input type="radio" id="rdPrdCat3" name="rdPrdCat" value="1"/><label for="rdPrdCat3" class="label-option btn">Product</label>
                                                <input type="radio" id="rdPrdCat4" name="rdPrdCat" value="2"/><label for="rdPrdCat4" class="label-option btn">Consumable</label>
                                            </div>
                                        </td>
                                        <td colspan="1">
                                            <div style="align:left; float:left;padding-right: 10px" >
                                                <input type="submit" Id="btnSearch"  class="btn btn-default bg-color-blueDark txt-color-white"  value="Retrieve" onclick="Retrieve_Prd_CostQty_List();" />
                                            </div>                                            
                                            <div style="align:left; float:left; padding-right: 10px" >
                                                <input type="submit" Id="btnClear"  class="btn btn-default bg-color-blueDark txt-color-white"  value="Clear" onclick="ResetSearchFields();" />
                                            </div>                                        
                                        </td>                                    
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
                                                           
            <div class="jarviswidget jarviswidget-color-blueDark" id="wid-id-1"  data-widget-editbutton="false" data-widget-custombutton="false" data-widget-deletebutton="false">              
                <header>
                    <span class="widget-icon"> <i class="fa fa-file"></i></span>
                    <span><h2>&nbsp;Product List</h2></span>
                </header>  
                <div>
                    <!-- widget edit box -->
                    <div class="jarviswidget-editbox">
                        <!-- This area used as dropdown edit box -->                        
                    </div>
                    <!-- end widget edit box -->

                    <!-- widget content -->
                    <div class="widget-body">
<!--                    <input type="button" href="#myModal" data-toggle="modal" value="Print Reports" class="btn btn-default bg-color-blueDark txt-color-white" />&nbsp;
                        <input type="button" id="btnMemExport" name="btnCorpExport" onclick='ExportData()' value="Export"  class="btn btn-default bg-color-blueDark txt-color-white"  style="margin-right:20px;"/>-->
                                 
                        <div class="table-responsive">
                            <div id="cjqgridPrdList"></div>
                            <table id="jqgridPrdList" class="table table-striped table-bordered"  ></table>
                            <div id="pjqgridPrdList"></div>
                        </div>

                        <!-- DESPATCH DETAILS -->
                        <br>
                        <div class="jarviswidget jarviswidget-color-blueDark" id="wid-id-1" data-widget-editbutton="false" data-widget-deletebutton="false" data-widget-colorbutton="false" data-widget-fullscreenbutton="false" data-widget-togglebutton="false">
                            <header>
                                <h2>Selected Product</h2>
                            </header>
                            <div class="container">
                                <div class="row">
                                    <div id="cjqgridSubmitDetail" class="jqgrid-table-nopadding">
                                        <table id="jqgridSubmitDetail" class="table table-striped" ></table>
                                        <div id="sourceDetail">  
                                         
                                            <table id="tblSource" class="selection-criteria">  
                                                <tr>
                                                    
                                                    <td width="38%">   
                                                        <input type="button" Id="btnAddSelected" onclick="AddSelectedItems();"  class="btn btn-default bg-color-blueDark txt-color-white" value="Add Selected Items" />                                       
                                                    </td>
                                                     
                                                    <td width="8%">Issuing Company:</td>
                                                    <td>   
                                                        <input type='text' class='form-control' ID='txtisscompany' name='txtisscompany' style='width:100px' readonly/>                                         
                                                    </td>
                                                    <td width="8%">Issuing Location:</td>
                                                    <td width="22%">                                            
                                                        <div style="float:left;padding-left:10px">
                                                            <input type='text' class='form-control' ID='txtisslocation' name='txtisslocation' style='width:100px' readonly/>        
                                                        </div>
                                                    </td>
                                                    
                                                    <td width="8%">Receiving Location:</td>
                                                    <td width="22%">                                            
                                                        <div style="float:left;padding-left:10px">                                                                                                                   
                                                        
                                                        <label id="selectLocation" class="searchbox">
                                                        <select class="form-control" id="ddlRecvLoc" name="ddlRecvLoc" rel="popover-hover" data-original-title="Location" data-content="Select Location." style="width:250px;cursor:default;">
                                                            <option value="">- Select Location -</option>
                                                        </select>    
                                                        </label>
                                                        
                                                        </div>
                                                    </td>
                                                    <td width="60%"></td> 
                                                 
                                                    
                                                    
                                                    
                                                </tr>
                                            </table>
                                                <table id="tblSource" class="selection-criteria">  
                                                <tr>
                                                    <td width="20%">Return By:</td>
                                                    <td width="22%">   
                                                        <input type='text' class='form-control' ID='txtPersonName' name='txtPersonName' style='width:200px'/>                                         
                                                    </td>
                                                    <td width="8%">Remarks:</td>
                                                    <td width="22%">                                            
                                                        <div style="float:left;padding-left:10px">
                                                            <input type='text' class='form-control' ID='txtRemarks' name='txtRemarks' style='width:600px'/>        
                                                        </div>
                                                    </td>
                                                    <td width="40%"></td>
                                                </tr>                                    
                                            </table>                                                                                                                                                          
                                        </div>
                                        <div class="table-responsive">                                        
                                            <div id="gridItemSummary" class="">                              
                                                <table class="table table-striped" id="tbItem" >
                                                    <thead>
                                                        <th id="idx"> </th> 
                                                        <th id="lblRemove">Remove</th>                                            
                                                        <th id="lblPrdCode">Product</th>                                        
                                                        <th id="lblBatchNo">Batch#</th>
                                                        <th id="lblExpiryDate">Expiry Date</th>
                                                        <th id="lblUnitCost">Unit Cost</th>
                                                        <th id="lblUOMCode">UOM</th>
                                                        <th id="lblQty">Qty</th>
                                                        <th id="lblReturnQty">Return Qty</th>                                  
                                                    </thead>
                                                    <tbody id="ItemGrid" >
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div>
                                                <div class="row">
                                                    <div class="col-sm-12">
                                                        <div align="left" class="padding-5" >                                          
                                                            <input type="button" Id="btnDeleteAll"  class="btn btn-default bg-color-blueDark txt-color-white" value="Delete All" style=" width: 80px;" onclick='DeleteAllRows()' />                                          
                                                        </div>                                      
                                                        <div align="Right" class="padding-5" >                                           
                                                            <input type="button" Id="btnConfirm"  class="btn btn-default bg-color-blueDark txt-color-white" value="Confirm" style=" width: 80px;" />
                                                            <input type="button" Id="btnClose"  class="btn btn-default bg-color-blueDark txt-color-white" value="Close" style=" width: 80px;" onclick="location.href = '#/StockReturnList'" />
                                                        </div>                                      
                                                    </div>
                                                </div>
                                            </div>    
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>          
                        <!-- DESPATCH DETAILS -->
                        
                        <div style=" display: none;">
                            <table id="ExportPrdMaster" class="table table-striped table-bordered" ></table>
                        </div>
                    </div>
                    <!-- end widget content -->
                </div>
            </div>                                                                                                                                            
        </article>                                                
        <div hidden>            
            <input type="hidden" id="hidRetItems" name="hidRetItems"/>
        </div>
        </form>                             
    </div>
</section>                                                   
<jsp:include page="../../../includes/loading-no-status.jsp"/>  
<jsp:include page="../../../includes/PopUpInitPage.jsp"/>
<jsp:include page="../../../includes/yes-no.jsp"/>
<script src="js/buttonset.js"></script>
<script type="text/javascript">
   
   var CurrentStkCode = "";
   var CurrentCompCode = "";
   var CurrentLocCode = "";
   var IssueLocSelected = false;
   var CurrentConvUOM = "";
   var CurrLocationLst = {};
   var CurrentAllocation = {};
   var LocationFirstTimeRefreshed = false;
   var CurrLocationGrid = {};
   var TotalAllocation = 0;
   
    pageSetUp();
    $('#rdPrdCat').buttonset();
    
    $().ready(function(){
        $("#ddlLoc").prop("disabled", true);
        $("#wid-id-1").hide();
        
        var container = $('div.errorContainer');
        var validator = $("#form_RetAdd").validate({
            rules: { 
                ddlComp: "required",
                ddlLoc: "required" 
            },
            messages: { 
                ddlComp: "Company & Location must be selected.",
                ddlLoc: "Location must be selected."
            },
            onclick: false,
            onfocusout: false,
            errorContainer: container,
            errorLabelContainer: $("ol", container),
            wrapper: 'li'
        });
    });
    
//    $("#ddlComp").change(function(){ddlcomp_onchange();});
     $("#ddlComp").on('change',ddlcomp_onchange); 
//     $("#txtisscompany").on('change',ddlrecvcomp_onchange); 
     
     
//    $("#ddlComp").change(function(){
//        $('#ddlLoc').empty();       
//        var sCompany = this.value;   
//        if (sCompany !== "") {  
//            $.ajax({
//                type: "GET",
//                url: "${pageContext.request.contextPath}/Servlet_Stock?SFC=GET_REL_LOCATION",
//                data: {
//                    COMPANY: sCompany
//                },
//                dataType: 'json',
//                success: function(data) {
//                    $("select#ddlLoc").append( $("<option>").val("").html("- Select Location -"));  
//                    for (var a=0 ; a<data.object1.length ; a++) {                   
//                        var arrData = data.object1[a];                
//                        $("select#ddlLoc").append( $("<option>")
//                            .val(arrData.VALUE)
//                            .html(arrData.VALUE + " - " + arrData.TEXT)
//                        ); 
//                    }
//                }
//            });                                                           
//            $("#ddlLoc").prop("disabled", false);
//        } else {
//            $("select#ddlLoc").append( $("<option>").val("").html("- Select Location -"));
//            $("#ddlLoc").prop("disabled", true);
//        }
//    });

        function ddlcomp_onchange(){
            
//            alert("entered");
        $('#ddlLoc').empty();       
        //var sCompany = this.value;   
        var sCompany = $('#ddlComp').val();   
        if (sCompany !== "") {  
            $.ajax({
                type: "GET",
                //url: "${pageContext.request.contextPath}/Servlet_Stock?SFC=GET_REL_LOCATION",
                url: "${pageContext.request.contextPath}/Servlet_Location?SFC=GET_NONMAINSTORE_LOCATION",
                data: {
                    COMPANY: sCompany
                },
                dataType: 'json',
                success: function(data) {
                    $("select#ddlLoc").append( $("<option>").val("").html("- Select Location -"));  
                    for (var a=0 ; a<data.object1.length ; a++) {                   
                        var arrData = data.object1[a];
                        
                       
                        $("select#ddlLoc").append( $("<option>")
//                            .val(arrData.VALUE)
//                            .html(arrData.VALUE + " - " + arrData.TEXT)
                            .val(arrData.loc_code)
                            .html(arrData.loc_code + " - " + arrData.loc_name)
                        ); 
                        
                    }
                }
            });                                                           
            $("#ddlLoc").prop("disabled", false);
        } else {
            $("select#ddlLoc").append( $("<option>").val("").html("- Select Location -"));
            $("#ddlLoc").prop("disabled", true);
        }
    }
    
    function ddlrecvcomp_onchange(){
        $('#ddlRecvLoc').empty();       
        //var sCompany = this.value;   
        var sCompany = CurrentCompCode;  
//        alert(CurrentCompCode);
        if (sCompany !== "") {  
            $.ajax({
                type: "GET",
                url: "${pageContext.request.contextPath}/Servlet_Location?SFC=GET_MAINSTORE_LOCATION",
                data: {
                    COMPANY: sCompany
                },
                dataType: 'json',
                success: function(data) {
                    $("select#ddlRecvLoc").append( $("<option>").val("").html("- Select Location -"));  
                    for (var a=0 ; a<data.object1.length ; a++) {                   
                        var arrData = data.object1[a];                
                        $("select#ddlRecvLoc").append( $("<option>")
                            .val(arrData.loc_code)
                            .html(arrData.loc_code + " - " + arrData.loc_name)
                        ); 
                    }
                }
            });                                                           
            $("#ddlRecvLoc").prop("disabled", false);
        } else {
            $("select#ddlRecvLoc").append( $("<option>").val("").html("- Select Location -"));
            $("#ddlRecvLoc").prop("disabled", true);
        }
    }

    var pagefunction = function () {       
        loadScript("js/plugin/jqgrid/ui.multiselect.js", function () {
            loadScript("js/plugin/jqgrid/grid.locale-en.min.js", function () {
                loadScript("js/plugin/jqgrid/jquery.jqGrid.min.js", function () {
                    loadScript("js/column-chooser.js", function () {
                        run_jqgrid_function();
                    });
                });
            });
        });

        function run_jqgrid_function() {
            
            var grid = $("#jqgridPrdList"),
                gridPager = "#p" + grid.selector.toString().substring(1),
                conDiv = $("#c" + grid.selector.toString().substring(1)),
                defaultColName =  ['Product Code','Product','Category','Group','Type','Batch#','Expiry Date','Unit Cost','UOM','Qty','CostQtyIdx'],
                defaultColMol = [                   
                    //{name: 'details', index: 'details',  search: false, sortable: false, width: 120, align:'center',must: true, hidedlg: true},                    
                    {name:'StkCode', index:'StkCode', sortable:true, must:true, hidedlg:true, width:100},
                    {name:'StkDesc', index:'StkDesc', sortable:true, width:220},
                    {name:'StkCat', index:'StkCat', sortable:true, width:90},
                    {name:'StkGrp', index:'StkGrp', sortable:true, width:80},
                    {name:'StkType', index:'StkType', sortable:true, width:80},
                    {name:'BatchNo', index:'BatchNo', sortable:true, width:80},
                    {name:'ExpiryDate', index:'ExpiryDate', sortable:true, width:80},
                    {name:'UnitCost', index:'UnitCost', sortable:true, width:60},
                    {name:'UOMCode', index:'UOMCode', sortable:true, width:70},
                    {name:'Qty', index:'Qty', sortable:true, must:true, hidedlg:true, width:60},
                    {name:'Idx', index:'Idx', hidden:true, sortable:true, width:220}
                ],             
                mainGridName = grid.selector.toString().substring(1),
                //temp = readSettings({settingArray:${sessionScope.settings}, defaultColName: defaultColName, defaultColMol: defaultColMol, settingName: mainGridName});//,
                temp = readSettings({settingArray:"admin", defaultColName: defaultColName, defaultColMol: defaultColMol, settingName: mainGridName}),
                currentColName = temp[0],
                currentColMol = temp[1];
                // alert(JSON.stringify(temp));
            grid.jqGrid({
                url: '${pageContext.request.contextPath}/Servlet_StockReturn',
                postData: {
                    SFC: 'GET_PRD_COSTQTY_LIST',     
                    COMPANY: $('#ddlComp').val(),
                    LOCATION: $('#ddlLoc').val(),
                    PRDCODE: $('#txtPrdCode').val(),
                    PRDDESC: $('#txtPrdDesc').val(),
                    PRDGRP: $('#ddlPrdGrp').val(),
                    PRDTYPE: $('#ddlPrdType').val(),
                    PRDCAT: $('input[name=rdPrdCat]:checked').val(),
                    STOCKCODE: '@@'                       
                },
                datatype: "json",
                mtype: 'POST',
                colNames: currentColName,
                colModel: currentColMol,
                gridview: true,
                rownumWidth: 40,
                rowNum: 20,
                rowList: [10, 20, 25, 30, 50, 100],
                pager: gridPager,
                sortname: '',
                viewrecords: true,
                sortorder: '',
                toolbarfilter: true,
                autowidth: true,
                shrinkToFit: true,
                loadonce: false,
                height: 'auto',
                scrollerbar: false,  
                //subGrid: true,
                rownumbers: true,
                celledit: true,
                multiselect:true,
                async: true,
                sortable: {
                    update: function (relativeColumnOrder) {
                        //sortColumn({settingArray:${sessionScope.settings}, order: relativeColumnOrder, grid: grid, defaultColMol: defaultColMol, settingName: mainGridName});
                        sortColumn({settingArray:"admin", order: relativeColumnOrder, grid: grid, defaultColMol: defaultColMol, settingName: mainGridName});
                    }
                },
                loadComplete: function () {
                    var iLastPage = parseInt($(this).getGridParam('lastpage'));
                    $(".ui-jqgrid .ui-pg-input").keydown(function (e) {
                        this.value = this.value.replace(/\D/g, '');
                        var code = e.keyCode || e.which;
                        if (code === 13) {
                            if (this.value > iLastPage) {
                                this.value = iLastPage;
                            } else if (this.value <= 0) {
                                this.value = 1;
                            }
                        }
                    });
                }
            });        
//          function viewDetail(cellvalue, options, rowObject) {
//              //return "<a  target='_self' class='btn btn-default bg-color-blueDark txt-color-white' title='Member Detail' href='#/MemberDetail/" + rowObject.MEM_ID + "/" + rowObject.MEM_CorpCode + "'>View Details</a>";
//              return"<a style='cursor: pointer;' title='View Details' href='#/ProductDetail/" + rowObject.stk_stockcode +  "'><i class='fa fa-fw fa-lg fa-list-alt' /></a>";
//               
//           }
            // remove classes
            $(".ui-jqgrid").removeClass("ui-widget ui-widget-content");
            $(".ui-jqgrid-view").children().removeClass("ui-widget-header ui-state-default");
            $(".ui-jqgrid-labels, .ui-search-toolbar").children().removeClass("ui-state-default ui-th-column ui-th-ltr");
            $(".ui-jqgrid-pager").removeClass("ui-state-default");
            $(".ui-jqgrid").removeClass("ui-widget-content");
            // add classes
            $(".ui-jqgrid-htable").addClass("table table-bordered table-hover");
            $(".ui-jqgrid-btable").addClass("table table-bordered table-striped");
            $(".ui-pg-div").removeClass().addClass("btn btn-sm btn-primary");
            $(".ui-icon.ui-icon-plus").removeClass().addClass("fa fa-plus");
            $(".ui-icon.ui-icon-pencil").removeClass().addClass("fa fa-pencil");
            $(".ui-icon.ui-icon-trash").removeClass().addClass("fa fa-trash-o");
            $(".ui-icon.ui-icon-search").removeClass().addClass("fa fa-search");
            $(".ui-icon.ui-icon-refresh").removeClass().addClass("fa fa-refresh");
            $(".ui-icon.ui-icon-disk").removeClass().addClass("fa fa-save").parent(".btn-primary").removeClass("btn-primary").addClass("btn-success");
            $(".ui-icon.ui-icon-cancel").removeClass().addClass("fa fa-times").parent(".btn-primary").removeClass("btn-primary").addClass("btn-danger");
            $(".ui-icon.ui-icon-seek-prev").wrap("<div class='btn btn-sm btn-default'></div>");
            $(".ui-icon.ui-icon-seek-prev").removeClass().addClass("fa fa-backward");
            $(".ui-icon.ui-icon-seek-first").wrap("<div class='btn btn-sm btn-default'></div>");
            $(".ui-icon.ui-icon-seek-first").removeClass().addClass("fa fa-fast-backward");
            $(".ui-icon.ui-icon-seek-next").wrap("<div class='btn btn-sm btn-default'></div>");
            $(".ui-icon.ui-icon-seek-next").removeClass().addClass("fa fa-forward");
            $(".ui-icon.ui-icon-seek-end").wrap("<div class='btn btn-sm btn-default'></div>");
            $(".ui-icon.ui-icon-seek-end").removeClass().addClass("fa fa-fast-forward");
            $(".ui-pg-input").addClass("pg-input");

            // resize
            $(window).on('resize', function () {
                grid.jqGrid('setGridWidth', conDiv.width());
            });
            grid.on('myRefresh', function () {
                resizeWidth({grid: grid, gridDiv: conDiv});
            });
            // quickSetupChooser({grid: grid, defaultColMol: defaultColMol, settingName: mainGridName,
            // settingArray:${sessionScope.settings},
            quickSetupChooser({grid: grid, defaultColMol: defaultColMol, settingName: mainGridName,
                settingArray:"admin",
                done: function () {
                    resizeWidth({grid: grid, gridDiv: conDiv});
                }
            });
            grid.jqGrid('setGridWidth', conDiv.width());                
        };
    }; //end of pagefunction

    function ResetSearchFields() { 
        $('#txtPrdCode').val('');
        $('#txtPrdDesc').val('');
        $('#ddlPrdGrp').val('');
        $('#ddlPrdType').val('');              
    }
    
    function Retrieve_Prd_CostQty_List() {
        
//        if ($('#ddlComp').val() === null || $('#ddlLoc').val() === null)
//        {
//            ddlcomp_onchange();
//                $('#ddlLoc').val(CurrentLocCode);
//                alert("Please select a valid location");
//                alert(CurrentLocCode);
//
//            return;
//        }
//        if ($('#ddlComp').val()=== '' || $('#ddlLoc').val() === '')
//        {
//            $.bigBoxWarning({
//                title: "Stock Return.",
//                content: "Please select a valid location",
//                timeout: 3000
//            });
//            return;
//        }
        var $validItem = $("#form_RetAdd").valid();
        if ($validItem === true) { 
            $("#wid-id-1").show();
            if (IssueLocSelected)
            {
                $("#jqgridPrdList").jqGrid('setGridParam', {
                    postData: {
                        SFC: 'GET_PRD_COSTQTY_LIST',     
                        COMPANY: CurrentCompCode,
                        LOCATION: CurrentLocCode,
                        PRDCODE: $('#txtPrdCode').val(),
                        PRDDESC: $('#txtPrdDesc').val(),
                        PRDGRP: $('#ddlPrdGrp').val(),
                        PRDTYPE: $('#ddlPrdType').val(),
                        PRDCAT: $('input[name=rdPrdCat]:checked').val()
                    }
                }).trigger("reloadGrid", [{page: 1}]);
            }
            else
            {
                $("#jqgridPrdList").jqGrid('setGridParam', {
                    postData: {
                        SFC: 'GET_PRD_COSTQTY_LIST',     
                        COMPANY: $('#ddlComp').val(),
                        LOCATION: $('#ddlLoc').val(),
                        PRDCODE: $('#txtPrdCode').val(),
                        PRDDESC: $('#txtPrdDesc').val(),
                        PRDGRP: $('#ddlPrdGrp').val(),
                        PRDTYPE: $('#ddlPrdType').val(),
                        PRDCAT: $('input[name=rdPrdCat]:checked').val()
                    }
                }).trigger("reloadGrid", [{page: 1}]);

    //alert($('#ddlLoc').val());            
                CurrentCompCode = $('#ddlComp').val();
                CurrentLocCode = $('#ddlLoc').val();
            }
            
        }
        
      
    }
  
    loadScript("js/plugin/jqgrid/grid.locale-en.min.js", function () {
        loadScript("js/buttonset.js", function () {
            loadScript("js/excel-export.js", function () {            
                pagefunction();
            });
        });
    });
    pageSetUp();
    
    function ProductLookup() {      
        showProduct({width: 800, height: 600}).done(function (rowIn) {
            //alert(JSON.stringify(rowIn));
           // $("#txtPrdDesc").val(rowIn.stk_desc);
            $("#txtPrdCode").val(rowIn.stk_stockcode);
        });
    }
      
      
      
    var curRow = 0;
    function AddSelectedItems()
    {
       
//        if (CurrentCompCode === null || CurrentLocCode === null) {
//            $.bigBoxWarning({
//                title: "Stock Return.",
//                content: "Please select a valid location",
//                timeout: 3000
//            });
//            return;
//        }        
//        if (CurrentCompCode === '' || CurrentLocCode === '') {
//            $.bigBoxWarning({
//                title: "Stock Return.",
//                content: "Please select a valid location",
//                timeout: 3000
//            });
//            return;
//        }        
     
        
        var grid = $('#jqgridPrdList');
        var ids = grid.jqGrid('getGridParam','selarrrow');
        
        for (var i=0, il = ids.length; i < il; i++)
        {
            var SCQIdx = grid.jqGrid('getCell', ids[i], 'Idx');
            var StkCode = grid.jqGrid('getCell', ids[i], 'StkCode');
            var BatchNo = grid.jqGrid('getCell', ids[i], 'BatchNo');
            var ExpiryDate = grid.jqGrid('getCell', ids[i], 'ExpiryDate');
            var UnitCost = grid.jqGrid('getCell', ids[i], 'UnitCost');
            var UOM = grid.jqGrid('getCell', ids[i], 'UOMCode');
            var Qty = grid.jqGrid('getCell', ids[i], 'Qty');
            
            //alert ($("input[value='" + SCQIdx + "']","#tbItem").val());        
            if ($("input[value='" + SCQIdx + "']","#tbItem").val() === SCQIdx) 
            {               
                $.bigBoxWarning({
                    title: "Item Selection.",
                    content: "Some items have already been selected previously.",
                    timeout: 3000
                });
            } 
            else 
            {               
                $("#tbItem tbody").append("<tr id=tr" + curRow + ">" +
                    "<td><input type='hidden' class='form-control'ID='hidSCQIdx" + curRow + "' name='hidSCQIdx" + curRow + "' /></td>" +    
                    "<td><input type='submit' class='btn btn-default bg-color-blueDark txt-color-white' ID='btnRemove" + curRow + "' name='btnRemove" + curRow + "' value='Delete' style='width:100px' onclick='DeleteRow(event)' /></td>" +    
                    "<td><input type='text' class='form-control' readonly ID='txtStkCode" + curRow + "' name='txtStkCode" + curRow + "' style='width:100px' /></td>" +
                    "<td><input type='text' class='form-control' readonly ID='txtBatchNo" + curRow + "' name='txtBatchNo" + curRow + "' style='width:100px' /></td>" +
                    "<td><input type='text' class='form-control' readonly ID='txtExpiryDate" + curRow + "' name='txtExpiryDate" + curRow + "' style='width:100px' /></td>" +
                    "<td><input type='text' class='form-control' readonly ID='txtUnitCost" + curRow + "' name='txtUnitCost" + curRow + "' style='width:100px' /></td>" +
                    "<td><input type='text' class='form-control' readonly ID='txtUOMCode" + curRow + "' name='txtUOMCode" + curRow + "' style='width:100px' value='' /></td>" +
                    "<td><input type='text' class='form-control' readonly ID='txtQty" + curRow + "' name='txtQty" + curRow + "' style='width:100px' value='0' /></td>" +
                    "<td><input type='text' class='form-control' ID='txtReturnQty" + curRow + "' name='txtReturnQty" + curRow + "' style='width:100px' value='0' /></td>" +
                    "</tr>"
                );           
                $("#hidSCQIdx"+ curRow).val(SCQIdx);
                $("#txtStkCode"+ curRow).val(StkCode);
                $("#txtBatchNo"+ curRow).val(BatchNo);
                $("#txtExpiryDate"+ curRow).val(ExpiryDate);
                $("#txtUnitCost"+ curRow).val(UnitCost);
                $("#txtUOMCode"+ curRow).val(UOM);
                $("#txtQty"+ curRow).val(Qty);
                $("#txtReturnQty"+ curRow).val('0');

                curRow = curRow + 1; 
            }            
        }
        $("#jqgridPrdList").jqGrid('resetSelection');
//        $( "#ddlComp" ).off('change'); 
//        $('#ddlComp').val(CurrentCompCode);
//        ddlcomp_onchange();
//        $('#ddlLoc').val(CurrentLocCode);
        CheckIssueLocation();
//        $("#ddlComp").on('change',ddlcomp_onchange); 

 
        
        
       




        
    }
    
    function CheckIssueLocation()
    {
        var rowCount = $('#tbItem tbody tr').length;
        if (rowCount > 0)
        {            
//            $("#ddlComp").prop('disabled', true);
//            $("#ddlLoc").prop('disabled', true);
            
            $("#ddlComp").css("visibility","hidden");
            $("#ddlLoc").css("visibility","hidden");
            $("#lblcompany").css("visibility","visible");
            $("#lbllocation").css("visibility","visible");
            
            $('#txtdisclaim').css("visibility","visible");
        
            var iIssCompChanged = false;
            if ($("#txtisscompany").val() != CurrentCompCode)
            {
                iIssCompChanged = true;
            }
            $("#txtisscompany").val(CurrentCompCode);
            $("#txtisslocation").val(CurrentLocCode);
            $("#lblcompany").val(CurrentCompCode);
            $("#lbllocation").val(CurrentLocCode);
            document.getElementById('ddlComp').style.display = 'none';
            document.getElementById('lblcompany').style.display = '';
            
            document.getElementById('ddlLoc').style.display = 'none';
            document.getElementById('lbllocation').style.display = '';
            IssueLocSelected = true;
            if (iIssCompChanged)
            {
                ddlrecvcomp_onchange();
            }
        }
        else
        {
//            $("#ddlComp").prop('disabled', false);
//            $("#ddlLoc").prop('disabled', false);
            
            $("#ddlComp").css("visibility","visible");
            $("#ddlLoc").css("visibility","visible");
            $("#lblcompany").css("visibility","hidden");
            $("#lbllocation").css("visibility","hidden");
            
            $("#txtisscompany").val("");
            $("#txtisslocation").val("");
            $('#txtdisclaim').css("visibility","hidden");
           
            document.getElementById('ddlComp').style.display = '';
            document.getElementById('lblcompany').style.display = 'none';
            
            document.getElementById('ddlLoc').style.display = '';
            document.getElementById('lbllocation').style.display = 'none';
            IssueLocSelected = false;
            $('#ddlRecvLoc').empty(); 
        }
        
        //alert(rowCount);
    }
    function DeleteRow(e)
    {
      $('table#tbItem tr#tr' + e.target.id.substring(9)).remove();
      CheckIssueLocation();
    }
   
    function DeleteAllRows()
    {
      $('table#tbItem tbody tr').remove();
      CheckIssueLocation();
    }
       
    $("#btnConfirm").click(function () {       

        var bValidate = true;
        var rowCount = $('#tbItem tr').length; 
        if (rowCount === 1) {
            $.bigBoxWarning({
                title: "Stock Return.",
                content: "Please select item for Return.<br> Please try again...",
                timeout: 3000
            });
            return;
        }
        
        
        if ($('#ddlRecvLoc').val() === '' || $('ddlRecvLoc').val() === null) {
            $.bigBoxWarning({
                title: "Stock Return.",
                content: "Receiving Location cannot be blank.<br> Please try again...",
                timeout: 3000
            });
            return;
        }
        
        if ($('#txtPersonName').val() === '' || $('txtRemarks').val() === '') {
            $.bigBoxWarning({
                title: "Stock Return.",
                content: "Return Person's Name and Remarks fields cannot be blank.<br> Please try again...",
                timeout: 3000
            });
            return;
        }        
        
        $('#tbItem tr').each(function (row, th) {           
            if (row > 0) {                
                var rowid = $(this).closest('tr').attr('id');
                var rowno = rowid.substring(2);
                var returnQty = $('#txtReturnQty' + rowno).val(); 
                if (returnQty === '0') {
                    bValidate = false;
                    $.bigBoxWarning({
                        title: "Stock Return.",
                        content: "Return Quantity must be entered.<br> Please try again...",
                        timeout: 3000
                    });
                    return;
                }
            }
        });
        
        if (bValidate) {
            document.getElementById("btnConfirm").disabled = true;
         showYesNo({
            title: "Stock Return...",
            width: 420,
            noClose: true,
            isModal: true,
            body: [
                "<br><h4>Are you sure to proceed to stock return?<h4><br>"
            ],
            show: function () {
            },
            Yes: {
                 text: "Yes",
                opt: function () {           
            var RetItem = new Array();
            var rowRetItem = 0;
            $('#tbItem tr').each(function (row, th) {                
                if (row > 0) {                
                    var rowid = $(this).closest('tr').attr('id');
                    var rowno = rowid.substring(2);

                    RetItem[rowRetItem] = {
                        FUNCTION: 'INSERT',
                        "STKCODE": $('#txtStkCode' + rowno).val(),
                        "UOMCODE": $('#txtUOMCode' + rowno).val(),  
                        //"QTY": parseFloat($('#txtReturnQty' + rowno).val()), 
                        "QTY": $('#txtReturnQty' + rowno).val(),
                        "BATCHNO": $('#txtBatchNo' + rowno).val(),                   
                        "EXPIRYDATE": $('#txtExpiryDate' + rowno).val(),
                        "UNITCOST": $('#txtUnitCost' + rowno).val(),
                        "REMARKS": '',
                        "STATUS": 'O',      
                        "RETDTLIDX": ''                 
                    };
                    rowRetItem = rowRetItem + 1;
                }
            });           
            var ItemToSend = JSON.stringify(RetItem);
            //alert(ItemToSend);
            $('#hidRetItems').load().val(ItemToSend).valid();

                    $.ajax({
                type: "POST",
                url: "${pageContext.request.contextPath}/Servlet_StockReturn?SFC=CREATE_STOCK_RETURN",
                data: {
                    ITEMS: $('#hidRetItems').val(),
                    COMPANY: $('#ddlComp').val(),
                    LOCATION: $('#ddlLoc').val(),
                    RECVLOCATION: $('#ddlRecvLoc').val(),
                    PERSONNAME: $('#txtPersonName').val(),
                    REMARKS: $('#txtRemarks').val(),
                    RETHDRIDX: "0",
                    STATUS: 'O',
                    FUNCTION: 'INSERT'
                },
                        dataType: 'json',
                        beforeSend: function () {
                            $.showLoadingNoStatus();
                        },
                        success: function(data) {
                            var arrReturn = data;                  
                            if (arrReturn.bool === true) {
                    $.bigBoxSuccess({
                        title: "Stock Return Successful.",
                        content: "Stock Return Updated Successfully.",
                        timeout: 6000
                    });
                } else {
                    $.bigBoxFail({
                        title: "Stock Return FAIL.",
                        content: "There is some error during Stock Return creation.<br> Please try again...",
                        timeout: 6000
                    });
                }
                         },
                         error: function (xhr, status, error) {
                             $.bigBoxFail({
                                 title: "ERROR : FAILED To Add Stock Return!!",
                                 content: "There is some error occur during create process. Please try again later",
                                 timeout: 6000
                             });
                        },
                        complete: function (xhr, status) {
                            if (xhr.status === 200) {
                                $.hideLoadingNoStatus(function () {
                                    window.location.href = "#/StockReturnList";
                                }, 500);
                            } else {
                                $.hideLoadingNoStatus(function () {
                                }, 0);
                            }
                        } 
                    });        
                    hideYesNo();
                }
            },
            No: {
                text: "No",
                opt: function () {
                    document.getElementById("btnConfirm").disabled = false;
                    hideYesNo();
                }
            }
            });
        }
    });
       
</script>
