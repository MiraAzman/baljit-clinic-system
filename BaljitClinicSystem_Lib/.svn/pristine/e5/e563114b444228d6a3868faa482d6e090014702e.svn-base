CREATE DEFINER=`root`@`localhost` PROCEDURE `SP_TRX_REFUND`(
IN sMethod		varchar(30),
IN sRFH_Company 	varchar(100),
IN sRFH_Branch 		varchar(100),
IN sRFH_IDX 		int(11),
IN sRFH_NO 		varchar(12),
IN sRFH_STATUS 		varchar(10),
IN sRFH_REFUNDNO 	varchar(12),
IN sRFH_CASHAMT 	decimal(15,3),
IN sRFH_CHEQUEAMT 	decimal(15,3),
IN sRFH_TOTALRFDAMT     decimal(15,3),
IN sRFH_REMARK 		varchar(50),
IN sRFH_PRNTIME 	int(11),
IN sRFH_DISPLAYNAME     varchar(100),
IN sRFH_DISPLAYNRICNO 	varchar(20),
IN sRFH_CHEQREF1 	varchar(20),
IN sRFH_CHEQREF2 	varchar(20),
IN sRFH_RFDDATE 	varchar(30),
IN sRFH_WORKSTATION     varchar(20),
IN sRFH_ACCNO 	        varchar(10),
IN sRFH_BILDEPTID 	varchar(10),
IN sRFH_PRINTNO 	int(11),
IN sRFH_BILLNO 	        varchar(20),
IN sRFH_SHIFTCLOSEDAT 	varchar(30),
IN sRFH_CARDAMT 	decimal(15,3),
IN sRFH_CARDREF1 	varchar(20),
IN sRFH_CARDREF2 	varchar(20),
IN sRFH_PAIDAMT 	decimal(15,3),
IN sRFH_CHGAMT 		decimal(15,3),
IN sRFH_CARDTYPE 	varchar(6),
IN sRFH_JNACCGEN 	varchar(1),

IN sRFD_RDIDX 	        int(11),
IN sRFD_RDNO 	        varchar(12),
IN sRFD_RDTYPE 	        varchar(12),
IN sRFD_RDREFNO 	varchar(10),
IN sRFD_RDREFIDX 	int(11),
IN sRFD_RDRFDAMT 	decimal(15,3),
IN sRFD_RDSTATUS 	varchar(20),
IN sRFD_RDISCANCEL	varchar(1),

IN sBy                  varchar(10),
OUT Result 		varchar(30),
OUT Message 		varchar(30)
)
BEGIN

SET sRFH_RFDDATE  = STR_TO_DATE(REPLACE(sRFH_RFDDATE,"'",''), '%Y-%m-%d %H:%i:%s');
SET sRFH_SHIFTCLOSEDAT  = STR_TO_DATE(REPLACE(sRFH_SHIFTCLOSEDAT,"'",''), '%Y-%m-%d %H:%i:%s');


IF sMethod = 'ADD_REFUNDHEADER' THEN
  IF (SELECT COUNT(RFH_IDX) FROM his_refundheader WHERE RFH_IDX=sRFH_IDX AND RFH_Company=sRFH_Company AND RFH_Branch=sRFH_Branch) = 0 THEN
	INSERT INTO his_refundheader
    (RFH_COMPANY, RFH_BRANCH, RFH_IDX, RFH_NO, RFH_STATUS, RFH_REFUNDNO, RFH_CASHAMT, RFH_CHEQUEAMT,
    RFH_TOTALRFDAMT, RFH_REMARK, RFH_PRNTIME, RFH_DISPLAYNAME, RFH_DISPLAYNRICNO,
    createby, createdate, modifyby, modifydate, RFH_CHEQREF1, RFH_CHEQREF2, RFH_RFDDATE, RFH_WORKSTATION,
    RFH_ACCNO, RFH_BILDEPTID, RFH_PRINTNO, RFH_BILLNO, RFH_SHIFTCLOSEDAT, RFH_CARDAMT, RFH_CARDREF1,
    RFH_CARDREF2, RFH_PAIDAMT, RFH_CHGAMT, RFH_CARDTYPE, RFH_JNACCGEN)
    VALUES
    (sRFH_Company, sRFH_Branch, sRFH_IDX, sRFH_NO, sRFH_STATUS, sRFH_REFUNDNO, sRFH_CASHAMT, sRFH_CHEQUEAMT,
    sRFH_TOTALRFDAMT, sRFH_REMARK, sRFH_PRNTIME, sRFH_DISPLAYNAME, sRFH_DISPLAYNRICNO,
    sBy, NOW(), sBy, NOW(), sRFH_CHEQREF1, sRFH_CHEQREF2, sRFH_RFDDATE, sRFH_WORKSTATION,
    sRFH_ACCNO, sRFH_BILDEPTID, sRFH_PRINTNO, sRFH_BILLNO, sRFH_SHIFTCLOSEDAT, sRFH_CARDAMT, sRFH_CARDREF1,
    sRFH_CARDREF2, sRFH_PAIDAMT, sRFH_CHGAMT, sRFH_CARDTYPE, sRFH_JNACCGEN);
  ELSE
	UPDATE his_refundheader
    SET RFH_NO = sRFH_NO, RFH_STATUS = sRFH_STATUS, RFH_REFUNDNO = sRFH_REFUNDNO, RFH_CASHAMT = sRFH_CASHAMT, RFH_CHEQUEAMT = sRFH_CHEQUEAMT,
    RFH_TOTALRFDAMT = sRFH_TOTALRFDAMT, RFH_REMARK = sRFH_REMARK, RFH_PRNTIME = sRFH_PRNTIME, RFH_DISPLAYNAME = sRFH_DISPLAYNAME, RFH_DISPLAYNRICNO = sRFH_DISPLAYNRICNO,
    modifyby = sBy, modifydate = NOW(), RFH_CHEQREF1 = sRFH_CHEQREF1, RFH_CHEQREF2 = sRFH_CHEQREF2, RFH_RFDDATE = sRFH_RFDDATE, RFH_WORKSTATION = sRFH_WORKSTATION,
    RFH_ACCNO = sRFH_ACCNO, RFH_BILDEPTID = sRFH_BILDEPTID, RFH_PRINTNO = sRFH_PRINTNO, RFH_BILLNO = sRFH_BILLNO,  RFH_SHIFTCLOSEDAT = sRFH_SHIFTCLOSEDAT,
    RFH_CARDAMT = sRFH_CARDAMT, RFH_CARDREF1 = sRFH_CARDREF1,
    RFH_CARDREF2 = sRFH_CARDREF2, RFH_PAIDAMT = sRFH_PAIDAMT,
    RFH_CHGAMT = sRFH_CHGAMT,  RFH_CARDTYPE = sRFH_CARDTYPE, RFH_JNACCGEN = sRFH_JNACCGEN
    WHERE RFH_IDX=sRFH_IDX AND RFH_COMPANY=sRFH_Company AND RFH_BRANCH=sRFH_Branch;
  END IF;

	SELECT '00000' INTO Result;
	SELECT  'Success Inserted' INTO Message;
END IF;


IF sMethod = 'ADD_REFUNDDETAILS' THEN
  IF (SELECT COUNT(RFD_RDIDX) FROM his_refunddetails WHERE RFD_RDIDX=sRFD_RDIDX AND RFD_Branch=sRFH_Branch AND RFD_Company=sRFH_Company) = 0 THEN
	INSERT INTO his_refunddetails
    (RFD_RDIDX, RFD_COMPANY, RFD_BRANCH, RFD_RDHDRIDX, RFD_RDNO, RFD_RDTYPE, RFD_RDREFNO, RFD_RDREFIDX, RFD_RDRFDAMT,
    createby, createdate, modifyby, modifydate, RFD_RDSTATUS, RFD_RDRFDDATE, RFD_RDISCANCEL)
    VALUES
    (sRFD_RDIDX, sRFH_Company, sRFH_Branch, sRFH_IDX, sRFD_RDNO, sRFD_RDTYPE, sRFD_RDREFNO, sRFD_RDREFIDX, sRFD_RDRFDAMT,
    sBy, NOW(), sBY, NOW(), sRFD_RDSTATUS, sRFH_RFDDATE, sRFD_RDISCANCEL);
  ELSE
	UPDATE his_refunddetails
    SET RFD_RDHDRIDX=sRFH_IDX, RFD_RDNO=sRFD_RDNO, RFD_RDTYPE=sRFD_RDTYPE, RFD_RDREFNO=sRFD_RDREFNO, RFD_RDREFIDX=sRFD_RDREFIDX,
    RFD_RDRFDAMT=sRFD_RDRFDAMT, modifyby=sBy, modifydate=NOW(), RFD_RDSTATUS=sRFD_RDSTATUS, RFD_RDRFDDATE=sRFH_RFDDATE,
    RFD_RDISCANCEL=sRFD_RDISCANCEL
    WHERE RFD_RDIDX=sRFD_RDIDX AND RFD_Branch=sRFH_Branch AND RFD_Company=sRFH_Company;
  END IF;

	SELECT '00000' INTO Result;
	SELECT  'Success Inserted' INTO Message;
END IF;
END